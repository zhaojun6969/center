import{_ as e,d as a,a as t,g as r,W as l}from"./index-DlA8SRM3.js";/* empty css                 */import{al as n,z as s,A as o,B as d,R as i,P as u,J as c,O as p,I as v,L as m,E as g,ax as f,r as y,c as h,f as _,j as C,U as w,aA as D,u as E,Q as S,a5 as O}from"./vendor-p2oL7ibe.js";import{S as b,T as I,c as M,H as k,U as x,V as N,u as P,f as L,W as A,X as R,Y as T,Z as z,_ as V,$ as j,E as B,x as H,B as U,l as F,b as G,a as W,a0 as $,Q as q,a1 as J,d as Q}from"./elementPlus-BlcbFMqO.js";import{g as X,s as Y,a as Z,O as K}from"./OrderManagement-KCJvz3DG.js";const ee={class:"order-card__header"},ae={class:"order-card__id"},te={class:"order-number"},re={class:"order-card__content"},le={class:"order-info"},ne={class:"customer-section"},se={class:"order-date"},oe={class:"products-section"},de={class:"products-title"},ie={class:"products-list"},ue={class:"product-item"},ce=["src","alt"],pe={class:"product-details"},ve={class:"product-name"},me={class:"product-quantity"},ge={class:"product-price"},fe={class:"order-card__actions"},ye={class:"action-buttons"};const he=e({name:"OrderCard",components:{Clock:V,Check:z,Van:T,CircleCheck:R,Warning:A,ArrowDown:L,User:P,Calendar:N,CreditCard:x,View:k,Close:M,Download:I,ChatLineSquare:b},props:{order:{type:Object,required:!0}},emits:["view-details","pay-order","cancel-order","confirm-order","expired-order"],setup(e,{emit:a}){const{t:t}=f(),r=y(!1),l=y(!1),n=y(!1),s=y(!1),o=y(!1),d=y("");let i=null;const u=y(null),c=y(360),p=()=>{u.value&&(c.value=u.value.offsetWidth)},v=()=>{p()},m=h(()=>X(e.order)),g=h(()=>{const a=[];return"completed"===e.order.status&&a.push({key:"download-invoice",label:t("orderManagement.actions.downloadInvoice"),icon:I}),"shipped"!==e.order.status&&"completed"!==e.order.status||a.push({key:"view-tracking",label:t("orderManagement.actions.viewTracking"),icon:T}),"paid"!==e.order.status&&"completed"!==e.order.status||a.push({key:"contact-seller",label:t("orderManagement.actions.contactSeller"),icon:b}),a}),D=()=>{const t=e.order.expiresAt?new Date(e.order.expiresAt).getTime():null;if(!t)return o.value=!1,void(d.value="");const r=Date.now(),l=Math.max(0,t-r);if(l<=0)return o.value=!0,d.value="00:00",i&&(clearInterval(i),i=null),void a("expired-order",e.order.id);const n=Math.floor(l/6e4),s=Math.floor(l%6e4/1e3);d.value=`${String(n).padStart(2,"0")}:${String(s).padStart(2,"0")}`},E=()=>{D(),i&&clearInterval(i),i=setInterval(D,1e3)},S=()=>{i&&(clearInterval(i),i=null)};return _(()=>{"pending"===e.order.status&&E(),p(),window.addEventListener("resize",v,{passive:!0})}),C(()=>e.order.expiresAt,()=>{"pending"===e.order.status?E():S()}),C(()=>e.order.status,e=>{"pending"===e?E():S()}),w(()=>{S(),window.removeEventListener("resize",v)}),{isExpanded:r,isPaying:l,isCancelling:n,isConfirming:s,isExpired:o,countdownText:d,statusType:m,moreActions:g,toggleExpand:()=>{r.value=!r.value,p()},formatDate:e=>{if(!e)return"-";const a=new Date(e);return a.toLocaleDateString()+" "+a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},handleImageError:e=>{e.target.src="/default-product.png"},viewDetails:()=>{a("view-details",e.order)},handlePay:async()=>{l.value=!0;try{a("pay-order",e.order)}finally{l.value=!1}},handleCancel:async()=>{n.value=!0;try{a("cancel-order",e.order)}finally{n.value=!1}},handleConfirm:async()=>{s.value=!0;try{a("confirm-order",e.order.id)}finally{s.value=!1}},handleMoreAction:e=>{e},getPaymentMethodLabel:e=>({stripe:"Stripe",alipay:"支付宝",wechat:"微信支付",card:"信用卡",bank:"银行转账"}[e]||e||"-"),getPaymentStatusLabel:e=>({pending:t("orderManagement.payment.pending"),paid:t("orderManagement.payment.paid"),failed:t("orderManagement.payment.failed"),refunded:t("orderManagement.payment.refunded")}[e]||e||"-"),t:t,cardRef:u,cardWidth:c}}},[["render",function(e,a,t,r,l,f){const y=j,h=n("View"),_=B,C=H,w=n("CreditCard"),D=n("Close"),E=n("Check");return o(),s("div",{class:g(["order-card",`order-card--${t.order.status}`,{"order-card--expanded":r.isExpanded}]),ref:"cardRef"},[d("div",ee,[d("div",ae,[d("span",te,"#"+u(t.order.order_no),1)]),i(y,{type:r.statusType.status,size:"small"},{default:c(()=>[p(u(r.t(r.statusType.label)),1)]),_:1},8,["type"])]),d("div",re,[d("div",le,[d("div",ne,[d("div",se,[d("span",null,u(r.formatDate(t.order.created_at)),1)])]),d("div",oe,[d("h4",de,u(r.t("orderManagement.order.products")),1),d("div",ie,[d("div",ue,[d("img",{src:t.order?.order_info?.modelData?.imageUrl,alt:t.order?.order_info?.ipName,class:"product-image",onError:a[0]||(a[0]=(...e)=>r.handleImageError&&r.handleImageError(...e))},null,40,ce),d("div",pe,[d("span",ve,u(t.order.order_info.ipName||"rob"),1),d("span",me,"x"+u(t.order.order_info.quantity),1)]),d("div",ge,u(t.order.currency)+" "+u(Number(t.order.actual_amount).toFixed(2)),1)])])])])]),d("div",fe,[d("div",ye,[i(C,{size:"small",onClick:r.viewDetails},{default:c(()=>[i(_,null,{default:c(()=>[i(h),a[1]||(a[1]=p(" ",-1))]),_:1}),p(" "+u(r.t("orderManagement.actions.view")),1)]),_:1},8,["onClick"]),"dzf"===r.statusType.type?(o(),v(C,{key:0,type:"primary",size:"small",onClick:r.handlePay,loading:r.isPaying,disabled:r.isExpired},{default:c(()=>[i(_,null,{default:c(()=>[i(w),a[2]||(a[2]=p(" ",-1))]),_:1}),p(" "+u(r.t("orderManagement.actions.pay")),1)]),_:1},8,["onClick","loading","disabled"])):m("",!0),"dzf"===r.statusType.type?(o(),v(C,{key:1,type:"danger",size:"small",onClick:r.handleCancel,loading:r.isCancelling},{default:c(()=>[i(_,null,{default:c(()=>[i(D),a[3]||(a[3]=p(" ",-1))]),_:1}),p(" "+u(r.t("orderManagement.actions.cancel")),1)]),_:1},8,["onClick","loading"])):m("",!0),"yfh"===r.statusType.type?(o(),v(C,{key:2,type:"success",size:"small",onClick:r.handleConfirm,loading:r.isConfirming},{default:c(()=>[i(_,null,{default:c(()=>[i(E)]),_:1}),p(" "+u(r.t("orderManagement.actions.confirm")),1)]),_:1},8,["onClick","loading"])):m("",!0)])])],2)}],["__scopeId","data-v-1b534b42"]]),_e={PENDING:"pending",PROCESSING:"processing",SHIPPED:"shipped",CANCELLED:"cancelled",REFUNDED:"refunded"},Ce={[_e.PENDING]:"待处理",[_e.PROCESSING]:"处理中",[_e.SHIPPED]:"已发货",[_e.DELIVERED]:"已送达",[_e.CANCELLED]:"已取消",[_e.REFUNDED]:"已退款"},we=a("orders",()=>{const e=y([]),a=y(null),t=y(!1),r=y(null),l=y({status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null}),n=y({currentPage:1,pageSize:10,total:0}),s=h(()=>{let a=[...e.value];if(l.value.status&&(a=a.filter(e=>e.status===l.value.status)),l.value.search){const e=l.value.search.toLowerCase();a=a.filter(a=>a.orderId?.toLowerCase().includes(e)||a.customerName?.toLowerCase().includes(e)||a.customerEmail?.toLowerCase().includes(e))}if(l.value.dateRange?.start&&l.value.dateRange?.end){const e=new Date(l.value.dateRange.start),t=new Date(l.value.dateRange.end);a=a.filter(a=>{const r=new Date(a.created_at);return r>=e&&r<=t})}return a.sort((e,a)=>{const{sortBy:t,sortOrder:r}=l.value;let n=e[t],s=a[t];return"created_at"!==t&&"updatedAt"!==t||(n=new Date(n).getTime(),s=new Date(s).getTime()),"string"==typeof n&&(n=n.toLowerCase(),s=s.toLowerCase()),"asc"===r?n>s?1:-1:n<s?1:-1}),a}),o=h(()=>{const{currentPage:e,pageSize:a}=n.value,t=(e-1)*a,r=t+a;return s.value.slice(t,r)}),d=h(()=>({total:e.value.length,pending:e.value.filter(e=>e.status===_e.PENDING).length,processing:e.value.filter(e=>e.status===_e.PROCESSING).length,shipped:e.value.filter(e=>e.status===_e.SHIPPED).length,delivered:e.value.filter(e=>e.status===_e.DELIVERED).length,cancelled:e.value.filter(e=>e.status===_e.CANCELLED).length,refunded:e.value.filter(e=>e.status===_e.REFUNDED).length,totalRevenue:e.value.filter(e=>e.status!==_e.CANCELLED).reduce((e,a)=>e+(a.total||0),0)})),i=h(()=>s.value.length),u=a=>{e.value=a.map(e=>({...e,created_at:e.created_at||(new Date).toISOString(),updatedAt:e.updatedAt||(new Date).toISOString()})),n.value.total=e.value.length},c=(a,t)=>{const r=e.value.findIndex(e=>e.id===a);return-1!==r&&(e.value[r]={...e.value[r],...t,updatedAt:(new Date).toISOString()}),e.value[r]},p=a=>e.value.find(e=>e.id===a);return{orders:e,currentOrder:a,loading:t,error:r,filters:l,pagination:n,filteredOrders:s,paginatedOrders:o,orderStats:d,totalOrders:i,setOrders:u,addOrder:a=>{const t={...a,id:Date.now().toString(),created_at:(new Date).toISOString(),updatedAt:(new Date).toISOString(),status:a.status||_e.PENDING};return e.value.unshift(t),n.value.total=e.value.length,t},updateOrder:c,deleteOrder:a=>{const t=e.value.findIndex(e=>e.id===a);return-1!==t&&(e.value.splice(t,1),n.value.total=e.value.length,!0)},getOrder:p,setCurrentOrder:e=>{a.value=e},updateOrderStatus:(a,t)=>c(a,{status:t,statusHistory:[...e.value.find(e=>e.id===a)?.statusHistory||[],{status:t,timestamp:(new Date).toISOString(),note:`状态更新为 ${Ce[t]}`}]}),updateFilters:e=>{l.value={...l.value,...e},n.value.currentPage=1},updatePagination:e=>{n.value={...n.value,...e}},resetFilters:()=>{l.value={status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null},n.value.currentPage=1},getStatusHistory:e=>{const a=p(e);return a?.statusHistory||[]},exportOrders:(e="json")=>{const a=s.value;if("csv"===e){return[["订单ID","客户姓名","客户邮箱","状态","总金额","创建时间","更新时间"].join(","),...a.map(e=>[e.orderId||"",e.customerName||"",e.customerEmail||"",Ce[e.status]||"",e.total||0,e.created_at,e.updatedAt].join(","))].join("\n")}return JSON.stringify(a,null,2)},initSampleData:()=>{u([])}}},{persist:{key:"orders",storage:localStorage,paths:["filters","pagination"]}}),De={class:"order-management"},Ee={class:"orders-section"},Se={class:"filter-section"},Oe={class:"filter-row"},be={class:"filter-group"},Ie={class:"filter-label"},Me={class:"status-filter"},ke=["onClick"],xe={class:"filter-group"},Ne={class:"filter-label"},Pe={class:"filter-group"},Le={class:"filter-label"},Ae={class:"orders-grid"},Re={key:0,class:"empty-state"},Te={class:"empty-icon"},ze={class:"empty-title"},Ve={class:"empty-description"},je=e({__name:"OrderManagement",setup(e){const a=new K,{t:n}=f(),p=D(),h=we(),w=y("all"),b=Y("1"),I=y([{label:n("orderManagement.sort.created_at"),value:"created_at"},{label:n("orderManagement.sort.total"),value:"amount"}]),M=e=>{p.push({name:"order-detail",params:{orderId:e.id}})},k=e=>{if(t()){if(!e.order_info.pay_params)return void Q.error("当前订单不属于小程序订单");const a=r();return void l.BusWechartForNavigate("/pages/pay/pay",{method:"pay",payData:JSON.stringify({...e.order_info,token:a,amount:e.order_info.amount,order_no:e.order_no})})}window.location.href=e.stripe_url},x=e=>{J.confirm(n("orderManagement.confirm.message"),n("orderManagement.confirm.title"),{confirmButtonText:n("common.confirm"),cancelButtonText:n("common.cancel"),type:"warning"}).then(()=>{a.receiveAddress(e).then(e=>{re()})})},N=e=>{J.confirm(n("orderManagement.cancelConfirm.message"),n("orderManagement.cancelConfirm.title"),{confirmButtonText:n("common.confirm"),cancelButtonText:n("common.cancel"),type:"warning"}).then(()=>{a.orderCancel({id:e.id}).then(e=>{0===e.code?(Q.success(n("orderManagement.cancelSuccess")),re()):Q.error(e.message||n("orderManagement.cancelFail"))})}).catch(()=>{})},P=e=>{h.updateOrder(e,{status:"expired"})},L=y(1),A=y(10),R=y(""),T=y(!1),z=y(!1),V=y("created_at"),j=y("desc"),H=y([]),X=y(0),ee=y({}),ae=()=>{te()},te=()=>{T.value||z.value||(T.value=!0,a.getOrderList({page:L.value,page_size:A.value,order_no:R.value,sort_by:V.value,sort_order:j.value,...ee.value}).then(e=>{if(0==e.code){let a=e.data;1===L.value?H.value=a.items:H.value=[...H.value,...a.items],X.value=a.total,z.value=H.value.length>=X.value,L.value++}}))},re=()=>{T.value=!1,z.value=!1,H.value=[],L.value=1,A.value=10,te()};C(R,()=>{clearTimeout(window._orderNoDebounce),window._orderNoDebounce=setTimeout(()=>{re()},300)}),_(()=>{re()});return C(V,()=>{re()}),(e,a)=>{const t=B,r=U,l=W,p=G,f=q;return o(),v(f,{height:"100%",onEndReached:ae},{default:c(()=>[d("div",De,[d("div",Ee,[d("div",Se,[d("div",Oe,[d("div",be,[d("label",Ie,u(E(n)("orderManagement.filters.status")),1),d("div",Me,[(o(!0),s(S,null,O(E(b),e=>(o(),s("button",{key:e.key,class:g(["status-tab",{active:w.value===e.key}]),onClick:a=>(e=>{const a=Z(e);ee.value=a,w.value=e,re()})(e.key)},u(E(n)(e.label)),11,ke))),128))])]),d("div",xe,[d("label",Ne,u(E(n)("orderManagement.filters.search")),1),i(r,{modelValue:R.value,"onUpdate:modelValue":a[0]||(a[0]=e=>R.value=e),placeholder:E(n)("orderManagement.searchPlaceholder"),class:"search-input",clearable:""},{prefix:c(()=>[i(t,null,{default:c(()=>[i(E(F))]),_:1})]),_:1},8,["modelValue","placeholder"])]),d("div",Pe,[d("label",Le,u(E(n)("orderManagement.filters.sort")),1),i(p,{modelValue:V.value,"onUpdate:modelValue":a[1]||(a[1]=e=>V.value=e),class:"sort-select"},{default:c(()=>[(o(!0),s(S,null,O(I.value,e=>(o(),v(l,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),d("div",Ae,[(o(!0),s(S,null,O(H.value,e=>(o(),v(he,{key:e.id,order:e,onViewDetails:M,onPayOrder:k,onCancelOrder:N,onExpiredOrder:P,onConfirmOrder:x},null,8,["order"]))),128))]),0===H.value.length?(o(),s("div",Re,[d("div",Te,[i(t,null,{default:c(()=>[i(E($))]),_:1})]),d("h3",ze,u(E(n)("orderManagement.empty.title")),1),d("p",Ve,u(E(n)("orderManagement.empty.description")),1)])):m("",!0)])])]),_:1})}}},[["__scopeId","data-v-5ea21e0b"]]);export{je as default};
