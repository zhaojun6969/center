import{_ as e,d as a,a as t,W as r}from"./index-BXg9AdUO.js";/* empty css               *//* empty css                  *//* empty css                 */import{al as l,z as n,A as s,B as o,R as d,P as i,J as u,O as c,I as p,L as v,E as m,az as g,r as f,c as y,f as h,j as _,U as w,aA as C,u as D,Q as E,a5 as S}from"./vendor-Bn3bPSOS.js";import{Q as O,R as I,i as b,F as k,S as M,T as N,u as P,b as x,U as L,V as R,W as A,X as T,Y as z,Z as j,E as V,t as B,z as F,h as U,_ as H,$ as G,a0 as W,O as $,a1 as q,w as J}from"./elementPlus-DTQfcfg-.js";import{g as Q,s as K,a as X,O as Y}from"./OrderManagement-NOnrRSyj.js";const Z={class:"order-card__header"},ee={class:"order-card__id"},ae={class:"order-number"},te={class:"order-card__content"},re={class:"order-info"},le={class:"customer-section"},ne={class:"order-date"},se={class:"products-section"},oe={class:"products-title"},de={class:"products-list"},ie={class:"product-item"},ue=["src","alt"],ce={class:"product-details"},pe={class:"product-name"},ve={class:"product-quantity"},me={class:"product-price"},ge={class:"order-card__actions"},fe={class:"action-buttons"};const ye=e({name:"OrderCard",components:{Clock:z,Check:T,Van:A,CircleCheck:R,Warning:L,ArrowDown:x,User:P,Calendar:N,CreditCard:M,View:k,Close:b,Download:I,ChatLineSquare:O},props:{order:{type:Object,required:!0}},emits:["view-details","pay-order","cancel-order","confirm-order","expired-order"],setup(e,{emit:a}){const{t:t}=g(),r=f(!1),l=f(!1),n=f(!1),s=f(!1),o=f(!1),d=f("");let i=null;const u=f(null),c=f(360),p=()=>{u.value&&(c.value=u.value.offsetWidth)},v=()=>{p()},m=y(()=>Q(e.order)),C=y(()=>{const a=[];return"completed"===e.order.status&&a.push({key:"download-invoice",label:t("orderManagement.actions.downloadInvoice"),icon:I}),"shipped"!==e.order.status&&"completed"!==e.order.status||a.push({key:"view-tracking",label:t("orderManagement.actions.viewTracking"),icon:A}),"paid"!==e.order.status&&"completed"!==e.order.status||a.push({key:"contact-seller",label:t("orderManagement.actions.contactSeller"),icon:O}),a}),D=()=>{const t=e.order.expiresAt?new Date(e.order.expiresAt).getTime():null;if(!t)return o.value=!1,void(d.value="");const r=Date.now(),l=Math.max(0,t-r);if(l<=0)return o.value=!0,d.value="00:00",i&&(clearInterval(i),i=null),void a("expired-order",e.order.id);const n=Math.floor(l/6e4),s=Math.floor(l%6e4/1e3);d.value=`${String(n).padStart(2,"0")}:${String(s).padStart(2,"0")}`},E=()=>{D(),i&&clearInterval(i),i=setInterval(D,1e3)},S=()=>{i&&(clearInterval(i),i=null)};return h(()=>{"pending"===e.order.status&&E(),p(),window.addEventListener("resize",v,{passive:!0})}),_(()=>e.order.expiresAt,()=>{"pending"===e.order.status?E():S()}),_(()=>e.order.status,e=>{"pending"===e?E():S()}),w(()=>{S(),window.removeEventListener("resize",v)}),{isExpanded:r,isPaying:l,isCancelling:n,isConfirming:s,isExpired:o,countdownText:d,statusType:m,moreActions:C,toggleExpand:()=>{r.value=!r.value,p()},formatDate:e=>{if(!e)return"-";const a=new Date(e);return a.toLocaleDateString()+" "+a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},handleImageError:e=>{e.target.src="/default-product.png"},viewDetails:()=>{a("view-details",e.order)},handlePay:async()=>{l.value=!0;try{a("pay-order",e.order)}finally{l.value=!1}},handleCancel:async()=>{n.value=!0;try{a("cancel-order",e.order)}finally{n.value=!1}},handleConfirm:async()=>{s.value=!0;try{a("confirm-order",e.order.id)}finally{s.value=!1}},handleMoreAction:e=>{e},getPaymentMethodLabel:e=>({stripe:"Stripe",alipay:"支付宝",wechat:"微信支付",card:"信用卡",bank:"银行转账"}[e]||e||"-"),getPaymentStatusLabel:e=>({pending:t("orderManagement.payment.pending"),paid:t("orderManagement.payment.paid"),failed:t("orderManagement.payment.failed"),refunded:t("orderManagement.payment.refunded")}[e]||e||"-"),t:t,cardRef:u,cardWidth:c}}},[["render",function(e,a,t,r,g,f){const y=j,h=l("View"),_=V,w=B,C=l("CreditCard"),D=l("Close"),E=l("Check");return s(),n("div",{class:m(["order-card",`order-card--${t.order.status}`,{"order-card--expanded":r.isExpanded}]),ref:"cardRef"},[o("div",Z,[o("div",ee,[o("span",ae,"#"+i(t.order.order_no),1)]),d(y,{type:r.statusType.status,size:"small"},{default:u(()=>[c(i(r.t(r.statusType.label)),1)]),_:1},8,["type"])]),o("div",te,[o("div",re,[o("div",le,[o("div",ne,[o("span",null,i(r.formatDate(t.order.created_at)),1)])]),o("div",se,[o("h4",oe,i(r.t("orderManagement.order.products")),1),o("div",de,[o("div",ie,[o("img",{src:t.order?.order_info?.modelData?.imageUrl,alt:t.order?.order_info?.ipName,class:"product-image",onError:a[0]||(a[0]=(...e)=>r.handleImageError&&r.handleImageError(...e))},null,40,ue),o("div",ce,[o("span",pe,i(t.order.order_info.ipName||"rob"),1),o("span",ve,"x"+i(t.order.order_info.quantity),1)]),o("div",me,i(t.order.currency)+" "+i(Number(t.order.actual_amount).toFixed(2)),1)])])])])]),o("div",ge,[o("div",fe,[d(w,{size:"small",onClick:r.viewDetails},{default:u(()=>[d(_,null,{default:u(()=>[d(h),a[1]||(a[1]=c(" ",-1))]),_:1}),c(" "+i(r.t("orderManagement.actions.view")),1)]),_:1},8,["onClick"]),"dzf"===r.statusType.type?(s(),p(w,{key:0,type:"primary",size:"small",onClick:r.handlePay,loading:r.isPaying,disabled:r.isExpired},{default:u(()=>[d(_,null,{default:u(()=>[d(C),a[2]||(a[2]=c(" ",-1))]),_:1}),c(" "+i(r.t("orderManagement.actions.pay")),1)]),_:1},8,["onClick","loading","disabled"])):v("",!0),"dzf"===r.statusType.type?(s(),p(w,{key:1,type:"danger",size:"small",onClick:r.handleCancel,loading:r.isCancelling},{default:u(()=>[d(_,null,{default:u(()=>[d(D),a[3]||(a[3]=c(" ",-1))]),_:1}),c(" "+i(r.t("orderManagement.actions.cancel")),1)]),_:1},8,["onClick","loading"])):v("",!0),"yfh"===r.statusType.type?(s(),p(w,{key:2,type:"success",size:"small",onClick:r.handleConfirm,loading:r.isConfirming},{default:u(()=>[d(_,null,{default:u(()=>[d(E)]),_:1}),c(" "+i(r.t("orderManagement.actions.confirm")),1)]),_:1},8,["onClick","loading"])):v("",!0)])])],2)}],["__scopeId","data-v-1b534b42"]]),he={PENDING:"pending",PROCESSING:"processing",SHIPPED:"shipped",CANCELLED:"cancelled",REFUNDED:"refunded"},_e={[he.PENDING]:"待处理",[he.PROCESSING]:"处理中",[he.SHIPPED]:"已发货",[he.DELIVERED]:"已送达",[he.CANCELLED]:"已取消",[he.REFUNDED]:"已退款"},we=a("orders",()=>{const e=f([]),a=f(null),t=f(!1),r=f(null),l=f({status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null}),n=f({currentPage:1,pageSize:10,total:0}),s=y(()=>{let a=[...e.value];if(l.value.status&&(a=a.filter(e=>e.status===l.value.status)),l.value.search){const e=l.value.search.toLowerCase();a=a.filter(a=>a.orderId?.toLowerCase().includes(e)||a.customerName?.toLowerCase().includes(e)||a.customerEmail?.toLowerCase().includes(e))}if(l.value.dateRange?.start&&l.value.dateRange?.end){const e=new Date(l.value.dateRange.start),t=new Date(l.value.dateRange.end);a=a.filter(a=>{const r=new Date(a.created_at);return r>=e&&r<=t})}return a.sort((e,a)=>{const{sortBy:t,sortOrder:r}=l.value;let n=e[t],s=a[t];return"created_at"!==t&&"updatedAt"!==t||(n=new Date(n).getTime(),s=new Date(s).getTime()),"string"==typeof n&&(n=n.toLowerCase(),s=s.toLowerCase()),"asc"===r?n>s?1:-1:n<s?1:-1}),a}),o=y(()=>{const{currentPage:e,pageSize:a}=n.value,t=(e-1)*a,r=t+a;return s.value.slice(t,r)}),d=y(()=>({total:e.value.length,pending:e.value.filter(e=>e.status===he.PENDING).length,processing:e.value.filter(e=>e.status===he.PROCESSING).length,shipped:e.value.filter(e=>e.status===he.SHIPPED).length,delivered:e.value.filter(e=>e.status===he.DELIVERED).length,cancelled:e.value.filter(e=>e.status===he.CANCELLED).length,refunded:e.value.filter(e=>e.status===he.REFUNDED).length,totalRevenue:e.value.filter(e=>e.status!==he.CANCELLED).reduce((e,a)=>e+(a.total||0),0)})),i=y(()=>s.value.length),u=a=>{e.value=a.map(e=>({...e,created_at:e.created_at||(new Date).toISOString(),updatedAt:e.updatedAt||(new Date).toISOString()})),n.value.total=e.value.length},c=(a,t)=>{const r=e.value.findIndex(e=>e.id===a);return-1!==r&&(e.value[r]={...e.value[r],...t,updatedAt:(new Date).toISOString()}),e.value[r]},p=a=>e.value.find(e=>e.id===a);return{orders:e,currentOrder:a,loading:t,error:r,filters:l,pagination:n,filteredOrders:s,paginatedOrders:o,orderStats:d,totalOrders:i,setOrders:u,addOrder:a=>{const t={...a,id:Date.now().toString(),created_at:(new Date).toISOString(),updatedAt:(new Date).toISOString(),status:a.status||he.PENDING};return e.value.unshift(t),n.value.total=e.value.length,t},updateOrder:c,deleteOrder:a=>{const t=e.value.findIndex(e=>e.id===a);return-1!==t&&(e.value.splice(t,1),n.value.total=e.value.length,!0)},getOrder:p,setCurrentOrder:e=>{a.value=e},updateOrderStatus:(a,t)=>c(a,{status:t,statusHistory:[...e.value.find(e=>e.id===a)?.statusHistory||[],{status:t,timestamp:(new Date).toISOString(),note:`状态更新为 ${_e[t]}`}]}),updateFilters:e=>{l.value={...l.value,...e},n.value.currentPage=1},updatePagination:e=>{n.value={...n.value,...e}},resetFilters:()=>{l.value={status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null},n.value.currentPage=1},getStatusHistory:e=>{const a=p(e);return a?.statusHistory||[]},exportOrders:(e="json")=>{const a=s.value;if("csv"===e){return[["订单ID","客户姓名","客户邮箱","状态","总金额","创建时间","更新时间"].join(","),...a.map(e=>[e.orderId||"",e.customerName||"",e.customerEmail||"",_e[e.status]||"",e.total||0,e.created_at,e.updatedAt].join(","))].join("\n")}return JSON.stringify(a,null,2)},initSampleData:()=>{u([])}}},{persist:{key:"orders",storage:localStorage,paths:["filters","pagination"]}}),Ce={class:"order-management"},De={class:"orders-section"},Ee={class:"filter-section"},Se={class:"filter-row"},Oe={class:"filter-group"},Ie={class:"filter-label"},be={class:"status-filter"},ke=["onClick"],Me={class:"filter-group"},Ne={class:"filter-label"},Pe={class:"filter-group"},xe={class:"filter-label"},Le={class:"orders-grid"},Re={key:0,class:"empty-state"},Ae={class:"empty-icon"},Te={class:"empty-title"},ze={class:"empty-description"},je=e({__name:"OrderManagement",setup(e){const a=new Y,{t:l}=g(),c=C(),y=we(),w=f("all"),O=K("1"),I=f([{label:l("orderManagement.sort.created_at"),value:"created_at"},{label:l("orderManagement.sort.total"),value:"amount"}]),b=e=>{c.push({name:"order-detail",params:{orderId:e.id}})},k=e=>{if(t()){if(!e.order_info.pay_params)return void J.error("当前订单不属于小程序订单");const a=window.localStorage.getItem("token");return void r.BusWechartForNavigate("/pages/pay/pay",{method:"pay",payData:JSON.stringify({...e.order_info,token:a,amount:e.order_info.amount,order_no:e.order_no})})}window.location.href=e.stripe_url},M=e=>{q.confirm(l("orderManagement.confirm.message"),l("orderManagement.confirm.title"),{confirmButtonText:l("common.confirm"),cancelButtonText:l("common.cancel"),type:"warning"}).then(()=>{a.receiveAddress(e).then(e=>{te()})})},N=e=>{q.confirm(l("orderManagement.cancelConfirm.message"),l("orderManagement.cancelConfirm.title"),{confirmButtonText:l("common.confirm"),cancelButtonText:l("common.cancel"),type:"warning"}).then(()=>{a.orderCancel({id:e.id}).then(e=>{0===e.code?(J.success(l("orderManagement.cancelSuccess")),te()):J.error(e.message||l("orderManagement.cancelFail"))})}).catch(()=>{})},P=e=>{y.updateOrder(e,{status:"expired"})},x=f(1),L=f(10),R=f(""),A=f(!1),T=f(!1),z=f("created_at"),j=f("desc"),B=f([]),Q=f(0),Z=f({}),ee=()=>{ae()},ae=()=>{A.value||T.value||(A.value=!0,a.getOrderList({page:x.value,page_size:L.value,order_no:R.value,sort_by:z.value,sort_order:j.value,...Z.value}).then(e=>{if(0==e.code){let a=e.data;1===x.value?B.value=a.items:B.value=[...B.value,...a.items],Q.value=a.total,T.value=B.value.length>=Q.value,x.value++}}))},te=()=>{A.value=!1,T.value=!1,B.value=[],x.value=1,L.value=10,ae()};_(R,()=>{clearTimeout(window._orderNoDebounce),window._orderNoDebounce=setTimeout(()=>{te()},300)}),h(()=>{te()});return _(z,()=>{te()}),(e,a)=>{const t=V,r=F,c=G,g=H,f=$;return s(),p(f,{height:"100%",onEndReached:ee},{default:u(()=>[o("div",Ce,[o("div",De,[o("div",Ee,[o("div",Se,[o("div",Oe,[o("label",Ie,i(D(l)("orderManagement.filters.status")),1),o("div",be,[(s(!0),n(E,null,S(D(O),e=>(s(),n("button",{key:e.key,class:m(["status-tab",{active:w.value===e.key}]),onClick:a=>(e=>{const a=X(e);Z.value=a,w.value=e,te()})(e.key)},i(D(l)(e.label)),11,ke))),128))])]),o("div",Me,[o("label",Ne,i(D(l)("orderManagement.filters.search")),1),d(r,{modelValue:R.value,"onUpdate:modelValue":a[0]||(a[0]=e=>R.value=e),placeholder:D(l)("orderManagement.searchPlaceholder"),class:"search-input",clearable:""},{prefix:u(()=>[d(t,null,{default:u(()=>[d(D(U))]),_:1})]),_:1},8,["modelValue","placeholder"])]),o("div",Pe,[o("label",xe,i(D(l)("orderManagement.filters.sort")),1),d(g,{modelValue:z.value,"onUpdate:modelValue":a[1]||(a[1]=e=>z.value=e),class:"sort-select"},{default:u(()=>[(s(!0),n(E,null,S(I.value,e=>(s(),p(c,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),o("div",Le,[(s(!0),n(E,null,S(B.value,e=>(s(),p(ye,{key:e.id,order:e,onViewDetails:b,onPayOrder:k,onCancelOrder:N,onExpiredOrder:P,onConfirmOrder:M},null,8,["order"]))),128))]),0===B.value.length?(s(),n("div",Re,[o("div",Ae,[d(t,null,{default:u(()=>[d(D(W))]),_:1})]),o("h3",Te,i(D(l)("orderManagement.empty.title")),1),o("p",ze,i(D(l)("orderManagement.empty.description")),1)])):v("",!0)])])]),_:1})}}},[["__scopeId","data-v-5c068ac7"]]);export{je as default};
