import{ax as e,r as t,j as a,f as n,aB as s,U as i,z as o,B as l,R as r,J as c,T as d,L as u,P as m,A as h}from"./vendor-p2oL7ibe.js";import{_ as v,k as f}from"./index-CqnzwUr8.js";import{S as w,C as g,P as p,W as y,B as x,c as k,d as C,e as b,f as M,n as z,i as P}from"./three.module-0ChKueQ8.js";import{h as A,c as T}from"./camera_utils-d8XAjUii.js";import{G as E}from"./index-BA7DGyF7.js";import"./elementPlus-DzXnjnIh.js";const $={class:"confession-card-container"},_={key:0,class:"wechat-mask"},L={class:"mask-text"},j={key:0,class:"camera-permission-dialog"},H={class:"dialog-content"},S={class:"dialog-title"},F={class:"dialog-message"},W={class:"dialog-buttons"},D={class:"ui-overlay"},I={key:0,class:"gesture-hint"},B={class:"hint-text"},R={class:"hint-subtext"},U={key:0,class:"image-display"},q=["src"],N=18e3,G=v({__name:"ConfessionElectronicCard",setup(v){const{t:G,locale:O}=e(),J=s(),V=f(),K=new E,Q=t(null),X=t(null),Y=t(!1),Z=t(!1),ee=t(!1),te=t(window.innerWidth<768),ae=t(!1),ne=t(!1),se=t(!1),ie=t(!1),oe=t(""),le=t(""),re=t(!1);let ce,de,ue,me,he,ve,fe,we=[],ge=[],pe=[],ye=[],xe=!1,ke=null,Ce=null,be=!1;const Me=()=>{const e=document.createElement("canvas");e.width=32,e.height=32;const t=e.getContext("2d");t.beginPath(),t.arc(16,16,14,0,2*Math.PI),t.fillStyle="#ffffff",t.fill();return new P(e)},ze=()=>({background:V.isDark?657946:1706542,particleColors:[new g(16739229),new g(16758465),new g(16738740),new g(16716947),new g(16777215)]}),Pe=()=>{const e=new x,t=new Float32Array(54e3),a=new Float32Array(54e3),n=new Float32Array(N);ye=new Float32Array(N);const s=ze().particleColors;for(let o=0;o<N;o++){const e=200*(Math.random()-.5),i=150*(Math.random()-.5),l=100*(Math.random()-.5);t[3*o]=e,t[3*o+1]=i,t[3*o+2]=l;const r=s[Math.floor(Math.random()*s.length)];a[3*o]=r.r,a[3*o+1]=r.g,a[3*o+2]=r.b;const c=Math.random();n[o]=c,ye[o]=c,we.push({x:e,y:i,z:l}),ge.push({x:e,y:i,z:l})}e.setAttribute("position",new k(t,3)),e.setAttribute("color",new k(a,3)),e.setAttribute("size",new k(n,1));const i=new C({size:.6,vertexColors:!0,map:Me(),transparent:!0,opacity:.8,depthWrite:!1,blending:b});me=new M(e,i),ce.add(me)},Ae=()=>{if(xe)return;xe=!0;const e=(e=>{const t=document.createElement("canvas"),a=t.getContext("2d"),n=te.value?36:50,s=`bold ${n}px "Noto Serif SC", serif`;a.font=s;const i=te.value?450:800,o=e.split("\n"),l=[];o.forEach(e=>{let t="";const n=e.split("");for(let s=0;s<n.length;s++){const e=n[s],o=t+e;a.measureText(o).width>i&&s>0?(l.push(t),t=e):t=o}l.push(t)});let r=0;l.forEach(e=>{r=Math.max(r,a.measureText(e).width)});const c=1.5*n,d=l.length*c;t.width=Math.max(r+100,512),t.height=Math.max(d+100,256),a.fillStyle="#000000",a.fillRect(0,0,t.width,t.height),a.fillStyle="#ffffff",a.font=s,a.textAlign="center",a.textBaseline="middle";const u=(t.height-d)/2+c/2;l.forEach((e,n)=>{a.fillText(e,t.width/2,u+n*c)});const m=l.length*c*.08;let h=te.value?-12:-15;if(te.value){const e=window.innerWidth,t=window.innerHeight;let a=.35*t,n=.8*a;n>.65*e&&(n=.65*e,a=1.25*n);const s=(.12*t+a+24)/t;h=2*Math.tan(60*Math.PI/180/2)*de.position.z/2*(1-2*s)-0-m/2}const v=a.getImageData(0,0,t.width,t.height),f=[],w=te.value?2:3;for(let g=0;g<t.height;g+=w)for(let e=0;e<t.width;e+=w){const a=4*(g*t.width+e);v.data[a]>128&&f.push({x:(e-t.width/2)*(te.value?.11:.08),y:.08*-(g-t.height/2)+h,z:0})}return f})(oe.value);e.length>0&&(pe=e),setTimeout(()=>{ee.value=!0},800)},Te=()=>{if(fe=requestAnimationFrame(Te),me){const e=me.geometry.attributes.position.array,t=me.geometry.attributes.size.array,a=.001*Date.now();for(let n=0;n<N;n++){let s,i;if(xe)if(n<pe.length)s=pe[n],i=ye[n];else{const e=ge[n];s={x:2*e.x,y:2*e.y,z:200},i=0}else{const e=ge[n];s={x:e.x+2*Math.sin(a+e.y),y:e.y+2*Math.cos(a+e.x),z:e.z+2*Math.sin(a+e.z)},i=ye[n]}const o=we[n].x,l=we[n].y,r=we[n].z,c=xe?.1:.05;we[n].x+=(s.x-o)*c,we[n].y+=(s.y-l)*c,we[n].z+=(s.z-r)*c,e[3*n]=we[n].x,e[3*n+1]=we[n].y,e[3*n+2]=we[n].z,t[n]+=.1*(i-t[n])}me.geometry.attributes.position.needsUpdate=!0,me.geometry.attributes.size.needsUpdate=!0,xe?(me.rotation.y=z.lerp(me.rotation.y,0,.05),me.rotation.x=z.lerp(me.rotation.x,0,.05)):(me.rotation.y=.1*Math.sin(.2*a),me.rotation.x=.05*Math.cos(.1*a))}ue&&ce&&de&&ue.render(ce,de)},Ee=e=>{let t=!1;if(e.multiHandLandmarks&&e.multiHandLandmarks.length>0){const a=e.multiHandLandmarks[0];_e(a)&&(t=!0)}t?(Z.value||(Z.value=!0,ne.value=!1,Ae()),ke&&(clearTimeout(ke),ke=null)):!Z.value||ke||ne.value||(ke=setTimeout(()=>{Z.value=!1,xe&&(xe=!1,ee.value=!1),ke=null},3e3))},$e=()=>{Z.value=!0,ne.value=!0,Ae(),ke&&(clearTimeout(ke),ke=null)},_e=e=>{const t=e[4],a=e[8];return Math.sqrt(Math.pow(t.x-a.x,2)+Math.pow(t.y-a.y,2))<.15},Le=()=>{if(be)return;be=!0;Ce=new Audio("https://draft-user.s3.us-east-2.amazonaws.com/images/0e5fbb6b-ebaf-4795-93c3-c1893d36d6d9.aac"),Ce.muted=!0,Ce.volume=0,Ce.play().catch(e=>{}),setTimeout(()=>{Ce&&(Ce.muted=!1,Ce.volume=1)},100)},je=async()=>{if(Y.value){if(ve)try{await ve.stop()}catch(e){}Y.value=!1}else ie.value=!0},He=async()=>{ie.value=!1,Le();try{ve=new T.Camera(X.value,{onFrame:async()=>{he&&X.value&&await he.send({image:X.value})},width:640,height:480}),await ve.start(),Y.value=!0,ae.value=!1}catch(e){"NotAllowedError"===e.name||e.message.includes("Permission denied"),ae.value=!0}},Se=()=>{ie.value=!1,ae.value=!0,Le()},Fe=()=>{if(!de||!ue||!Q.value)return;const e=Q.value.clientWidth,t=Q.value.clientHeight,a=te.value;te.value=e<768,a!==te.value&&Z.value&&(xe=!1,Ae()),de.aspect=e/t,de.updateProjectionMatrix(),de.position.z=te.value?110:60,ue.setSize(e,t)};return a(O,()=>{Z.value&&(xe=!1,Ae())}),a(()=>V.isDark,()=>{if(ce){const e=ze();ce.background=new g(e.background)}}),n(async()=>{const e=navigator.userAgent.toLowerCase();se.value=-1!==e.indexOf("micromessenger"),(()=>{if(!Q.value)return;const e=Q.value.clientWidth,t=Q.value.clientHeight;ce=new w;const a=ze();ce.background=new g(a.background),de=new p(60,e/t,.1,1e3),de.position.z=te.value?110:60,ue=new y({antialias:!0,alpha:!0}),ue.setSize(e,t),ue.setPixelRatio(Math.min(window.devicePixelRatio,2)),Q.value.appendChild(ue.domElement),Pe(),Te()})(),he=new A.Hands({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${e}`}),he.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.5}),he.onResults(Ee),(async()=>{ie.value=!0})(),window.addEventListener("resize",Fe);const t=J.query.id;if(t)try{const e=await K.getGreetingCardDetail({id:t});e.success&&e.data&&(oe.value=e.data.content,le.value=e.data.extraInfo?.image||"",le.value&&await(a=le.value,new Promise((e,t)=>{if(!a)return void e(!1);const n=new Image;n.onload=()=>{re.value=!0,e(!0)},n.onerror=()=>{re.value=!1,e(!1)},n.src=a})))}catch(n){}var a}),i(()=>{fe&&cancelAnimationFrame(fe),ve&&ve.stop(),ue&&ue.dispose(),ke&&clearTimeout(ke),Ce&&(Ce.pause(),Ce=null),window.removeEventListener("resize",Fe)}),(e,t)=>(h(),o("div",$,[l("div",{ref_key:"canvasContainer",ref:Q,class:"canvas-container"},null,512),r(d,{name:"fade"},{default:c(()=>[se.value?(h(),o("div",_,[t[0]||(t[0]=l("svg",{class:"arrow-icon",viewBox:"0 0 100 100",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M20 80 L80 20",stroke:"white","stroke-width":"8","stroke-linecap":"round",fill:"none"}),l("path",{d:"M80 20 L55 20",stroke:"white","stroke-width":"8","stroke-linecap":"round",fill:"none"}),l("path",{d:"M80 20 L80 45",stroke:"white","stroke-width":"8","stroke-linecap":"round",fill:"none"})],-1)),l("div",L,m(e.$t("confessionCard.wechatTip")),1)])):u("",!0)]),_:1}),r(d,{name:"fade"},{default:c(()=>[ie.value?(h(),o("div",j,[l("div",H,[t[1]||(t[1]=l("div",{class:"dialog-icon"},"ðŸ“·",-1)),l("div",S,m(e.$t("confessionCard.cameraPermissionTitle")),1),l("div",F,m(e.$t("confessionCard.cameraPermissionMessage")),1),l("div",W,[l("button",{class:"dialog-btn cancel-btn",onClick:Se},m(e.$t("confessionCard.cameraPermissionCancel")),1),l("button",{class:"dialog-btn confirm-btn",onClick:He},m(e.$t("confessionCard.cameraPermissionConfirm")),1)])])])):u("",!0)]),_:1}),l("div",D,[Z.value?u("",!0):(h(),o("div",I,[t[2]||(t[2]=l("div",{class:"hint-icon"},"ðŸ’•",-1)),l("div",B,m(e.$t("confessionCard.gestureHint")),1),l("div",R,m(e.$t("confessionCard.gestureSubtext")),1),l("button",{class:"manual-trigger-btn",onClick:$e},m(e.$t("confessionCard.manualTrigger")),1)])),r(d,{name:"fade"},{default:c(()=>[Z.value&&ee.value?(h(),o("div",U,[l("img",{src:le.value.replace("draft-user.s3.us-east-2.amazonaws.com","dcts99982ui0s.cloudfront.net"),alt:"Confession",class:"confession-image"},null,8,q)])):u("",!0)]),_:1}),ae.value?(h(),o("div",{key:1,class:"camera-toggle",onClick:je},[l("span",null,m(e.$t("confessionCard.enableCamera")),1)])):u("",!0)]),l("video",{ref_key:"videoElement",ref:X,class:"hidden-video",autoplay:"",playsinline:""},null,512)]))}},[["__scopeId","data-v-ee1fb809"]]);export{G as default};
