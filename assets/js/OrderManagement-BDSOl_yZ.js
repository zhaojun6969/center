import{_ as e,e as a,i as t,g as r,W as l}from"./index-B4iIxVom.js";/* empty css                 */import{c as o,az as s,r as n,j as d,w as u,U as i,z as c,A as v,B as m,R as p,P as g,J as f,O as y,u as _,I as h,L as D,E as w,aA as S,Q as O,a5 as b}from"./vendor-ClluBQmh.js";import{P as E,Q as I,R as N,S as M,E as C,x as k,D as P,T as x,c as L,U as R,H as A,l as T,b as z,a as j,V,W as B,X as U,d as F}from"./elementPlus-5sGCOaHt.js";import{g as H,s as q,a as G,O as W}from"./OrderManagement-qaC_AxMN.js";import{d as $}from"./utils-D5ZNaMwG.js";const J={class:"order-card__header"},Q={class:"order-card__id"},X={class:"order-number"},K={class:"order-card__content"},Y={class:"order-info"},Z={class:"customer-section"},ee={class:"order-date"},ae={class:"products-section"},te={class:"products-title"},re={class:"products-list"},le={class:"product-item"},oe=["src","alt"],se={class:"product-details"},ne={class:"product-name"},de={class:"product-quantity"},ue={class:"product-price"},ie={class:"order-card__actions"},ce={class:"action-buttons"},ve=e({__name:"OrderCard",props:{order_type:{type:Number,default:0},order:{type:Object,required:!0}},emits:["view-details","pay-order","cancel-order","confirm-order","expired-order"],setup(e,{emit:a}){const t=e,r=o(()=>{let e={};return t.order?.order_info?.ipName?e={image:t.order?.order_info?.modelData?.imageUrl,alt:t.order?.order_info?.ipName,goodName:t.order.order_info.ipName||"rob",quantity:t.order.order_info.quantity,currency:t.order.currency,amount:t.order.actual_amount}:t.order?.order_info?.goods_info?.mainImage&&(e={image:t.order?.order_info?.goods_info?.mainImage,alt:"goods",goodName:t.order.order_info.goods_name,quantity:t.order.quantity,currency:t.order.currency,amount:t.order.actual_amount}),e}),l=a,{t:S}=s(),O=n(!1),b=n(!1),A=n(!1),T=n(!1),z=n(!1),j=n("");let V=null;const B=n(null),U=n(360),F=()=>{B.value&&(U.value=B.value.offsetWidth)},q=()=>{F()},G=o(()=>H(t.order));o(()=>{const e=[];return"completed"===t.order.status&&e.push({key:"download-invoice",label:S("orderManagement.actions.downloadInvoice"),icon:E}),"shipped"!==t.order.status&&"completed"!==t.order.status||e.push({key:"view-tracking",label:S("orderManagement.actions.viewTracking"),icon:I}),"paid"!==t.order.status&&"completed"!==t.order.status||e.push({key:"contact-seller",label:S("orderManagement.actions.contactSeller"),icon:N}),e});const W=e=>{if(!e)return"-";const a=new Date(e);return a.toLocaleDateString()+" "+a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},$=e=>{e.target.src="/default-product.png"},ve=()=>{l("view-details",t.order)},me=async()=>{b.value=!0;try{l("pay-order",t.order)}finally{b.value=!1}},pe=async()=>{A.value=!0;try{l("cancel-order",t.order)}finally{A.value=!1}},ge=async()=>{T.value=!0;try{l("confirm-order",t.order.id)}finally{T.value=!1}},fe=()=>{const e=t.order.expiresAt?new Date(t.order.expiresAt).getTime():null;if(!e)return z.value=!1,void(j.value="");const a=Date.now(),r=Math.max(0,e-a);if(r<=0)return z.value=!0,j.value="00:00",V&&(clearInterval(V),V=null),void l("expired-order",t.order.id);const o=Math.floor(r/6e4),s=Math.floor(r%6e4/1e3);j.value=`${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}`},ye=()=>{fe(),V&&clearInterval(V),V=setInterval(fe,1e3)},_e=()=>{V&&(clearInterval(V),V=null)};return d(()=>{"pending"===t.order.status&&ye(),F(),window.addEventListener("resize",q,{passive:!0})}),u(()=>t.order.expiresAt,()=>{"pending"===t.order.status?ye():_e()}),u(()=>t.order.status,e=>{"pending"===e?ye():_e()}),i(()=>{_e(),window.removeEventListener("resize",q)}),(a,t)=>{const l=M,o=C,s=P;return v(),c("div",{class:w(["order-card",`order-card--${e.order.status}`,{"order-card--expanded":O.value}]),ref_key:"cardRef",ref:B},[m("div",J,[m("div",Q,[m("span",X,"#"+g(e.order.order_no),1)]),p(l,{type:G.value.status,size:"small"},{default:f(()=>[y(g(_(S)(G.value.label)),1)]),_:1},8,["type"])]),m("div",K,[m("div",Y,[m("div",Z,[m("div",ee,[m("span",null,g(W(e.order.created_at)),1)])]),m("div",ae,[m("h4",te,g(_(S)("orderManagement.order.products")),1),m("div",re,[m("div",le,[m("img",{src:r.value.image,alt:r.value.alt,class:"product-image",onError:$},null,40,oe),m("div",se,[m("span",ne,g(r.value.goodName),1),m("span",de,"x"+g(r.value.quantity),1)]),m("div",ue,g(r.value.currency)+" "+g(Number(r.value.amount).toFixed(2)),1)])])])])]),m("div",ie,[m("div",ce,[p(s,{size:"small",onClick:ve},{default:f(()=>[p(o,null,{default:f(()=>[p(_(k)),t[0]||(t[0]=y(" ",-1))]),_:1}),y(" "+g(_(S)("orderManagement.actions.view")),1)]),_:1}),"dzf"===G.value.type?(v(),h(s,{key:0,type:"primary",size:"small",onClick:me,loading:b.value,disabled:z.value},{default:f(()=>[p(o,null,{default:f(()=>[p(_(x)),t[1]||(t[1]=y(" ",-1))]),_:1}),y(" "+g(_(S)("orderManagement.actions.pay")),1)]),_:1},8,["loading","disabled"])):D("",!0),"dzf"===G.value.type?(v(),h(s,{key:1,type:"danger",size:"small",onClick:pe,loading:A.value},{default:f(()=>[p(o,null,{default:f(()=>[p(_(L)),t[2]||(t[2]=y(" ",-1))]),_:1}),y(" "+g(_(S)("orderManagement.actions.cancel")),1)]),_:1},8,["loading"])):D("",!0),"yfh"===G.value.type?(v(),h(s,{key:2,type:"success",size:"small",onClick:ge,loading:T.value},{default:f(()=>[p(o,null,{default:f(()=>[p(_(R))]),_:1}),y(" "+g(_(S)("orderManagement.actions.confirm")),1)]),_:1},8,["loading"])):D("",!0)])])],2)}}},[["__scopeId","data-v-87e4e12e"]]),me={PENDING:"pending",PROCESSING:"processing",SHIPPED:"shipped",CANCELLED:"cancelled",REFUNDED:"refunded"},pe={[me.PENDING]:"待处理",[me.PROCESSING]:"处理中",[me.SHIPPED]:"已发货",[me.DELIVERED]:"已送达",[me.CANCELLED]:"已取消",[me.REFUNDED]:"已退款"},ge=$("orders",()=>{const e=n([]),a=n(null),t=n(!1),r=n(null),l=n({status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null}),s=n({currentPage:1,pageSize:10,total:0}),d=o(()=>{let a=[...e.value];if(l.value.status&&(a=a.filter(e=>e.status===l.value.status)),l.value.search){const e=l.value.search.toLowerCase();a=a.filter(a=>a.orderId?.toLowerCase().includes(e)||a.customerName?.toLowerCase().includes(e)||a.customerEmail?.toLowerCase().includes(e))}if(l.value.dateRange?.start&&l.value.dateRange?.end){const e=new Date(l.value.dateRange.start),t=new Date(l.value.dateRange.end);a=a.filter(a=>{const r=new Date(a.created_at);return r>=e&&r<=t})}return a.sort((e,a)=>{const{sortBy:t,sortOrder:r}=l.value;let o=e[t],s=a[t];return"created_at"!==t&&"updatedAt"!==t||(o=new Date(o).getTime(),s=new Date(s).getTime()),"string"==typeof o&&(o=o.toLowerCase(),s=s.toLowerCase()),"asc"===r?o>s?1:-1:o<s?1:-1}),a}),u=o(()=>{const{currentPage:e,pageSize:a}=s.value,t=(e-1)*a,r=t+a;return d.value.slice(t,r)}),i=o(()=>({total:e.value.length,pending:e.value.filter(e=>e.status===me.PENDING).length,processing:e.value.filter(e=>e.status===me.PROCESSING).length,shipped:e.value.filter(e=>e.status===me.SHIPPED).length,delivered:e.value.filter(e=>e.status===me.DELIVERED).length,cancelled:e.value.filter(e=>e.status===me.CANCELLED).length,refunded:e.value.filter(e=>e.status===me.REFUNDED).length,totalRevenue:e.value.filter(e=>e.status!==me.CANCELLED).reduce((e,a)=>e+(a.total||0),0)})),c=o(()=>d.value.length),v=a=>{e.value=a.map(e=>({...e,created_at:e.created_at||(new Date).toISOString(),updatedAt:e.updatedAt||(new Date).toISOString()})),s.value.total=e.value.length},m=(a,t)=>{const r=e.value.findIndex(e=>e.id===a);return-1!==r&&(e.value[r]={...e.value[r],...t,updatedAt:(new Date).toISOString()}),e.value[r]},p=a=>e.value.find(e=>e.id===a);return{orders:e,currentOrder:a,loading:t,error:r,filters:l,pagination:s,filteredOrders:d,paginatedOrders:u,orderStats:i,totalOrders:c,setOrders:v,addOrder:a=>{const t={...a,id:Date.now().toString(),created_at:(new Date).toISOString(),updatedAt:(new Date).toISOString(),status:a.status||me.PENDING};return e.value.unshift(t),s.value.total=e.value.length,t},updateOrder:m,deleteOrder:a=>{const t=e.value.findIndex(e=>e.id===a);return-1!==t&&(e.value.splice(t,1),s.value.total=e.value.length,!0)},getOrder:p,setCurrentOrder:e=>{a.value=e},updateOrderStatus:(a,t)=>m(a,{status:t,statusHistory:[...e.value.find(e=>e.id===a)?.statusHistory||[],{status:t,timestamp:(new Date).toISOString(),note:`状态更新为 ${pe[t]}`}]}),updateFilters:e=>{l.value={...l.value,...e},s.value.currentPage=1},updatePagination:e=>{s.value={...s.value,...e}},resetFilters:()=>{l.value={status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null},s.value.currentPage=1},getStatusHistory:e=>{const a=p(e);return a?.statusHistory||[]},exportOrders:(e="json")=>{const a=d.value;if("csv"===e){return[["订单ID","客户姓名","客户邮箱","状态","总金额","创建时间","更新时间"].join(","),...a.map(e=>[e.orderId||"",e.customerName||"",e.customerEmail||"",pe[e.status]||"",e.total||0,e.created_at,e.updatedAt].join(","))].join("\n")}return JSON.stringify(a,null,2)},initSampleData:()=>{v([])}}},{persist:{key:"orders",storage:localStorage,paths:["filters","pagination"]}}),fe={class:"order-management"},ye={class:"orders-section"},_e={class:"filter-section"},he={class:"filter-row"},De={class:"filter-group"},we={class:"filter-label"},Se={class:"status-filter"},Oe=["onClick"],be={class:"filter-group"},Ee={class:"filter-label"},Ie={class:"filter-group"},Ne={class:"filter-label"},Me={class:"filter-group"},Ce={class:"filter-label"},ke={class:"orders-grid"},Pe={key:0,class:"empty-state"},xe={class:"empty-icon"},Le={class:"empty-title"},Re={class:"empty-description"},Ae={key:0,style:{height:"60px"}},Te=e({__name:"OrderManagement",setup(e){const o=new W,{t:i}=s(),y=S(),E=ge(),I=n("all"),N=q("1"),M=n([{label:i("orderManagement.sort.created_at"),value:"created_at"},{label:i("orderManagement.sort.total"),value:"amount"}]),k=e=>{console.log(e),y.push({name:"order-detail",params:{orderId:e.id}})},P=e=>{if(console.log(e),t()){if(!e.order_info.pay_params)return void F.error("当前订单不属于小程序订单");const a=r();return void l.BusWechartForNavigate("/pages/pay/pay",{method:"pay",payData:JSON.stringify({...e.order_info,token:a,amount:e.order_info.amount,order_no:e.order_no})})}window.location.href=e.stripe_url},x=e=>{U.confirm(i("orderManagement.confirm.message"),i("orderManagement.confirm.title"),{confirmButtonText:i("common.confirm"),cancelButtonText:i("common.cancel"),type:"warning"}).then(()=>{o.receiveAddress(e).then(e=>{oe()})})},L=e=>{U.confirm(i("orderManagement.cancelConfirm.message"),i("orderManagement.cancelConfirm.title"),{confirmButtonText:i("common.confirm"),cancelButtonText:i("common.cancel"),type:"warning"}).then(()=>{o.orderCancel({id:e.id}).then(e=>{0===e.code?(F.success(i("orderManagement.cancelSuccess")),oe()):F.error(e.message||i("orderManagement.cancelFail"))})}).catch(()=>{})},R=e=>{E.updateOrder(e,{status:"expired"})},H=n(1),$=n(10),J=n(""),Q=n(!1),X=n(!1),K=n("created_at"),Y=n("desc"),Z=n([]),ee=n(0),ae=n({}),te=()=>{le()},re=n(localStorage.getItem("order_type")?parseInt(localStorage.getItem("order_type")):0),le=()=>{X.value||(Q.value=!0,o.getOrderList({page:H.value,page_size:$.value,order_no:J.value,sort_by:K.value,sort_order:Y.value,...ae.value},re.value).then(e=>{if(0==e.code){let a=e.data;1===H.value?Z.value=a.items:Z.value=[...Z.value,...a.items],ee.value=a.total,X.value=Z.value.length>=ee.value,H.value++}}))},oe=()=>{Q.value=!1,X.value=!1,Z.value=[],H.value=1,$.value=10,le()};u(J,()=>{clearTimeout(window._orderNoDebounce),window._orderNoDebounce=setTimeout(()=>{oe()},300)}),d(()=>{oe()});return u(K,()=>{oe()}),u(re,()=>{localStorage.setItem("order_type",re.value),oe()}),(e,t)=>{const r=C,l=A,o=j,s=z,n=B;return v(),h(n,{height:"100%",onEndReached:te},{default:f(()=>[m("div",fe,[m("div",ye,[m("div",_e,[m("div",he,[m("div",De,[m("label",we,g(_(i)("orderManagement.filters.status")),1),m("div",Se,[(v(!0),c(O,null,b(_(N),e=>(v(),c("button",{key:e.key,class:w(["status-tab",{active:I.value===e.key}]),onClick:a=>(e=>{const a=G(e);ae.value=a,I.value=e,oe()})(e.key)},g(_(i)(e.label)),11,Oe))),128))])]),m("div",be,[m("label",Ee,g(_(i)("orderManagement.filters.search")),1),p(l,{modelValue:J.value,"onUpdate:modelValue":t[0]||(t[0]=e=>J.value=e),placeholder:_(i)("orderManagement.searchPlaceholder"),class:"search-input",clearable:""},{prefix:f(()=>[p(r,null,{default:f(()=>[p(_(T))]),_:1})]),_:1},8,["modelValue","placeholder"])]),m("div",Ie,[m("label",Ne,g(_(i)("orderManagement.filters.sort")),1),p(s,{modelValue:K.value,"onUpdate:modelValue":t[1]||(t[1]=e=>K.value=e),class:"sort-select"},{default:f(()=>[(v(!0),c(O,null,b(M.value,e=>(v(),h(o,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),m("div",Me,[m("label",Ce,g(_(i)("orderManagement.filters.orderType")),1),p(s,{modelValue:re.value,"onUpdate:modelValue":t[2]||(t[2]=e=>re.value=e),class:"sort-select"},{default:f(()=>[p(o,{label:_(i)("orderManagement.status.all"),value:-1},null,8,["label"]),p(o,{label:_(i)("orderManagement.orderType.projectOrder"),value:0},null,8,["label"]),p(o,{label:_(i)("orderManagement.orderType.shopOrder"),value:4},null,8,["label"])]),_:1},8,["modelValue"])])])]),m("div",ke,[(v(!0),c(O,null,b(Z.value,e=>(v(),h(ve,{key:e.id,order:e,order_type:re.value,onViewDetails:k,onPayOrder:P,onCancelOrder:L,onExpiredOrder:R,onConfirmOrder:x},null,8,["order","order_type"]))),128))]),0===Z.value.length?(v(),c("div",Pe,[m("div",xe,[p(r,null,{default:f(()=>[p(_(V))]),_:1})]),m("h3",Le,g(_(i)("orderManagement.empty.title")),1),m("p",Re,g(_(i)("orderManagement.empty.description")),1)])):D("",!0)])]),_(a).isPortraitDevice()?(v(),c("div",Ae)):D("",!0)]),_:1})}}},[["__scopeId","data-v-c240affb"]]);export{Te as default};
