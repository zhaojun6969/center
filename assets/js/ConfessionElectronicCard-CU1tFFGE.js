import{az as e,r as a,j as t,f as n,aB as s,U as o,z as i,B as l,R as r,J as c,T as d,L as u,P as m,A as h}from"./vendor-zwaLhAD5.js";import{_ as v,l as f}from"./index-BrLNRVYc.js";import{S as g,C as w,P as p,W as y,B as x,c as C,d as b,e as k,f as z,n as M,i as A}from"./three.module-tObHcZ0u.js";import{h as P,c as T}from"./camera_utils-lrZrBT_a.js";import{G as _}from"./index-DcnNDhno.js";import"./elementPlus-C3N3Ediy.js";import"./utils-D5HVl94d.js";const E={class:"confession-card-container"},$={key:0,class:"wechat-mask"},j={class:"mask-text"},L={key:0,class:"camera-permission-dialog"},F={class:"dialog-content"},H={class:"dialog-title"},S={class:"dialog-message"},I={class:"dialog-buttons"},D={class:"ui-overlay"},W={key:0,class:"gesture-hint"},B={class:"hint-text"},R={class:"hint-subtext"},q={key:0,class:"image-display"},N=["src"],U=18e3,G=v({__name:"ConfessionElectronicCard",setup(v){const{t:G,locale:O}=e(),J=s(),Y=f(),Z=new _,K=a(null),Q=a(null),V=a(!1),X=a(!1),ee=a(!1),ae=a(window.innerWidth<768),te=a(!1),ne=a(!1),se=a(!1),oe=a(!1),ie=a(""),le=a(""),re=a(!1);let ce,de,ue,me,he,ve,fe,ge=[],we=[],pe=[],ye=[],xe=!1,Ce=null,be=null,ke=!1;const ze=()=>{const e=document.createElement("canvas");e.width=32,e.height=32;const a=e.getContext("2d");a.beginPath(),a.arc(16,16,14,0,2*Math.PI),a.fillStyle="#ffffff",a.fill();return new A(e)},Me=()=>({background:Y.isDark?657946:1706542,particleColors:[new w(16739229),new w(16758465),new w(16738740),new w(16716947),new w(16777215)]}),Ae=()=>{const e=new x,a=new Float32Array(54e3),t=new Float32Array(54e3),n=new Float32Array(U);ye=new Float32Array(U);const s=Me().particleColors;for(let i=0;i<U;i++){const e=200*(Math.random()-.5),o=150*(Math.random()-.5),l=100*(Math.random()-.5);a[3*i]=e,a[3*i+1]=o,a[3*i+2]=l;const r=s[Math.floor(Math.random()*s.length)];t[3*i]=r.r,t[3*i+1]=r.g,t[3*i+2]=r.b;const c=Math.random();n[i]=c,ye[i]=c,ge.push({x:e,y:o,z:l}),we.push({x:e,y:o,z:l})}e.setAttribute("position",new C(a,3)),e.setAttribute("color",new C(t,3)),e.setAttribute("size",new C(n,1));const o=new b({size:.6,vertexColors:!0,map:ze(),transparent:!0,opacity:.8,depthWrite:!1,blending:k});me=new z(e,o),ce.add(me)},Pe=()=>{if(xe)return;xe=!0;const e=(e=>{const a=document.createElement("canvas"),t=a.getContext("2d"),n=ae.value?36:50,s=`bold ${n}px "Noto Serif SC", serif`;t.font=s;const o=ae.value?450:800,i=e.split("\n"),l=[];i.forEach(e=>{let a="";const n=e.split("");for(let s=0;s<n.length;s++){const e=n[s],i=a+e;t.measureText(i).width>o&&s>0?(l.push(a),a=e):a=i}l.push(a)});let r=0;l.forEach(e=>{r=Math.max(r,t.measureText(e).width)});const c=1.5*n,d=l.length*c;a.width=Math.max(r+100,512),a.height=Math.max(d+100,256),t.fillStyle="#000000",t.fillRect(0,0,a.width,a.height),t.fillStyle="#ffffff",t.font=s,t.textAlign="center",t.textBaseline="middle";const u=(a.height-d)/2+c/2;l.forEach((e,n)=>{t.fillText(e,a.width/2,u+n*c)});const m=l.length*c*.08;let h=ae.value?-12:-15;if(ae.value){const e=window.innerWidth,a=window.innerHeight;let t=.35*a,n=.8*t;n>.65*e&&(n=.65*e,t=1.25*n);const s=(.12*a+t+24)/a;h=2*Math.tan(60*Math.PI/180/2)*de.position.z/2*(1-2*s)-0-m/2}const v=t.getImageData(0,0,a.width,a.height),f=[],g=ae.value?2:3;for(let w=0;w<a.height;w+=g)for(let e=0;e<a.width;e+=g){const t=4*(w*a.width+e);v.data[t]>128&&f.push({x:(e-a.width/2)*(ae.value?.11:.08),y:.08*-(w-a.height/2)+h,z:0})}return f})(ie.value);e.length>0&&(pe=e),setTimeout(()=>{ee.value=!0},800)},Te=()=>{if(fe=requestAnimationFrame(Te),me){const e=me.geometry.attributes.position.array,a=me.geometry.attributes.size.array,t=.001*Date.now();for(let n=0;n<U;n++){let s,o;if(xe)if(n<pe.length)s=pe[n],o=ye[n];else{const e=we[n];s={x:2*e.x,y:2*e.y,z:200},o=0}else{const e=we[n];s={x:e.x+2*Math.sin(t+e.y),y:e.y+2*Math.cos(t+e.x),z:e.z+2*Math.sin(t+e.z)},o=ye[n]}const i=ge[n].x,l=ge[n].y,r=ge[n].z,c=xe?.1:.05;ge[n].x+=(s.x-i)*c,ge[n].y+=(s.y-l)*c,ge[n].z+=(s.z-r)*c,e[3*n]=ge[n].x,e[3*n+1]=ge[n].y,e[3*n+2]=ge[n].z,a[n]+=.1*(o-a[n])}me.geometry.attributes.position.needsUpdate=!0,me.geometry.attributes.size.needsUpdate=!0,xe?(me.rotation.y=M.lerp(me.rotation.y,0,.05),me.rotation.x=M.lerp(me.rotation.x,0,.05)):(me.rotation.y=.1*Math.sin(.2*t),me.rotation.x=.05*Math.cos(.1*t))}ue&&ce&&de&&ue.render(ce,de)},_e=e=>{let a=!1;if(e.multiHandLandmarks&&e.multiHandLandmarks.length>0){const t=e.multiHandLandmarks[0];$e(t)&&(a=!0)}a?(X.value||(X.value=!0,ne.value=!1,Pe()),Ce&&(clearTimeout(Ce),Ce=null)):!X.value||Ce||ne.value||(Ce=setTimeout(()=>{X.value=!1,xe&&(xe=!1,ee.value=!1),Ce=null},3e3))},Ee=()=>{X.value=!0,ne.value=!0,Pe(),Ce&&(clearTimeout(Ce),Ce=null)},$e=e=>{const a=e[4],t=e[8];return Math.sqrt(Math.pow(a.x-t.x,2)+Math.pow(a.y-t.y,2))<.15},je=()=>{if(ke)return;ke=!0;be=new Audio("https://draft-user.s3.us-east-2.amazonaws.com/images/0e5fbb6b-ebaf-4795-93c3-c1893d36d6d9.aac"),be.muted=!0,be.volume=0,be.play().catch(e=>{console.log("Audio play failed:",e)}),setTimeout(()=>{be&&(be.muted=!1,be.volume=1)},100)},Le=async()=>{if(V.value){if(ve)try{await ve.stop()}catch(e){console.log("Camera stop error:",e)}V.value=!1}else oe.value=!0},Fe=async()=>{oe.value=!1,je();try{ve=new T.Camera(Q.value,{onFrame:async()=>{he&&Q.value&&await he.send({image:Q.value})},width:640,height:480}),await ve.start(),V.value=!0,te.value=!1}catch(e){"NotAllowedError"===e.name||e.message.includes("Permission denied")?console.log("Camera permission denied by user"):console.log("Camera access error:",e.name||e),te.value=!0}},He=()=>{oe.value=!1,te.value=!0,je()},Se=()=>{if(!de||!ue||!K.value)return;const e=K.value.clientWidth,a=K.value.clientHeight,t=ae.value;ae.value=e<768,t!==ae.value&&X.value&&(xe=!1,Pe()),de.aspect=e/a,de.updateProjectionMatrix(),de.position.z=ae.value?110:60,ue.setSize(e,a)};return t(O,()=>{X.value&&(xe=!1,Pe())}),t(()=>Y.isDark,()=>{if(ce){const e=Me();ce.background=new w(e.background)}}),n(async()=>{const e=navigator.userAgent.toLowerCase();se.value=-1!==e.indexOf("micromessenger"),(()=>{if(!K.value)return;const e=K.value.clientWidth,a=K.value.clientHeight;ce=new g;const t=Me();ce.background=new w(t.background),de=new p(60,e/a,.1,1e3),de.position.z=ae.value?110:60,ue=new y({antialias:!0,alpha:!0}),ue.setSize(e,a),ue.setPixelRatio(Math.min(window.devicePixelRatio,2)),K.value.appendChild(ue.domElement),Ae(),Te()})(),he=new P.Hands({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${e}`}),he.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.5}),he.onResults(_e),(async()=>{oe.value=!0})(),window.addEventListener("resize",Se),console.log(J,"routeroute");const a=J.query.id;if(a)try{const e=await Z.getGreetingCardDetail({id:a});e.success&&e.data&&(ie.value=e.data.content,le.value=e.data.extraInfo?.image||"",le.value&&await(t=le.value,new Promise((e,a)=>{if(!t)return void e(!1);const n=new Image;n.onload=()=>{re.value=!0,e(!0)},n.onerror=()=>{console.error("Image preload failed:",t),re.value=!1,e(!1)},n.src=t})))}catch(n){console.error("Failed to fetch greeting card detail:",n)}var t}),o(()=>{fe&&cancelAnimationFrame(fe),ve&&ve.stop(),ue&&ue.dispose(),Ce&&clearTimeout(Ce),be&&(be.pause(),be=null),window.removeEventListener("resize",Se)}),(e,a)=>(h(),i("div",E,[l("div",{ref_key:"canvasContainer",ref:K,class:"canvas-container"},null,512),r(d,{name:"fade"},{default:c(()=>[se.value?(h(),i("div",$,[a[0]||(a[0]=l("svg",{class:"arrow-icon",viewBox:"0 0 100 100",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M20 80 L80 20",stroke:"white","stroke-width":"8","stroke-linecap":"round",fill:"none"}),l("path",{d:"M80 20 L55 20",stroke:"white","stroke-width":"8","stroke-linecap":"round",fill:"none"}),l("path",{d:"M80 20 L80 45",stroke:"white","stroke-width":"8","stroke-linecap":"round",fill:"none"})],-1)),l("div",j,m(e.$t("confessionCard.wechatTip")),1)])):u("",!0)]),_:1}),r(d,{name:"fade"},{default:c(()=>[oe.value?(h(),i("div",L,[l("div",F,[a[1]||(a[1]=l("div",{class:"dialog-icon"},"ðŸ“·",-1)),l("div",H,m(e.$t("confessionCard.cameraPermissionTitle")),1),l("div",S,m(e.$t("confessionCard.cameraPermissionMessage")),1),l("div",I,[l("button",{class:"dialog-btn cancel-btn",onClick:He},m(e.$t("confessionCard.cameraPermissionCancel")),1),l("button",{class:"dialog-btn confirm-btn",onClick:Fe},m(e.$t("confessionCard.cameraPermissionConfirm")),1)])])])):u("",!0)]),_:1}),l("div",D,[X.value?u("",!0):(h(),i("div",W,[a[2]||(a[2]=l("div",{class:"hint-icon"},"ðŸ’•",-1)),l("div",B,m(e.$t("confessionCard.gestureHint")),1),l("div",R,m(e.$t("confessionCard.gestureSubtext")),1),l("button",{class:"manual-trigger-btn",onClick:Ee},m(e.$t("confessionCard.manualTrigger")),1)])),r(d,{name:"fade"},{default:c(()=>[X.value&&ee.value?(h(),i("div",q,[l("img",{src:le.value.replace("draft-user.s3.us-east-2.amazonaws.com","dcts99982ui0s.cloudfront.net"),alt:"Confession",class:"confession-image"},null,8,N)])):u("",!0)]),_:1}),te.value?(h(),i("div",{key:1,class:"camera-toggle",onClick:Le},[l("span",null,m(e.$t("confessionCard.enableCamera")),1)])):u("",!0)]),l("video",{ref_key:"videoElement",ref:Q,class:"hidden-video",autoplay:"",playsinline:""},null,512)]))}},[["__scopeId","data-v-bea4a134"]]);export{G as default};
