import{_ as e,e as a,i as t,g as r,W as l}from"./index-7lN_iYAB.js";/* empty css                 */import{al as s,z as n,A as o,B as d,R as i,P as u,J as c,O as v,I as p,L as m,E as g,az as f,r as y,c as h,f as _,j as w,U as C,aA as D,u as E,Q as S,a5 as O}from"./vendor-zwaLhAD5.js";import{T as b,U as k,c as I,y as M,V as P,W as x,u as N,f as L,X as R,Y as A,Z as T,_ as z,$ as V,a0 as j,E as B,F,I as U,n as G,b as H,a as W,a1 as $,R as q,a2 as J,d as Q}from"./elementPlus-CAPqDV7g.js";import{g as X,s as Y,a as Z,O as K}from"./OrderManagement-D1doi4Hu.js";import{d as ee}from"./utils-D5HVl94d.js";const ae={class:"order-card__header"},te={class:"order-card__id"},re={class:"order-number"},le={class:"order-card__content"},se={class:"order-info"},ne={class:"customer-section"},oe={class:"order-date"},de={class:"products-section"},ie={class:"products-title"},ue={class:"products-list"},ce={class:"product-item"},ve=["src","alt"],pe={class:"product-details"},me={class:"product-name"},ge={class:"product-quantity"},fe={class:"product-price"},ye={class:"order-card__actions"},he={class:"action-buttons"};const _e=e({name:"OrderCard",components:{Clock:V,Check:z,Van:T,CircleCheck:A,Warning:R,ArrowDown:L,User:N,Calendar:x,CreditCard:P,View:M,Close:I,Download:k,ChatLineSquare:b},props:{order:{type:Object,required:!0}},emits:["view-details","pay-order","cancel-order","confirm-order","expired-order"],setup(e,{emit:a}){const{t:t}=f(),r=y(!1),l=y(!1),s=y(!1),n=y(!1),o=y(!1),d=y("");let i=null;const u=y(null),c=y(360),v=()=>{u.value&&(c.value=u.value.offsetWidth)},p=()=>{v()},m=h(()=>X(e.order)),g=h(()=>{const a=[];return"completed"===e.order.status&&a.push({key:"download-invoice",label:t("orderManagement.actions.downloadInvoice"),icon:k}),"shipped"!==e.order.status&&"completed"!==e.order.status||a.push({key:"view-tracking",label:t("orderManagement.actions.viewTracking"),icon:T}),"paid"!==e.order.status&&"completed"!==e.order.status||a.push({key:"contact-seller",label:t("orderManagement.actions.contactSeller"),icon:b}),a}),D=()=>{const t=e.order.expiresAt?new Date(e.order.expiresAt).getTime():null;if(!t)return o.value=!1,void(d.value="");const r=Date.now(),l=Math.max(0,t-r);if(l<=0)return o.value=!0,d.value="00:00",i&&(clearInterval(i),i=null),void a("expired-order",e.order.id);const s=Math.floor(l/6e4),n=Math.floor(l%6e4/1e3);d.value=`${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`},E=()=>{D(),i&&clearInterval(i),i=setInterval(D,1e3)},S=()=>{i&&(clearInterval(i),i=null)};return _(()=>{"pending"===e.order.status&&E(),v(),window.addEventListener("resize",p,{passive:!0})}),w(()=>e.order.expiresAt,()=>{"pending"===e.order.status?E():S()}),w(()=>e.order.status,e=>{"pending"===e?E():S()}),C(()=>{S(),window.removeEventListener("resize",p)}),{isExpanded:r,isPaying:l,isCancelling:s,isConfirming:n,isExpired:o,countdownText:d,statusType:m,moreActions:g,toggleExpand:()=>{r.value=!r.value,v()},formatDate:e=>{if(!e)return"-";const a=new Date(e);return a.toLocaleDateString()+" "+a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},handleImageError:e=>{e.target.src="/default-product.png"},viewDetails:()=>{a("view-details",e.order)},handlePay:async()=>{l.value=!0;try{a("pay-order",e.order)}finally{l.value=!1}},handleCancel:async()=>{s.value=!0;try{a("cancel-order",e.order)}finally{s.value=!1}},handleConfirm:async()=>{n.value=!0;try{a("confirm-order",e.order.id)}finally{n.value=!1}},handleMoreAction:a=>{switch(a){case"download-invoice":console.log("Download invoice for order:",e.order.id);break;case"view-tracking":console.log("View tracking for order:",e.order.id);break;case"contact-seller":console.log("Contact seller for order:",e.order.id)}},getPaymentMethodLabel:e=>({stripe:"Stripe",alipay:"支付宝",wechat:"微信支付",card:"信用卡",bank:"银行转账"}[e]||e||"-"),getPaymentStatusLabel:e=>({pending:t("orderManagement.payment.pending"),paid:t("orderManagement.payment.paid"),failed:t("orderManagement.payment.failed"),refunded:t("orderManagement.payment.refunded")}[e]||e||"-"),t:t,cardRef:u,cardWidth:c}}},[["render",function(e,a,t,r,l,f){const y=j,h=s("View"),_=B,w=F,C=s("CreditCard"),D=s("Close"),E=s("Check");return o(),n("div",{class:g(["order-card",`order-card--${t.order.status}`,{"order-card--expanded":r.isExpanded}]),ref:"cardRef"},[d("div",ae,[d("div",te,[d("span",re,"#"+u(t.order.order_no),1)]),i(y,{type:r.statusType.status,size:"small"},{default:c(()=>[v(u(r.t(r.statusType.label)),1)]),_:1},8,["type"])]),d("div",le,[d("div",se,[d("div",ne,[d("div",oe,[d("span",null,u(r.formatDate(t.order.created_at)),1)])]),d("div",de,[d("h4",ie,u(r.t("orderManagement.order.products")),1),d("div",ue,[d("div",ce,[d("img",{src:t.order?.order_info?.modelData?.imageUrl,alt:t.order?.order_info?.ipName,class:"product-image",onError:a[0]||(a[0]=(...e)=>r.handleImageError&&r.handleImageError(...e))},null,40,ve),d("div",pe,[d("span",me,u(t.order.order_info.ipName||"rob"),1),d("span",ge,"x"+u(t.order.order_info.quantity),1)]),d("div",fe,u(t.order.currency)+" "+u(Number(t.order.actual_amount).toFixed(2)),1)])])])])]),d("div",ye,[d("div",he,[i(w,{size:"small",onClick:r.viewDetails},{default:c(()=>[i(_,null,{default:c(()=>[i(h),a[1]||(a[1]=v(" ",-1))]),_:1}),v(" "+u(r.t("orderManagement.actions.view")),1)]),_:1},8,["onClick"]),"dzf"===r.statusType.type?(o(),p(w,{key:0,type:"primary",size:"small",onClick:r.handlePay,loading:r.isPaying,disabled:r.isExpired},{default:c(()=>[i(_,null,{default:c(()=>[i(C),a[2]||(a[2]=v(" ",-1))]),_:1}),v(" "+u(r.t("orderManagement.actions.pay")),1)]),_:1},8,["onClick","loading","disabled"])):m("",!0),"dzf"===r.statusType.type?(o(),p(w,{key:1,type:"danger",size:"small",onClick:r.handleCancel,loading:r.isCancelling},{default:c(()=>[i(_,null,{default:c(()=>[i(D),a[3]||(a[3]=v(" ",-1))]),_:1}),v(" "+u(r.t("orderManagement.actions.cancel")),1)]),_:1},8,["onClick","loading"])):m("",!0),"yfh"===r.statusType.type?(o(),p(w,{key:2,type:"success",size:"small",onClick:r.handleConfirm,loading:r.isConfirming},{default:c(()=>[i(_,null,{default:c(()=>[i(E)]),_:1}),v(" "+u(r.t("orderManagement.actions.confirm")),1)]),_:1},8,["onClick","loading"])):m("",!0)])])],2)}],["__scopeId","data-v-1b534b42"]]),we={PENDING:"pending",PROCESSING:"processing",SHIPPED:"shipped",CANCELLED:"cancelled",REFUNDED:"refunded"},Ce={[we.PENDING]:"待处理",[we.PROCESSING]:"处理中",[we.SHIPPED]:"已发货",[we.DELIVERED]:"已送达",[we.CANCELLED]:"已取消",[we.REFUNDED]:"已退款"},De=ee("orders",()=>{const e=y([]),a=y(null),t=y(!1),r=y(null),l=y({status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null}),s=y({currentPage:1,pageSize:10,total:0}),n=h(()=>{let a=[...e.value];if(l.value.status&&(a=a.filter(e=>e.status===l.value.status)),l.value.search){const e=l.value.search.toLowerCase();a=a.filter(a=>a.orderId?.toLowerCase().includes(e)||a.customerName?.toLowerCase().includes(e)||a.customerEmail?.toLowerCase().includes(e))}if(l.value.dateRange?.start&&l.value.dateRange?.end){const e=new Date(l.value.dateRange.start),t=new Date(l.value.dateRange.end);a=a.filter(a=>{const r=new Date(a.created_at);return r>=e&&r<=t})}return a.sort((e,a)=>{const{sortBy:t,sortOrder:r}=l.value;let s=e[t],n=a[t];return"created_at"!==t&&"updatedAt"!==t||(s=new Date(s).getTime(),n=new Date(n).getTime()),"string"==typeof s&&(s=s.toLowerCase(),n=n.toLowerCase()),"asc"===r?s>n?1:-1:s<n?1:-1}),a}),o=h(()=>{const{currentPage:e,pageSize:a}=s.value,t=(e-1)*a,r=t+a;return n.value.slice(t,r)}),d=h(()=>({total:e.value.length,pending:e.value.filter(e=>e.status===we.PENDING).length,processing:e.value.filter(e=>e.status===we.PROCESSING).length,shipped:e.value.filter(e=>e.status===we.SHIPPED).length,delivered:e.value.filter(e=>e.status===we.DELIVERED).length,cancelled:e.value.filter(e=>e.status===we.CANCELLED).length,refunded:e.value.filter(e=>e.status===we.REFUNDED).length,totalRevenue:e.value.filter(e=>e.status!==we.CANCELLED).reduce((e,a)=>e+(a.total||0),0)})),i=h(()=>n.value.length),u=a=>{e.value=a.map(e=>({...e,created_at:e.created_at||(new Date).toISOString(),updatedAt:e.updatedAt||(new Date).toISOString()})),s.value.total=e.value.length},c=(a,t)=>{const r=e.value.findIndex(e=>e.id===a);return-1!==r&&(e.value[r]={...e.value[r],...t,updatedAt:(new Date).toISOString()}),e.value[r]},v=a=>e.value.find(e=>e.id===a);return{orders:e,currentOrder:a,loading:t,error:r,filters:l,pagination:s,filteredOrders:n,paginatedOrders:o,orderStats:d,totalOrders:i,setOrders:u,addOrder:a=>{const t={...a,id:Date.now().toString(),created_at:(new Date).toISOString(),updatedAt:(new Date).toISOString(),status:a.status||we.PENDING};return e.value.unshift(t),s.value.total=e.value.length,t},updateOrder:c,deleteOrder:a=>{const t=e.value.findIndex(e=>e.id===a);return-1!==t&&(e.value.splice(t,1),s.value.total=e.value.length,!0)},getOrder:v,setCurrentOrder:e=>{a.value=e},updateOrderStatus:(a,t)=>c(a,{status:t,statusHistory:[...e.value.find(e=>e.id===a)?.statusHistory||[],{status:t,timestamp:(new Date).toISOString(),note:`状态更新为 ${Ce[t]}`}]}),updateFilters:e=>{l.value={...l.value,...e},s.value.currentPage=1},updatePagination:e=>{s.value={...s.value,...e}},resetFilters:()=>{l.value={status:null,search:"",sortBy:"created_at",sortOrder:"desc",dateRange:null},s.value.currentPage=1},getStatusHistory:e=>{const a=v(e);return a?.statusHistory||[]},exportOrders:(e="json")=>{const a=n.value;if("csv"===e){return[["订单ID","客户姓名","客户邮箱","状态","总金额","创建时间","更新时间"].join(","),...a.map(e=>[e.orderId||"",e.customerName||"",e.customerEmail||"",Ce[e.status]||"",e.total||0,e.created_at,e.updatedAt].join(","))].join("\n")}return JSON.stringify(a,null,2)},initSampleData:()=>{u([])}}},{persist:{key:"orders",storage:localStorage,paths:["filters","pagination"]}}),Ee={class:"order-management"},Se={class:"orders-section"},Oe={class:"filter-section"},be={class:"filter-row"},ke={class:"filter-group"},Ie={class:"filter-label"},Me={class:"status-filter"},Pe=["onClick"],xe={class:"filter-group"},Ne={class:"filter-label"},Le={class:"filter-group"},Re={class:"filter-label"},Ae={class:"orders-grid"},Te={key:0,class:"empty-state"},ze={class:"empty-icon"},Ve={class:"empty-title"},je={class:"empty-description"},Be={key:0,style:{height:"60px"}},Fe=e({__name:"OrderManagement",setup(e){const s=new K,{t:v}=f(),h=D(),C=De(),b=y("all"),k=Y("1"),I=y([{label:v("orderManagement.sort.created_at"),value:"created_at"},{label:v("orderManagement.sort.total"),value:"amount"}]),M=e=>{console.log(e),h.push({name:"order-detail",params:{orderId:e.id}})},P=e=>{if(console.log(e),t()){if(!e.order_info.pay_params)return void Q.error("当前订单不属于小程序订单");const a=r();return void l.BusWechartForNavigate("/pages/pay/pay",{method:"pay",payData:JSON.stringify({...e.order_info,token:a,amount:e.order_info.amount,order_no:e.order_no})})}window.location.href=e.stripe_url},x=e=>{J.confirm(v("orderManagement.confirm.message"),v("orderManagement.confirm.title"),{confirmButtonText:v("common.confirm"),cancelButtonText:v("common.cancel"),type:"warning"}).then(()=>{s.receiveAddress(e).then(e=>{le()})})},N=e=>{J.confirm(v("orderManagement.cancelConfirm.message"),v("orderManagement.cancelConfirm.title"),{confirmButtonText:v("common.confirm"),cancelButtonText:v("common.cancel"),type:"warning"}).then(()=>{s.orderCancel({id:e.id}).then(e=>{0===e.code?(Q.success(v("orderManagement.cancelSuccess")),le()):Q.error(e.message||v("orderManagement.cancelFail"))})}).catch(()=>{})},L=e=>{C.updateOrder(e,{status:"expired"})},R=y(1),A=y(10),T=y(""),z=y(!1),V=y(!1),j=y("created_at"),F=y("desc"),X=y([]),ee=y(0),ae=y({}),te=()=>{re()},re=()=>{V.value||(z.value=!0,s.getOrderList({page:R.value,page_size:A.value,order_no:T.value,sort_by:j.value,sort_order:F.value,...ae.value}).then(e=>{if(0==e.code){let a=e.data;1===R.value?X.value=a.items:X.value=[...X.value,...a.items],ee.value=a.total,V.value=X.value.length>=ee.value,R.value++}}))},le=()=>{z.value=!1,V.value=!1,X.value=[],R.value=1,A.value=10,re()};w(T,()=>{clearTimeout(window._orderNoDebounce),window._orderNoDebounce=setTimeout(()=>{le()},300)}),_(()=>{le()});return w(j,()=>{le()}),(e,t)=>{const r=B,l=U,s=W,f=H,y=q;return o(),p(y,{height:"100%",onEndReached:te},{default:c(()=>[d("div",Ee,[d("div",Se,[d("div",Oe,[d("div",be,[d("div",ke,[d("label",Ie,u(E(v)("orderManagement.filters.status")),1),d("div",Me,[(o(!0),n(S,null,O(E(k),e=>(o(),n("button",{key:e.key,class:g(["status-tab",{active:b.value===e.key}]),onClick:a=>(e=>{const a=Z(e);ae.value=a,b.value=e,le()})(e.key)},u(E(v)(e.label)),11,Pe))),128))])]),d("div",xe,[d("label",Ne,u(E(v)("orderManagement.filters.search")),1),i(l,{modelValue:T.value,"onUpdate:modelValue":t[0]||(t[0]=e=>T.value=e),placeholder:E(v)("orderManagement.searchPlaceholder"),class:"search-input",clearable:""},{prefix:c(()=>[i(r,null,{default:c(()=>[i(E(G))]),_:1})]),_:1},8,["modelValue","placeholder"])]),d("div",Le,[d("label",Re,u(E(v)("orderManagement.filters.sort")),1),i(f,{modelValue:j.value,"onUpdate:modelValue":t[1]||(t[1]=e=>j.value=e),class:"sort-select"},{default:c(()=>[(o(!0),n(S,null,O(I.value,e=>(o(),p(s,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),d("div",Ae,[(o(!0),n(S,null,O(X.value,e=>(o(),p(_e,{key:e.id,order:e,onViewDetails:M,onPayOrder:P,onCancelOrder:N,onExpiredOrder:L,onConfirmOrder:x},null,8,["order"]))),128))]),0===X.value.length?(o(),n("div",Te,[d("div",ze,[i(r,null,{default:c(()=>[i(E($))]),_:1})]),d("h3",Ve,u(E(v)("orderManagement.empty.title")),1),d("p",je,u(E(v)("orderManagement.empty.description")),1)])):m("",!0)])]),E(a).isPortraitDevice()?(o(),n("div",Be)):m("",!0)]),_:1})}}},[["__scopeId","data-v-233a0998"]]);export{Fe as default};
