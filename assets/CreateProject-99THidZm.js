import{g as e,r as t,f as s,c as n,j as a,n as r,z as i,A as o,B as l,L as c,P as u,u as h,E as d,K as p,ai as m,W as f,aJ as g,Q as v,a5 as y,D as x,R as w,J as b,O as T,ax as _,ah as M,I,X as A,aA as k,U as R,T as C,al as E,aB as S}from"./vendor-p2oL7ibe.js";import{_ as D,u as P,f as L,F as N,L as O,T as U}from"./index-CqnzwUr8.js";import{y as F,d as j,aC as z,E as B,aA as H,aD as V,a9 as X,I as G,av as K,aE as W,aF as Y,U as $,S as q,O as Z,ar as J,C as Q,_ as ee,ag as te,aG as se,aH as ne,aI as ae}from"./elementPlus-DzXnjnIh.js";/* empty css                         */import{T as re,o as ie,p as oe,L as le,q as ce,r as ue,s as he,b as de,C as pe,t as me,u as fe,v as ge,a as ve,D as ye,w as xe,V as we,I as be,Q as Te,x as _e,O as Me,y as Ie,z as Ae,c as ke,H as Re,J as Ce,N as Ee,K as Se,U as De,X as Pe,Y as Le,Z as Ne,_ as Oe,$ as Ue,d as Fe,a0 as je,a1 as ze,M as Be,a2 as He,j as Ve,a3 as Xe,B as Ge,a4 as Ke,g as We,a5 as Ye,a6 as $e,a7 as qe,f as Ze,G as Je,P as Qe,n as et,a8 as tt,a9 as st,aa as nt,ab as at,ac as rt,ad as it,ae as ot,af as lt,ag as ct,ah as ut,ai as ht,aj as dt,k as pt,ak as mt,al as ft,am as gt,an as vt,ao as yt,ap as xt,aq as wt,ar as bt,A as Tt,as as _t,at as Mt,au as It,av as At,m as kt,aw as Rt,ax as Ct,ay as Et,az as St,aA as Dt,aB as Pt,aC as Lt,aD as Nt,aE as Ot,aF as Ut,aG as Ft,aH as jt,S as zt,W as Bt,aI as Ht,aJ as Vt}from"./three.module-0ChKueQ8.js";import{M as Xt,a as Gt,D as Kt,O as Wt,P as Yt}from"./passiveEventListeners-CgHngG4-.js";import{P as $t}from"./index-8W7GiA4S.js";import{M as qt}from"./index-CxyUPh15.js";/* empty css                     *//* empty css                    *//* empty css                 */import"./payserver-DjflAOZ_.js";/* empty css                                                                          */import"./index-BA7DGyF7.js";const Zt={class:"floating-sidebar"},Jt={class:"expression-info"},Qt={class:"expression-description"},es={class:"ip-type-grid"},ts={class:"ip-type-label"},ss={class:"ip-type-label"},ns={key:0,class:"form-section"},as={class:"expression-info"},rs={class:"expression-description"},is={class:"hook-selection"},os={class:"hook-label"},ls={class:"hook-label"},cs={class:"expression-info"},us={class:"expression-description"},hs={class:"prompt-input-container"},ds={class:"textarea-wrapper"},ps=["placeholder","disabled"],ms={key:0,class:"scan-overlay"},fs=["disabled"],gs={class:"expression-info"},vs={class:"expression-description"},ys={key:0,class:"image-preview"},xs=["src"],ws={key:1,class:"upload-progress"},bs={key:2,class:"upload-prompt"},Ts={class:"upload-text"},_s={class:"drag-text"},Ms={key:4,class:"form-section"},Is={class:"section-label"},As={class:"color-selection"},ks={class:"color-info"},Rs={class:"color-description"},Cs={class:"color-grid"},Es=["onClick"],Ss={key:0,class:"color-selected"},Ds={class:"color-details"},Ps={class:"color-name"},Ls={class:"color-hex"},Ns={key:6,class:"form-section"},Os={class:"section-label"},Us={class:"sketch-selection"},Fs={class:"sketch-info"},js={class:"sketch-description"},zs={class:"sketch-grid"},Bs=["onClick"],Hs={class:"sketch-preview"},Vs=["src","alt"],Xs={class:"sketch-details"},Gs={class:"sketch-name"},Ks={class:"sketch-proportions"},Ws={key:0,class:"sketch-selected"},Ys=D({__name:"index",props:{Info:{type:Object,default:()=>({})},series:{type:String,default:"E1"},locale:{type:String,default:"en"}},emits:["image-generated","model-generated","generate-requested","import-character","navigate-back","updateProjectInfo","hook-selected"],setup(_,{expose:M,emit:I}){P();const A=new N,k=I,R=_,{proxy:C}=e(),E=C.$t,S=t({prompt:"",previewImage:""}),D=t(null),O=t(null),U=t(1),z=t(!1),B=t(!1),H=t(!1),V=t(null),X=t(null),G=t(null),K=t(null),W=t(1),Y=e=>{W.value=e},$=t(!0),q=e=>{$.value=e,k("hook-selected",e)},Z=t(null),J=t([{id:"nano_banana",name:"Nano Banana",description:"å¿«é€Ÿç”Ÿæˆ",model:"gemini-2.5-flash-image"},{id:"nano_banana_pro",name:"Nano Banana Pro",description:"é«˜è´¨é‡ç”Ÿæˆ",model:"gemini-3-pro-image-preview"},{id:"doubao",name:"Doubao",description:"è±†åŒ…æ¨¡åž‹",model:"doubao"},{id:"qwimg",name:"QwImg",description:"é€šä¹‰åƒé—®",model:"ali"}]),Q=t(null),ee=t(null),te=t(null),se=t(null);t(null),t(null),t(null),t([]);const ne=new L,ae=async()=>{z.value=!0;const e=await ne.handleOptimizePrompt(S.value.prompt,{type:"OBJECT",properties:{name:{type:"STRING",description:"è§’è‰²çš„åç§°"},gender:{type:"STRING",description:"è§’è‰²çš„æ€§åˆ«"},type:{type:"STRING",description:`è§’è‰²çš„ç±»åž‹ï¼Œ${1==W.value?"äººç‰©":"åŠ¨ç‰©"}}`},appearance:{type:"STRING",description:"è§’è‰²çš„å¤–è§‚æè¿°ï¼Œå¦‚æžœæè¿°åˆ°äº†é¢œè‰²ç›¸å…³çš„ï¼Œç»Ÿä¸€ç”¨æµ…ç±³è‰²æˆ–æµ…å¡å…¶è‰²ï¼Œä¸å°‘äºŽ50å­—æ•°"}},required:["name","gender","appearance"]},R.locale,S.value.previewImage);if(z.value=!1,e){const t=E("iPandCardLeft.optimizedPrompt.name"),s=E("iPandCardLeft.optimizedPrompt.gender"),n=E("iPandCardLeft.optimizedPrompt.appearance");S.value.prompt=`${t}: ${e.name}\n${s}: ${e.gender}\n${n}: ${e.appearance}`}};t(""),s(()=>{(()=>{try{const e=localStorage.getItem("selectedModelId");Z.value=e||J.value[0].id}catch(e){Z.value=J.value[0].id}})(),pe()});const re=t({metal_brushed:[{id:"silver",name:"Silver",hex:"#C0C0C0",description:"Classic silver metallic"},{id:"gold",name:"Gold",hex:"#FFD700",description:"Luxurious gold finish"},{id:"copper",name:"Copper",hex:"#B87333",description:"Warm copper tone"},{id:"titanium",name:"Titanium",hex:"#878681",description:"Modern titanium gray"},{id:"bronze",name:"Bronze",hex:"#CD7F32",description:"Antique bronze"},{id:"steel",name:"Steel",hex:"#71797E",description:"Industrial steel gray"}],plastic_matte:[{id:"white",name:"White",hex:"#FFFFFF",description:"Pure white"},{id:"black",name:"Black",hex:"#2C2C2C",description:"Deep black"},{id:"red",name:"Red",hex:"#E53E3E",description:"Vibrant red"},{id:"blue",name:"Blue",hex:"#3182CE",description:"Ocean blue"},{id:"green",name:"Green",hex:"#38A169",description:"Forest green"},{id:"yellow",name:"Yellow",hex:"#D69E2E",description:"Sunny yellow"},{id:"purple",name:"Purple",hex:"#805AD5",description:"Royal purple"},{id:"orange",name:"Orange",hex:"#DD6B20",description:"Bright orange"}],carbon_fiber:[{id:"carbon_black",name:"Carbon Black",hex:"#1A1A1A",description:"Classic carbon black"},{id:"carbon_gray",name:"Carbon Gray",hex:"#4A4A4A",description:"Lighter carbon gray"},{id:"carbon_blue",name:"Carbon Blue",hex:"#1E3A8A",description:"Blue carbon weave"},{id:"carbon_red",name:"Carbon Red",hex:"#991B1B",description:"Red carbon accent"}],wood_natural:[{id:"oak",name:"Oak",hex:"#DEB887",description:"Natural oak wood"},{id:"walnut",name:"Walnut",hex:"#8B4513",description:"Rich walnut brown"},{id:"maple",name:"Maple",hex:"#F5DEB3",description:"Light maple wood"},{id:"cherry",name:"Cherry",hex:"#A0522D",description:"Cherry wood red"},{id:"mahogany",name:"Mahogany",hex:"#C04000",description:"Deep mahogany"},{id:"pine",name:"Pine",hex:"#FFEAA7",description:"Light pine wood"}],ceramic_glossy:[{id:"ceramic_white",name:"Ceramic White",hex:"#FAFAFA",description:"Pure ceramic white"},{id:"ceramic_cream",name:"Cream",hex:"#FFF8DC",description:"Warm cream ceramic"},{id:"ceramic_blue",name:"Ceramic Blue",hex:"#4FC3F7",description:"Sky blue ceramic"},{id:"ceramic_green",name:"Ceramic Green",hex:"#81C784",description:"Mint green ceramic"},{id:"ceramic_pink",name:"Ceramic Pink",hex:"#F48FB1",description:"Soft pink ceramic"}],fabric_soft:[{id:"fabric_beige",name:"Beige",hex:"#F5F5DC",description:"Natural beige fabric"},{id:"fabric_gray",name:"Gray",hex:"#808080",description:"Neutral gray fabric"},{id:"fabric_navy",name:"Navy",hex:"#000080",description:"Deep navy fabric"},{id:"fabric_burgundy",name:"Burgundy",hex:"#800020",description:"Rich burgundy fabric"},{id:"fabric_olive",name:"Olive",hex:"#808000",description:"Olive green fabric"},{id:"fabric_cream",name:"Cream",hex:"#FFFDD0",description:"Soft cream fabric"}]});t([{id:"arduino_uno",name:"D1 Mini",icon:"ðŸ”Œ",category:"microcontroller",compatibility:["basic","intermediate","advanced"]},{id:"raspberry_pi",name:"D1 Plus Pi",icon:"ðŸ”Œ",category:"computer",compatibility:["intermediate","advanced"]}]);const ie=n(()=>Q.value&&sketchDatabase.value[Q.value.id]||[]),oe=n(()=>te.value&&re.value[te.value.id]||[]);t(null);const le=()=>{const e=[];return S.value.previewImage||S.value.prompt||e.push(E("common.validation.referenceImageRequired")),{errors:e,warnings:[]}},ce=n(()=>le().errors.length>0),ue=(e,t="")=>{let s="æ“ä½œå¤±è´¥";e.message&&(s=e.message.includes("network")||e.message.includes("fetch")?"ç½‘ç»œè¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåŽé‡è¯•":e.message.includes("timeout")?"è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åŽé‡è¯•":e.message.includes("quota")||e.message.includes("limit")?"å·²è¾¾åˆ°ä½¿ç”¨é™åˆ¶ï¼Œè¯·ç¨åŽé‡è¯•":e.message.includes("format")||e.message.includes("invalid")?"è¾“å…¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åŽé‡è¯•":`æ“ä½œå¤±è´¥: ${e.message}`),j.error(s)},he=async()=>{const e=le();if(e.errors.length>0)(e=>{if(e.length>0){const t="string"==typeof e[0]?e[0]:String(e[0]);j.error(t)}})(e.errors);else try{await de()}catch(t){ue(t,"å›¾åƒç”Ÿæˆ")}},de=async()=>{try{const e={profile:{appearance:S.value.prompt},inspirationImage:S.value.previewImage,count:U.value,ipType:W.value,needHook:$.value};k("generate-requested",e)}catch(e){ue(e,"å¤šå›¾åƒè§’è‰²æ¡£æ¡ˆåˆ›å»º")}},pe=()=>{if(D.value){D.value.style.height="auto";const e=40,t=300,s=D.value.scrollHeight,n=Math.max(e,Math.min(t,s));D.value.style.height=n+"px",D.value.style.overflowY=s>t?"auto":"hidden"}},me=()=>{O.value?.click()},fe=async e=>{const t=e.target.files?.[0];if(t){H.value=!0;try{const e=await A.uploadFile(t);S.value.previewImage=e,window?.closeMethods.close()}catch(s){j.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•"),window?.closeMethods.close()}finally{H.value=!1}}},ge=()=>{S.value.previewImage="",O.value&&(O.value.value="")},ve=e=>{e.preventDefault(),e.stopPropagation()},ye=e=>{e.preventDefault(),e.stopPropagation(),B.value=!0},xe=e=>{e.preventDefault(),e.stopPropagation(),e.target===e.currentTarget&&(B.value=!1)},we=async e=>{e.preventDefault(),e.stopPropagation(),B.value=!1;const t=e.dataTransfer.files;if(t&&t.length>0){const e=t[0];if(e.type.startsWith("image/")){H.value=!0;try{const t=await A.uploadFile(e);S.value.previewImage=t}catch(s){j.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{H.value=!1}}else j.error("è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶")}};return a(()=>S.value.prompt,()=>{r(()=>{pe()})}),M({ipTypeSectionRef:V,textPromptSectionRef:X,referenceImageSectionRef:G,generateButtonRef:K}),(e,t)=>{const s=F;return o(),i("aside",Zt,[l("div",{class:"form-section",ref_key:"ipTypeSectionRef",ref:V},[l("div",Jt,[l("span",Qt,u(h(E)("iPandCardLeft.ipType")),1)]),l("div",es,[l("div",{class:d(["ip-type-card",{active:1===W.value}]),onClick:t[0]||(t[0]=e=>Y(1))},[l("div",ts,u(h(E)("iPandCardLeft.character")),1)],2),l("div",{class:d(["ip-type-card",{active:2===W.value}]),onClick:t[1]||(t[1]=e=>Y(2))},[l("div",ss,u(h(E)("iPandCardLeft.animal")),1)],2)])],512),"E1"===_.series||"A1"===_.series?(o(),i("div",ns,[l("div",as,[l("span",rs,u(h(E)("iPandCardLeft.needHook")),1)]),l("div",is,[l("div",{class:d(["hook-option",{active:!0===$.value}]),onClick:t[2]||(t[2]=e=>q(!0))},[l("div",os,u(h(E)("common.yes")),1)],2),l("div",{class:d(["hook-option",{active:!1===$.value}]),onClick:t[3]||(t[3]=e=>q(!1))},[l("div",ls,u(h(E)("common.no")),1)],2)])])):c("",!0),c("",!0),c("",!0),l("div",{class:"form-section",ref_key:"textPromptSectionRef",ref:X},[l("div",cs,[l("span",us,u(h(E)("iPandCardLeft.textPrompt")),1)]),l("div",hs,[l("div",ds,[p(l("textarea",{class:"prompt-input custom-scrollbar",placeholder:h(E)("iPandCardLeft.placeholder.characterDescription"),"onUpdate:modelValue":t[5]||(t[5]=e=>S.value.prompt=e),ref_key:"textareaRef",ref:D,disabled:z.value},null,8,ps),[[m,S.value.prompt]]),z.value?(o(),i("div",ms,[...t[7]||(t[7]=[l("div",{class:"scan-line"},null,-1)])])):c("",!0),l("button",{class:"optimizer-btn",onClick:ae,disabled:z.value},[...t[8]||(t[8]=[l("span",{class:"btn-icon"},"ðŸª„",-1)])],8,fs)])])],512),l("div",{class:"form-section",ref_key:"referenceImageSectionRef",ref:G},[l("div",gs,[l("span",vs,u(h(E)("iPandCardLeft.addReferenceImage")),1)]),l("div",{class:d(["image-upload-area",{"drag-over":B.value,uploading:H.value}]),onClick:me,onDragover:f(ve,["prevent"]),onDragenter:f(ye,["prevent"]),onDragleave:f(xe,["prevent"]),onDrop:f(we,["prevent"])},[S.value.previewImage&&!H.value?(o(),i("div",ys,[l("img",{src:S.value.previewImage.replace("draft-user.s3.us-east-2.amazonaws.com","dcts99982ui0s.cloudfront.net"),alt:"Selected image"},null,8,xs),l("button",{class:"remove-image",onClick:f(ge,["stop"])},"Ã—")])):H.value?(o(),i("div",ws,[...t[9]||(t[9]=[g('<div class="upload-spinner" data-v-c40234da><div class="spinner-ring" data-v-c40234da></div><div class="spinner-ring" data-v-c40234da></div><div class="spinner-ring" data-v-c40234da></div></div><div class="upload-progress-text" data-v-c40234da>loading...</div>',2)])])):(o(),i("div",bs,[t[10]||(t[10]=l("div",{class:"upload-icon"},"+",-1)),l("span",Ts,u(h(E)("iPandCardLeft.uploadOrSelectImage")),1),l("span",_s,u(h(E)("iPandCardLeft.dragImageHere")),1)])),l("input",{ref_key:"fileInput",ref:O,type:"file",accept:"image/*",onChange:fe,class:"hidden-file-input"},null,544)],34)],512),c("",!0),te.value?(o(),i("div",Ms,[l("label",Is,u(h(E)("iPandCardLeft.color.title")),1),l("div",As,[l("div",ks,[l("span",Rs,u(h(E)("iPandCardLeft.color.description",{material:te.value.name})),1)]),l("div",Cs,[(o(!0),i(v,null,y(oe.value,e=>(o(),i("div",{key:e.id,class:d(["color-card",{active:se.value?.id===e.id}]),onClick:t=>(e=>{se.value?.id===e.id?se.value=null:se.value=e})(e)},[l("div",{class:"color-preview",style:x({backgroundColor:e.hex})},[se.value?.id===e.id?(o(),i("div",Ss,"âœ“")):c("",!0)],4),l("div",Ds,[l("div",Ps,u(e.name),1),l("div",Ls,u(e.hex),1)])],10,Es))),128))])])])):c("",!0),c("",!0),Q.value?(o(),i("div",Ns,[l("label",Os,u(h(E)("iPandCardLeft.sketch.title")),1),l("div",Us,[l("div",Fs,[l("span",js,u(h(E)("iPandCardLeft.sketch.description",{module:Q.value.name})),1)]),l("div",zs,[(o(!0),i(v,null,y(ie.value,e=>(o(),i("div",{key:e.id,class:d(["sketch-card",{active:ee.value?.id===e.id}]),onClick:t=>(e=>{ee.value?.id===e.id?ee.value=null:ee.value=e})(e)},[l("div",Hs,[e.imageUrl?(o(),i("img",{key:0,src:e.imageUrl,alt:e.name},null,8,Vs)):c("",!0)]),l("div",Xs,[l("div",Gs,u(e.name),1),l("div",Ks,u(e.proportions),1)]),ee.value?.id===e.id?(o(),i("div",Ws,"âœ“")):c("",!0)],10,Bs))),128))])])])):c("",!0),c("",!0),l("div",{class:"generate-section",ref_key:"generateButtonRef",ref:K},[w(s,{type:"primary",class:"generate-btn",onClick:he,disabled:ce.value},{default:b(()=>[T(u(h(E)("common.generate")),1)]),_:1},8,["disabled"])],512)])}}},[["__scopeId","data-v-c40234da"]]),$s="å°†çŽ©å¶æ”¾åœ¨æ¡Œå­çŽ»ç’ƒæ­£ä¸­é—´ä¸Šï¼ŒåŽŸå›¾æ”¾åœ¨å›¾ä¸­æ¡Œé¢ä¸Šçš„ç›¸æ¡†é‡Œé¢[CJT_DEOTA]",qs={class:"ip-card-wrapper"},Zs={key:0,class:"text-input-overlay",role:"dialog","aria-modal":"true","aria-label":"æ–‡æœ¬è¾“å…¥"},Js={class:"text-input-container"},Qs={class:"text-input-header"},en={class:"text-input-title"},tn=["placeholder","onKeydown"],sn={class:"text-input-actions"},nn={key:0,class:"top-controls-container"},an={class:"top-controls"},rn={class:"control-text"},on={class:"control-text"},ln={class:"control-text"},cn={class:"control-text"},un={class:"control-text"},hn={class:"control-text"},dn=D({__name:"index",props:{combinedPromptJson:{type:Object,default:()=>({})},imageUrl:{type:String,default:""},cardWidth:{type:Number,default:200},showBorder:{type:Boolean,default:!0},borderRadius:{type:Number,default:8},cardData:{type:Object,default:()=>({})},generateFourView:{type:Boolean,default:!1},series:{type:String,default:"D1"}},emits:["generate-model-requested","create-new-card","create-prompt-card","delete","preview-image","customize-to-home","handlePartialEdit","download-image","delete-card"],setup(e,{emit:a}){const{t:g}=_(),v=t({internalImageUrl:"",status:"loading"}),y=t(!1),T=t(!1),A=new L,k=t(9/16),R=t(!1),C=t(""),E=t(null),S=()=>{Q("preview-image",v.value.internalImageUrl)},D=()=>{R.value=!R.value,R.value&&(C.value="",r(()=>{E.value&&E.value.focus()}))},P=()=>{Q("create-prompt-card",{img:v.value.internalImageUrl||"",imgyt:J?.cardData?.inspirationImage||"",diyPromptText:$s,cardData:J.cardData})},N=()=>{Q("customize-to-home",{imageUrl:v.value.internalImageUrl,cardData:J.cardData})},O=()=>{C.value.trim()&&(Q("create-prompt-card",{img:v.value.internalImageUrl,diyPromptText:C.value,generateFourView:J.generateFourView,cardData:J.cardData}),R.value=!1,C.value="")},U=()=>{R.value=!1,C.value=""},F=()=>{y.value=!0,y.value&&(T.value=!0)},Z=()=>{y.value=!1,setTimeout(()=>{T.value=!1},3e3)},J=e,Q=a,ee=()=>{Q("handlePartialEdit",v.value.internalImageUrl)},te=()=>{Q("delete-card")},se=async()=>{Q("download-image",v.value.internalImageUrl)},ne=async(e,t)=>{A.getTaskGinimi(e,t,s=>{let n=s.splice(0,1)[0];v.value.internalImageUrl=n.url,re({taskId:e,taskQueue:t})},()=>{j.error("Failed to generate image, please try again later."),Q("delete")})},ae=()=>{J.cardData.imageUrl?v.value.internalImageUrl=J.cardData.imageUrl:J.cardData.taskId&&J.cardData.taskQueue?ne(J.cardData.taskId,J.cardData.taskQueue):(async()=>{const e=J?.cardData?.diyPromptText&&-1!=J?.cardData?.diyPromptText?.indexOf("[CJT_DEOTA]");try{let t,s=[];J?.cardData?.inspirationImage&&s.push(J.cardData.inspirationImage),e&&(J.cardData.imgyt&&s.push(J.cardData.imgyt),s.push(J.cardData.diyPromptImg),s.push({D1:"https://draft-user.s3.us-east-2.amazonaws.com/images/14f98f33-06a7-4629-a42e-d7cfbced786f",E1:"https://draft-user.s3.us-east-2.amazonaws.com/images/23130608-283e-41c3-bb28-8f2492f5e233.png"}[J.series])),(J.cardData.diyPromptText||J.cardData.addDiyPromptImg)&&s.push(J.cardData.diyPromptImg),1==J?.cardData?.ipType?(t=J.combinedPromptJson.person.content,s.push(...J.combinedPromptJson.person.imgs)):2==J?.cardData?.ipType&&(t=J.combinedPromptJson.animal.content,s.push(...J.combinedPromptJson.animal.imgs)),J.cardData.prompt&&(t=`è§’è‰²å¤–è§‚ï¼š${J.cardData.prompt}.${t}`);let n=J.cardData.diyPromptText||t;if(J.cardData.prompt&&-1!=J.cardData.prompt.indexOf("nospec"))return n="æŒ‰åŽŸå›¾ç”Ÿæˆ",s=[J.cardData.inspirationImage],void(v.value.internalImageUrl=J?.cardData?.inspirationImage);const a=await A.handleGenerateImage(s,n,{project_id:J.cardData.project_id,aspect_ratio:e?"16:9":"9:16"});return re(a),void ne(a.taskId,a.taskQueue)}catch(t){Q("delete")}})()},re=e=>{Q("save-project",{imageUrl:v.value.internalImageUrl,taskId:e?.taskId||"",taskQueue:e?.taskQueue||"",status:"success"})};s(async()=>{ae()});const ie=n(()=>{const e=k.value>1?400:J.cardWidth;return{width:`${e}px`,height:`${e/k.value}px`,borderRadius:`${J.borderRadius}px`,border:J.showBorder?"1px solid #e0e0e0":"none"}}),oe=e=>{},le=e=>{const t=e.target,s=t.naturalWidth,n=t.naturalHeight;s>0&&n>0&&(k.value=s/n)};return(e,t)=>{const s=V;return o(),i("div",{class:d(["ip-card-container",{"controls-visible":T.value}]),onTouchstart:F,onTouchend:Z},[l("div",qs,[R.value?(o(),i("div",Zs,[l("div",Js,[l("div",Qs,[l("div",en,u(h(g)("modelModal.textInputTitle")),1),l("button",{class:"text-input-close",onClick:U,onTouchend:f(U,["prevent"]),"aria-label":"å…³é—­"},[w(h(B),{class:"close-icon"},{default:b(()=>[w(h(z))]),_:1})],32)]),p(l("textarea",{ref_key:"textInputRef",ref:E,"onUpdate:modelValue":t[0]||(t[0]=e=>C.value=e),class:"text-input-area",placeholder:h(g)("modelModal.textInputPlaceholder"),rows:"4",onKeydown:[M(f(O,["ctrl"]),["enter"]),M(U,["esc"])],onClick:t[1]||(t[1]=f(()=>{},["stop"])),onMousedown:t[2]||(t[2]=f(()=>{},["stop"]))},null,40,tn),[[m,C.value]]),l("div",sn,[l("button",{class:"text-input-btn cancel-btn",onClick:U,onTouchend:f(U,["prevent"])},u(h(g)("common.cancel")),33),l("button",{class:"text-input-btn confirm-btn",onClick:O,onTouchend:f(O,["prevent"])},u(h(g)("common.confirm")),33)])])])):c("",!0),l("div",{class:"ip-card",style:x(ie.value)},[v.value.internalImageUrl?(o(),I(h(H),{key:0,src:v.value.internalImageUrl.replace("draft-user.s3.us-east-2.amazonaws.com","dcts99982ui0s.cloudfront.net"),onContextmenu:t[3]||(t[3]=f(()=>{},["prevent"])),alt:"IP",class:"ip-card-image",teleported:!0,onError:oe,onLoad:le},null,8,["src"])):(o(),I(h(X),{key:1,style:{width:"100%",height:"100%"},animated:""},{template:b(()=>[w(s,{variant:"image",style:{width:"100%",height:"100%"}})]),_:1})),v.value.internalImageUrl&&J.cardData.diyPromptText!=h($s)?(o(),i("button",{key:2,class:"customize-to-home-btn",onClick:N,onTouchend:f(N,["prevent"])},u(h(g)("modelModal.customizeToHome")),33)):c("",!0)],4)]),v.value.internalImageUrl?(o(),i("div",nn,[l("div",an,[l("button",{class:"control-item",title:"Preview Image",onClick:S,onTouchend:f(S,["prevent"])},[l("span",rn,u(h(g)("modelModal.preview")),1),w(h(B),{class:"control-icon"},{default:b(()=>[w(h(G))]),_:1})],32),J.cardData.diyPromptText!=h($s)?(o(),i("button",{key:0,class:"control-item",title:"textInput",onClick:D,onTouchend:f(D,["prevent"])},[l("span",on,u(h(g)("modelModal.modify")),1),w(h(B),{class:"control-icon"},{default:b(()=>[w(h(K))]),_:1})],32)):c("",!0),J.cardData.diyPromptText!=h($s)?(o(),i("button",{key:1,class:"control-item",title:"Picture board editor",onClick:ee,onTouchend:f(ee,["prevent"])},[l("span",ln,u(h(g)("modelModal.edit")),1),w(h(B),{class:"control-icon"},{default:b(()=>[w(h(W))]),_:1})],32)):c("",!0),J.cardData.diyPromptText!=h($s)?(o(),i("button",{key:2,class:"control-item",title:"scene graph",onClick:P,onTouchend:f(P,["prevent"])},[l("span",cn,u(h(g)("modelModal.sceneGraph")),1),w(h(B),{class:"control-icon"},{default:b(()=>[w(h(Y))]),_:1})],32)):c("",!0),l("button",{class:"control-item",title:"Download",onClick:se,onTouchend:f(se,["prevent"])},[l("span",un,u(h(g)("modelModal.download")),1),w(h(B),{class:"control-icon"},{default:b(()=>[w(h($))]),_:1})],32),l("button",{class:"control-item",title:"Delete",onClick:te,onTouchend:f(te,["prevent"])},[l("span",hn,u(h(g)("common.close")),1),w(h(B),{class:"control-icon"},{default:b(()=>[w(h(q))]),_:1})],32)])])):c("",!0)],34)}}},[["__scopeId","data-v-9f879e99"]]);function pn(e,t){if(t===re)return e;if(t===ie||t===oe){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,a=[];if(t===ie)for(let e=1;e<=n;e++)a.push(s.getX(0)),a.push(s.getX(e)),a.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(a.push(s.getX(e)),a.push(s.getX(e+1)),a.push(s.getX(e+2))):(a.push(s.getX(e+2)),a.push(s.getX(e+1)),a.push(s.getX(e)));a.length;const r=e.clone();return r.setIndex(a),r.clearGroups(),r}return e}class mn extends le{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new wn(e)}),this.register(function(e){return new bn(e)}),this.register(function(e){return new En(e)}),this.register(function(e){return new Sn(e)}),this.register(function(e){return new Dn(e)}),this.register(function(e){return new _n(e)}),this.register(function(e){return new Mn(e)}),this.register(function(e){return new In(e)}),this.register(function(e){return new An(e)}),this.register(function(e){return new xn(e)}),this.register(function(e){return new kn(e)}),this.register(function(e){return new Tn(e)}),this.register(function(e){return new Cn(e)}),this.register(function(e){return new Rn(e)}),this.register(function(e){return new vn(e)}),this.register(function(e){return new Pn(e)}),this.register(function(e){return new Ln(e)})}load(e,t,s,n){const a=this;let r;if(""!==this.resourcePath)r=this.resourcePath;else if(""!==this.path){const t=ce.extractUrlBase(e);r=ce.resolveURL(t,this.path)}else r=ce.extractUrlBase(e);this.manager.itemStart(e);const i=function(t){n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)},o=new ue(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(s){try{a.parse(s,r,function(s){t(s),a.manager.itemEnd(e)},i)}catch(n){i(n)}},s,i)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let a;const r={},i={},o=new TextDecoder;if("string"==typeof e)a=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===Nn){try{r[gn.KHR_BINARY_GLTF]=new Fn(e)}catch(c){return void(n&&n(c))}a=JSON.parse(r[gn.KHR_BINARY_GLTF].content)}else a=JSON.parse(o.decode(e))}else a=e;if(void 0===a.asset||a.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new ua(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const e=this.pluginCallbacks[u](l);e.name,i[e.name]=e,r[e.name]=!0}if(a.extensionsUsed)for(let u=0;u<a.extensionsUsed.length;++u){const e=a.extensionsUsed[u],t=a.extensionsRequired||[];switch(e){case gn.KHR_MATERIALS_UNLIT:r[e]=new yn;break;case gn.KHR_DRACO_MESH_COMPRESSION:r[e]=new jn(a,this.dracoLoader);break;case gn.KHR_TEXTURE_TRANSFORM:r[e]=new zn;break;case gn.KHR_MESH_QUANTIZATION:r[e]=new Bn;break;default:t.indexOf(e)>=0&&i[e]}}l.setExtensions(r),l.setPlugins(i),l.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,a){s.parse(e,t,n,a)})}}function fn(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const gn={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class vn{constructor(e){this.parser=e,this.name=gn.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const a=t.json,r=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e];let i;const o=new pe(16777215);void 0!==r.color&&o.setRGB(r.color[0],r.color[1],r.color[2],me);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":i=new ye(o),i.target.position.set(0,0,-1),i.add(i.target);break;case"point":i=new ve(o),i.distance=l;break;case"spot":i=new ge(o),i.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,i.angle=r.spot.outerConeAngle,i.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return i.position.set(0,0,0),aa(i,r),void 0!==r.intensity&&(i.intensity=r.intensity),i.name=t.createUniqueName(r.name||"light_"+e),n=Promise.resolve(i),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then(function(e){return s._getNodeRef(t.cache,a,e)})}}let yn=class{constructor(){this.name=gn.KHR_MATERIALS_UNLIT}getMaterialType(){return Ve}extendParams(e,t,s){const n=[];e.color=new pe(1,1,1),e.opacity=1;const a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){const t=a.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],me),e.opacity=t[3]}void 0!==a.baseColorTexture&&n.push(s.assignTexture(e,"map",a.baseColorTexture,fe))}return Promise.all(n)}},xn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}},wn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&a.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&a.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(a.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new de(e,e)}return Promise.all(a)}},bn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=void 0!==n.dispersion?n.dispersion:0,Promise.resolve()}},Tn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];return void 0!==r.iridescenceFactor&&(t.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&a.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(t.iridescenceIOR=r.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&a.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(a)}},_n=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[];t.sheenColor=new pe(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=n.extensions[this.name];if(void 0!==r.sheenColorFactor){const e=r.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],me)}return void 0!==r.sheenRoughnessFactor&&(t.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&a.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,fe)),void 0!==r.sheenRoughnessTexture&&a.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(a)}},Mn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)}},In=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];t.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&a.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const i=r.attenuationColor||[1,1,1];return t.attenuationColor=(new pe).setRGB(i[0],i[1],i[2],me),Promise.all(a)}},An=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}},kn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];t.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&a.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const i=r.specularColorFactor||[1,1,1];return t.specularColor=(new pe).setRGB(i[0],i[1],i[2],me),void 0!==r.specularColorTexture&&a.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,fe)),Promise.all(a)}},Rn=class{constructor(e){this.parser=e,this.name=gn.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];return t.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&a.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(a)}},Cn=class{constructor(e){this.parser=e,this.name=gn.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?he:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const a=[],r=n.extensions[this.name];return void 0!==r.anisotropyStrength&&(t.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(t.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&a.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(a)}};class En{constructor(e){this.parser=e,this.name=gn.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const a=n.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,a.source,r)}}class Sn{constructor(e){this.parser=e,this.name=gn.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,s=this.parser,n=s.json,a=n.textures[e];if(!a.extensions||!a.extensions[t])return null;const r=a.extensions[t],i=n.images[r.source];let o=s.textureLoader;if(i.uri){const e=s.options.manager.getHandler(i.uri);null!==e&&(o=e)}return s.loadTextureImage(e,r.source,o)}}class Dn{constructor(e){this.parser=e,this.name=gn.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,s=this.parser,n=s.json,a=n.textures[e];if(!a.extensions||!a.extensions[t])return null;const r=a.extensions[t],i=n.images[r.source];let o=s.textureLoader;if(i.uri){const e=s.options.manager.getHandler(i.uri);null!==e&&(o=e)}return s.loadTextureImage(e,r.source,o)}}class Pn{constructor(e){this.name=gn.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(t){const s=e.byteOffset||0,n=e.byteLength||0,r=e.count,i=e.byteStride,o=new Uint8Array(t,s,n);return a.decodeGltfBufferAsync?a.decodeGltfBufferAsync(r,i,o,e.mode,e.filter).then(function(e){return e.buffer}):a.ready.then(function(){const t=new ArrayBuffer(r*i);return a.decodeGltfBuffer(new Uint8Array(t),r,i,o,e.mode,e.filter),t})})}return null}}let Ln=class{constructor(e){this.name=gn.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const o of n.primitives)if(o.mode!==Gn.TRIANGLES&&o.mode!==Gn.TRIANGLE_STRIP&&o.mode!==Gn.TRIANGLE_FAN&&void 0!==o.mode)return null;const a=s.extensions[this.name].attributes,r=[],i={};for(const o in a)r.push(this.parser.getDependency("accessor",a[o]).then(e=>(i[o]=e,i[o])));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,a=[];for(const r of s){const e=new xe,t=new we,s=new Te,o=new we(1,1,1),l=new be(r.geometry,r.material,n);for(let a=0;a<n;a++)i.TRANSLATION&&t.fromBufferAttribute(i.TRANSLATION,a),i.ROTATION&&s.fromBufferAttribute(i.ROTATION,a),i.SCALE&&o.fromBufferAttribute(i.SCALE,a),l.setMatrixAt(a,e.compose(t,s,o));for(const n in i)if("_COLOR_0"===n){const e=i[n];l.instanceColor=new _e(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&r.geometry.setAttribute(n,i[n]);Me.prototype.copy.call(l,r),this.parser.assignFinalMaterial(l),a.push(l)}return t.isGroup?(t.clear(),t.add(...a),t):a[0]}))}};const Nn="glTF",On=1313821514,Un=5130562;class Fn{constructor(e){this.name=gn.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Nn)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,a=new DataView(e,12);let r=0;for(;r<n;){const t=a.getUint32(r,!0);r+=4;const n=a.getUint32(r,!0);if(r+=4,n===On){const n=new Uint8Array(e,12+r,t);this.content=s.decode(n)}else if(n===Un){const s=12+r;this.body=e.slice(s,s+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class jn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=gn.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,i={},o={},l={};for(const c in r){const e=qn[c]||c.toLowerCase();i[e]=r[c]}for(const c in e.attributes){const t=qn[c]||c.toLowerCase();if(void 0!==r[c]){const n=s.accessors[e.attributes[c]],a=Kn[n.componentType];l[t]=a.name,o[t]=!0===n.normalized}}return t.getDependency("bufferView",a).then(function(e){return new Promise(function(t,s){n.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],n=o[t];void 0!==n&&(s.normalized=n)}t(e)},i,l,me,s)})})}}class zn{constructor(){this.name=gn.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Bn{constructor(){this.name=gn.KHR_MESH_QUANTIZATION}}class Hn extends mt{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,a=e*n*3+n;for(let r=0;r!==n;r++)t[r]=s[a+r];return t}interpolate_(e,t,s,n){const a=this.resultBuffer,r=this.sampleValues,i=this.valueSize,o=2*i,l=3*i,c=n-t,u=(s-t)/c,h=u*u,d=h*u,p=e*l,m=p-l,f=-2*d+3*h,g=d-h,v=1-f,y=g-h+u;for(let x=0;x!==i;x++){const e=r[m+x+i],t=r[m+x+o]*c,s=r[p+x+i],n=r[p+x]*c;a[x]=v*e+y*t+f*s+g*n}return a}}const Vn=new Te;class Xn extends Hn{interpolate_(e,t,s,n){const a=super.interpolate_(e,t,s,n);return Vn.fromArray(a).normalize().toArray(a),a}}const Gn={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Kn={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Wn={9728:Le,9729:Pe,9984:De,9985:Se,9986:Ee,9987:Ce},Yn={33071:Ue,33648:Oe,10497:Ne},$n={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},qn={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Zn={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Jn={CUBICSPLINE:void 0,LINEAR:it,STEP:rt},Qn="OPAQUE",ea="MASK",ta="BLEND";function sa(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new Be({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:pt})),e.DefaultMaterial}function na(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function aa(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function ra(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function ia(e){let t;const s=e.extensions&&e.extensions[gn.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+oa(s.attributes):e.indices+":"+oa(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,a=e.targets.length;n<a;n++)t+=":"+oa(e.targets[n]);return t}function oa(e){let t="";const s=Object.keys(e).sort();for(let n=0,a=s.length;n<a;n++)t+=s[n]+":"+e[s[n]]+";";return t}function la(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ca=new xe;class ua{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new fn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,a=!1,r=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);n=s&&t?parseInt(t[1],10):-1,a=e.indexOf("Firefox")>-1,r=a?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&n<17||a&&r<98?this.textureLoader=new Ie(this.options.manager):this.textureLoader=new Ae(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ue(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,a=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return na(a,r,n),aa(r,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(r)})).then(function(){for(const e of r.scenes)e.updateMatrixWorld();e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,a=t.length;n<a;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let n=0,a=e.length;n<a;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),a=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[n,r]of e.children.entries())a(r,t.children[n])};return a(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const a=e(t[n]);a&&s.push(a)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[gn.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(e,a){s.load(ce.resolveURL(t.uri,n.path),e,void 0,function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=$n[n.type],t=Kn[n.componentType],s=!0===n.normalized,a=new t(n.count*e);return Promise.resolve(new ke(a,e,s))}const a=[];return void 0!==n.bufferView?a.push(this.getDependency("bufferView",n.bufferView)):a.push(null),void 0!==n.sparse&&(a.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(a).then(function(e){const a=e[0],r=$n[n.type],i=Kn[n.componentType],o=i.BYTES_PER_ELEMENT,l=o*r,c=n.byteOffset||0,u=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,h=!0===n.normalized;let d,p;if(u&&u!==l){const e=Math.floor(c/u),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(s);l||(d=new i(a,e*u,n.count*u/o),l=new Re(d,u/o),t.cache.add(s,l)),p=new ot(l,r,c%u/o,h)}else d=null===a?new i(n.count*r):new i(a,c,n.count*r),p=new ke(d,r,h);if(void 0!==n.sparse){const t=$n.SCALAR,s=Kn[n.sparse.indices.componentType],o=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],o,n.sparse.count*t),u=new i(e[2],l,n.sparse.count*r);null!==a&&(p=new ke(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,n=c.length;e<n;e++){const t=c[e];if(p.setX(t,u[e*r]),r>=2&&p.setY(t,u[e*r+1]),r>=3&&p.setZ(t,u[e*r+2]),r>=4&&p.setW(t,u[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=h}return p})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,a=t.images[n];let r=this.textureLoader;if(a.uri){const e=s.manager.getHandler(a.uri);null!==e&&(r=e)}return this.loadTextureImage(e,n,r)}loadTextureImage(e,t,s){const n=this,a=this.json,r=a.textures[e],i=a.images[t],o=(i.uri||i.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=r.name||i.name||"",""===t.name&&"string"==typeof i.uri&&!1===i.uri.startsWith("data:image/")&&(t.name=i.uri);const s=(a.samplers||{})[r.sampler]||{};return t.magFilter=Wn[s.magFilter]||Pe,t.minFilter=Wn[s.minFilter]||Ce,t.wrapS=Yn[s.wrapS]||Ne,t.wrapT=Yn[s.wrapT]||Ne,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==Le&&t.minFilter!==Pe,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){const s=this,n=this.json,a=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const r=n.images[e],i=self.URL||self.webkitURL;let o=r.uri||"",l=!1;if(void 0!==r.bufferView)o=s.getDependency("bufferView",r.bufferView).then(function(e){l=!0;const t=new Blob([e],{type:r.mimeType});return o=i.createObjectURL(t),o});else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(o).then(function(e){return new Promise(function(s,n){let r=s;!0===t.isImageBitmapLoader&&(r=function(e){const t=new lt(e);t.needsUpdate=!0,s(t)}),t.load(ce.resolveURL(e,a.path),r,void 0,n)})}).then(function(e){var t;return!0===l&&i.revokeObjectURL(o),aa(e,r),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw e});return this.sourceCache[e]=c,c}assignTexture(e,t,s,n){const a=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((r=r.clone()).channel=s.texCoord),a.extensions[gn.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[gn.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=a.associations.get(r);r=a.extensions[gn.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),a.associations.set(r,t)}}return void 0!==n&&(r.colorSpace=n),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,a=void 0!==t.attributes.color,r=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Fe,je.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new ze,je.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||a||r){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),a&&(e+="vertex-colors:"),r&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),a&&(t.vertexColors=!0),r&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return Be}loadMaterial(e){const t=this,s=this.json,n=this.extensions,a=s.materials[e];let r;const i={},o=[];if((a.extensions||{})[gn.KHR_MATERIALS_UNLIT]){const e=n[gn.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),o.push(e.extendParams(i,a,t))}else{const s=a.pbrMetallicRoughness||{};if(i.color=new pe(1,1,1),i.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;i.color.setRGB(e[0],e[1],e[2],me),i.opacity=e[3]}void 0!==s.baseColorTexture&&o.push(t.assignTexture(i,"map",s.baseColorTexture,fe)),i.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,i.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(o.push(t.assignTexture(i,"metalnessMap",s.metallicRoughnessTexture)),o.push(t.assignTexture(i,"roughnessMap",s.metallicRoughnessTexture))),r=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),o.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,i)})))}!0===a.doubleSided&&(i.side=He);const l=a.alphaMode||Qn;if(l===ta?(i.transparent=!0,i.depthWrite=!1):(i.transparent=!1,l===ea&&(i.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&r!==Ve&&(o.push(t.assignTexture(i,"normalMap",a.normalTexture)),i.normalScale=new de(1,1),void 0!==a.normalTexture.scale)){const e=a.normalTexture.scale;i.normalScale.set(e,e)}if(void 0!==a.occlusionTexture&&r!==Ve&&(o.push(t.assignTexture(i,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(i.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&r!==Ve){const e=a.emissiveFactor;i.emissive=(new pe).setRGB(e[0],e[1],e[2],me)}return void 0!==a.emissiveTexture&&r!==Ve&&o.push(t.assignTexture(i,"emissiveMap",a.emissiveTexture,fe)),Promise.all(o).then(function(){const s=new r(i);return a.name&&(s.name=a.name),aa(s,a),t.associations.set(s,{materials:e}),a.extensions&&na(n,s,a),s})}createUniqueName(e){const t=Xe.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function a(e){return s[gn.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return ha(s,e,t)})}const r=[];for(let i=0,o=e.length;i<o;i++){const s=e[i],o=ia(s),l=n[o];if(l)r.push(l.promise);else{let e;e=s.extensions&&s.extensions[gn.KHR_DRACO_MESH_COMPRESSION]?a(s):ha(new Ge,s,t),n[o]={primitive:s,promise:e},r.push(e)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,n=this.extensions,a=s.meshes[e],r=a.primitives,i=[];for(let o=0,l=r.length;o<l;o++){const e=void 0===r[o].material?sa(this.cache):this.getDependency("material",r[o].material);i.push(e)}return i.push(t.loadGeometries(r)),Promise.all(i).then(function(s){const i=s.slice(0,s.length-1),o=s[s.length-1],l=[];for(let u=0,h=o.length;u<h;u++){const s=o[u],c=r[u];let h;const d=i[u];if(c.mode===Gn.TRIANGLES||c.mode===Gn.TRIANGLE_STRIP||c.mode===Gn.TRIANGLE_FAN||void 0===c.mode)h=!0===a.isSkinnedMesh?new Ke(s,d):new We(s,d),!0===h.isSkinnedMesh&&h.normalizeSkinWeights(),c.mode===Gn.TRIANGLE_STRIP?h.geometry=pn(h.geometry,oe):c.mode===Gn.TRIANGLE_FAN&&(h.geometry=pn(h.geometry,ie));else if(c.mode===Gn.LINES)h=new Ye(s,d);else if(c.mode===Gn.LINE_STRIP)h=new $e(s,d);else if(c.mode===Gn.LINE_LOOP)h=new qe(s,d);else{if(c.mode!==Gn.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);h=new Ze(s,d)}Object.keys(h.geometry.morphAttributes).length>0&&ra(h,a),h.name=t.createUniqueName(a.name||"mesh_"+e),aa(h,a),c.extensions&&na(n,h,c),t.assignFinalMaterial(h),l.push(h)}for(let n=0,a=l.length;n<a;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return a.extensions&&na(n,l[0],a),l[0];const c=new Je;a.extensions&&na(n,c,a),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new Qe(et.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new tt(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),aa(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,a=t.joints.length;n<a;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const t=e.pop(),s=e,n=[],a=[];for(let r=0,i=s.length;r<i;r++){const e=s[r];if(e){n.push(e);const s=new xe;null!==t&&s.fromArray(t.array,16*r),a.push(s)}}return new st(n,a)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],a=n.name?n.name:"animation_"+e,r=[],i=[],o=[],l=[],c=[];for(let u=0,h=n.channels.length;u<h;u++){const e=n.channels[u],t=n.samplers[e.sampler],s=e.target,a=s.node,h=void 0!==n.parameters?n.parameters[t.input]:t.input,d=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==s.node&&(r.push(this.getDependency("node",a)),i.push(this.getDependency("accessor",h)),o.push(this.getDependency("accessor",d)),l.push(t),c.push(s))}return Promise.all([Promise.all(r),Promise.all(i),Promise.all(o),Promise.all(l),Promise.all(c)]).then(function(e){const t=e[0],r=e[1],i=e[2],o=e[3],l=e[4],c=[];for(let n=0,a=t.length;n<a;n++){const e=t[n],a=r[n],u=i[n],h=o[n],d=l[n];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const p=s._createAnimationTracks(e,a,u,h,d);if(p)for(let t=0;t<p.length;t++)c.push(p[t])}const u=new nt(a,void 0,c);return aa(u,n),u})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),a=[],r=s.children||[];for(let o=0,l=r.length;o<l;o++)a.push(t.getDependency("node",r[o]));const i=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(a),i]).then(function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,ca)});for(let a=0,r=s.length;a<r;a++)t.add(s[a]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const a=t.nodes[e],r=a.name?n.createUniqueName(a.name):"",i=[],o=n._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&i.push(o),void 0!==a.camera&&i.push(n.getDependency("camera",a.camera).then(function(e){return n._getNodeRef(n.cameraCache,a.camera,e)})),n._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){i.push(e)}),this.nodeCache[e]=Promise.all(i).then(function(t){let i;if(i=!0===a.isBone?new at:t.length>1?new Je:1===t.length?t[0]:new Me,i!==t[0])for(let e=0,s=t.length;e<s;e++)i.add(t[e]);if(a.name&&(i.userData.name=a.name,i.name=r),aa(i,a),a.extensions&&na(s,i,a),void 0!==a.matrix){const e=new xe;e.fromArray(a.matrix),i.applyMatrix4(e)}else void 0!==a.translation&&i.position.fromArray(a.translation),void 0!==a.rotation&&i.quaternion.fromArray(a.rotation),void 0!==a.scale&&i.scale.fromArray(a.scale);if(n.associations.has(i)){if(void 0!==a.mesh&&n.meshCache.refs[a.mesh]>1){const e=n.associations.get(i);n.associations.set(i,{...e})}}else n.associations.set(i,{});return n.associations.get(i).nodes=e,i}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,a=new Je;s.name&&(a.name=n.createUniqueName(s.name)),aa(a,s),s.extensions&&na(t,a,s);const r=s.nodes||[],i=[];for(let o=0,l=r.length;o<l;o++)i.push(n.getDependency("node",r[o]));return Promise.all(i).then(function(e){for(let t=0,s=e.length;t<s;t++)a.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[s,a]of n.associations)(s instanceof je||s instanceof lt)&&t.set(s,a);return e.traverse(e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(a),a})}_createAnimationTracks(e,t,s,n,a){const r=[],i=e.name?e.name:e.uuid,o=[];let l;switch(Zn[a.path]===Zn.weights?e.traverse(function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)}):o.push(i),Zn[a.path]){case Zn.weights:l=ut;break;case Zn.rotation:l=ht;break;case Zn.translation:case Zn.scale:l=ct;break;default:if(1===s.itemSize)l=ut;else l=ct}const c=void 0!==n.interpolation?Jn[n.interpolation]:it,u=this._getArrayFromAccessor(s);for(let h=0,d=o.length;h<d;h++){const e=new l(o[h]+"."+Zn[a.path],t.array,u,c);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),r.push(e)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=la(t.constructor),s=new Float32Array(t.length);for(let n=0,a=t.length;n<a;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof ht?Xn:Hn)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ha(e,t,s){const n=t.attributes,a=[];function r(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(const i in n){const t=qn[i]||i.toLowerCase();t in e.attributes||a.push(r(n[i],t))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});a.push(n)}return dt.workingColorSpace,aa(e,t),function(e,t,s){const n=t.attributes,a=new ft;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,r=e.max;if(void 0===t||void 0===r)return;if(a.set(new we(t[0],t[1],t[2]),new we(r[0],r[1],r[2])),e.normalized){const t=la(Kn[e.componentType]);a.min.multiplyScalar(t),a.max.multiplyScalar(t)}}const r=t.targets;if(void 0!==r){const e=new we,t=new we;for(let n=0,a=r.length;n<a;n++){const a=r[n];if(void 0!==a.POSITION){const n=s.json.accessors[a.POSITION],r=n.min,i=n.max;if(void 0!==r&&void 0!==i){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(i[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(i[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(i[2]))),n.normalized){const e=la(Kn[n.componentType]);t.multiplyScalar(e)}e.max(t)}}}a.expandByVector(e)}e.boundingBox=a;const i=new gt;a.getCenter(i.center),i.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=i}(e,t,s),Promise.all(a).then(function(){return void 0!==t.targets?function(e,t,s){let n=!1,a=!1,r=!1;for(let c=0,u=t.length;c<u;c++){const e=t[c];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(a=!0),void 0!==e.COLOR_0&&(r=!0),n&&a&&r)break}if(!n&&!a&&!r)return Promise.resolve(e);const i=[],o=[],l=[];for(let c=0,u=t.length;c<u;c++){const u=t[c];if(n){const t=void 0!==u.POSITION?s.getDependency("accessor",u.POSITION):e.attributes.position;i.push(t)}if(a){const t=void 0!==u.NORMAL?s.getDependency("accessor",u.NORMAL):e.attributes.normal;o.push(t)}if(r){const t=void 0!==u.COLOR_0?s.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(i),Promise.all(o),Promise.all(l)]).then(function(t){const s=t[0],i=t[1],o=t[2];return n&&(e.morphAttributes.position=s),a&&(e.morphAttributes.normal=i),r&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}var da=Uint8Array,pa=Uint16Array,ma=Int32Array,fa=new da([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ga=new da([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),va=new da([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ya=function(e,t){for(var s=new pa(31),n=0;n<31;++n)s[n]=t+=1<<e[n-1];var a=new ma(s[30]);for(n=1;n<30;++n)for(var r=s[n];r<s[n+1];++r)a[r]=r-s[n]<<5|n;return{b:s,r:a}},xa=ya(fa,2),wa=xa.b,ba=xa.r;wa[28]=258,ba[258]=28;for(var Ta=ya(ga,0).b,_a=new pa(32768),Ma=0;Ma<32768;++Ma){var Ia=(43690&Ma)>>1|(21845&Ma)<<1;Ia=(61680&(Ia=(52428&Ia)>>2|(13107&Ia)<<2))>>4|(3855&Ia)<<4,_a[Ma]=((65280&Ia)>>8|(255&Ia)<<8)>>1}var Aa=function(e,t,s){for(var n=e.length,a=0,r=new pa(t);a<n;++a)e[a]&&++r[e[a]-1];var i,o=new pa(t);for(a=1;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(s){i=new pa(1<<t);var l=15-t;for(a=0;a<n;++a)if(e[a])for(var c=a<<4|e[a],u=t-e[a],h=o[e[a]-1]++<<u,d=h|(1<<u)-1;h<=d;++h)i[_a[h]>>l]=c}else for(i=new pa(n),a=0;a<n;++a)e[a]&&(i[a]=_a[o[e[a]-1]++]>>15-e[a]);return i},ka=new da(288);for(Ma=0;Ma<144;++Ma)ka[Ma]=8;for(Ma=144;Ma<256;++Ma)ka[Ma]=9;for(Ma=256;Ma<280;++Ma)ka[Ma]=7;for(Ma=280;Ma<288;++Ma)ka[Ma]=8;var Ra=new da(32);for(Ma=0;Ma<32;++Ma)Ra[Ma]=5;var Ca=Aa(ka,9,1),Ea=Aa(Ra,5,1),Sa=function(e){for(var t=e[0],s=1;s<e.length;++s)e[s]>t&&(t=e[s]);return t},Da=function(e,t,s){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&s},Pa=function(e,t){var s=t/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&t)},La=function(e){return(e+7)/8|0},Na=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Oa=function(e,t,s){var n=new Error(t||Na[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,Oa),!s)throw n;return n},Ua=function(e,t,s,n){var a=e.length;if(!a||t.f&&!t.l)return s||new da(0);var r=!s,i=r||2!=t.i,o=t.i;r&&(s=new da(3*a));var l=function(e){var t=s.length;if(e>t){var n=new da(Math.max(2*t,e));n.set(s),s=n}},c=t.f||0,u=t.p||0,h=t.b||0,d=t.l,p=t.d,m=t.m,f=t.n,g=8*a;do{if(!d){c=Da(e,u,1);var v=Da(e,u+1,3);if(u+=3,!v){var y=e[(C=La(u)+4)-4]|e[C-3]<<8,x=C+y;if(x>a){o&&Oa(0);break}i&&l(h+y),s.set(e.subarray(C,x),h),t.b=h+=y,t.p=u=8*x,t.f=c;continue}if(1==v)d=Ca,p=Ea,m=9,f=5;else if(2==v){var w=Da(e,u,31)+257,b=Da(e,u+10,15)+4,T=w+Da(e,u+5,31)+1;u+=14;for(var _=new da(T),M=new da(19),I=0;I<b;++I)M[va[I]]=Da(e,u+3*I,7);u+=3*b;var A=Sa(M),k=(1<<A)-1,R=Aa(M,A,1);for(I=0;I<T;){var C,E=R[Da(e,u,k)];if(u+=15&E,(C=E>>4)<16)_[I++]=C;else{var S=0,D=0;for(16==C?(D=3+Da(e,u,3),u+=2,S=_[I-1]):17==C?(D=3+Da(e,u,7),u+=3):18==C&&(D=11+Da(e,u,127),u+=7);D--;)_[I++]=S}}var P=_.subarray(0,w),L=_.subarray(w);m=Sa(P),f=Sa(L),d=Aa(P,m,1),p=Aa(L,f,1)}else Oa(1);if(u>g){o&&Oa(0);break}}i&&l(h+131072);for(var N=(1<<m)-1,O=(1<<f)-1,U=u;;U=u){var F=(S=d[Pa(e,u)&N])>>4;if((u+=15&S)>g){o&&Oa(0);break}if(S||Oa(2),F<256)s[h++]=F;else{if(256==F){U=u,d=null;break}var j=F-254;if(F>264){var z=fa[I=F-257];j=Da(e,u,(1<<z)-1)+wa[I],u+=z}var B=p[Pa(e,u)&O],H=B>>4;B||Oa(3),u+=15&B;L=Ta[H];if(H>3){z=ga[H];L+=Pa(e,u)&(1<<z)-1,u+=z}if(u>g){o&&Oa(0);break}i&&l(h+131072);var V=h+j;if(h<L){var X=0-L,G=Math.min(L,V);for(X+h<0&&Oa(3);h<G;++h)s[h]=n[X+h]}for(;h<V;++h)s[h]=s[h-L]}}t.l=d,t.p=U,t.b=h,t.f=c,d&&(c=1,t.m=m,t.d=p,t.n=f)}while(!c);return h!=s.length&&r?function(e,t,s){return(null==s||s>e.length)&&(s=e.length),new da(e.subarray(t,s))}(s,0,h):s.subarray(0,h)},Fa=new da(0);function ja(e,t){return Ua(e.subarray(((8!=(15&(s=e)[0])||s[0]>>4>7||(s[0]<<8|s[1])%31)&&Oa(6,"invalid zlib data"),1==(s[1]>>5&1)&&Oa(6,"invalid zlib data: "+(32&s[1]?"need":"unexpected")+" dictionary"),2+(s[1]>>3&4)),-4),{i:2},t,t);var s}var za="undefined"!=typeof TextDecoder&&new TextDecoder;try{za.decode(Fa,{stream:!0})}catch(bc){}function Ba(e,t,s){const n=s.length-e-1;if(t>=s[n])return n-1;if(t<=s[e])return e;let a=e,r=n,i=Math.floor((a+r)/2);for(;t<s[i]||t>=s[i+1];)t<s[i]?r=i:a=i,i=Math.floor((a+r)/2);return i}function Ha(e,t){let s=1;for(let a=2;a<=e;++a)s*=a;let n=1;for(let a=2;a<=t;++a)n*=a;for(let a=2;a<=e-t;++a)n*=a;return s/n}function Va(e,t,s,n,a){const r=function(e,t,s,n,a){const r=a<e?a:e,i=[],o=Ba(e,n,t),l=function(e,t,s,n,a){const r=[];for(let h=0;h<=s;++h)r[h]=0;const i=[];for(let h=0;h<=n;++h)i[h]=r.slice(0);const o=[];for(let h=0;h<=s;++h)o[h]=r.slice(0);o[0][0]=1;const l=r.slice(0),c=r.slice(0);for(let h=1;h<=s;++h){l[h]=t-a[e+1-h],c[h]=a[e+h]-t;let s=0;for(let e=0;e<h;++e){const t=c[e+1],n=l[h-e];o[h][e]=t+n;const a=o[e][h-1]/o[h][e];o[e][h]=s+t*a,s=n*a}o[h][h]=s}for(let h=0;h<=s;++h)i[0][h]=o[h][s];for(let h=0;h<=s;++h){let e=0,t=1;const a=[];for(let n=0;n<=s;++n)a[n]=r.slice(0);a[0][0]=1;for(let r=1;r<=n;++r){let n=0;const l=h-r,c=s-r;h>=r&&(a[t][0]=a[e][0]/o[c+1][l],n=a[t][0]*o[l][c]);const u=h-1<=c?r-1:s-h;for(let s=l>=-1?1:-l;s<=u;++s)a[t][s]=(a[e][s]-a[e][s-1])/o[c+1][l+s],n+=a[t][s]*o[l+s][c];h<=c&&(a[t][r]=-a[e][r-1]/o[c+1][h],n+=a[t][r]*o[h][c]),i[r][h]=n;const d=e;e=t,t=d}}let u=s;for(let h=1;h<=n;++h){for(let e=0;e<=s;++e)i[h][e]*=u;u*=s-h}return i}(o,n,e,r,t),c=[];for(let u=0;u<s.length;++u){const e=s[u].clone(),t=e.w;e.x*=t,e.y*=t,e.z*=t,c[u]=e}for(let u=0;u<=r;++u){const t=c[o-e].clone().multiplyScalar(l[u][0]);for(let s=1;s<=e;++s)t.add(c[o-e+s].clone().multiplyScalar(l[u][s]));i[u]=t}for(let u=r+1;u<=a+1;++u)i[u]=new vt(0,0,0);return i}(e,t,s,n,a);return function(e){const t=e.length,s=[],n=[];for(let r=0;r<t;++r){const t=e[r];s[r]=new we(t.x,t.y,t.z),n[r]=t.w}const a=[];for(let r=0;r<t;++r){const e=s[r].clone();for(let t=1;t<=r;++t)e.sub(a[r-t].clone().multiplyScalar(Ha(r,t)*n[t]));a[r]=e.divideScalar(n[0])}return a}(r)}class Xa extends yt{constructor(e,t,s,n,a){super();const r=t?t.length-1:0,i=s?s.length:0;this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=a||r;for(let o=0;o<i;++o){const e=s[o];this.controlPoints[o]=new vt(e.x,e.y,e.z,e.w)}}getPoint(e,t=new we){const s=t,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),a=function(e,t,s,n){const a=Ba(e,n,t),r=function(e,t,s,n){const a=[],r=[],i=[];a[0]=1;for(let o=1;o<=s;++o){r[o]=t-n[e+1-o],i[o]=n[e+o]-t;let s=0;for(let e=0;e<o;++e){const t=i[e+1],n=r[o-e],l=a[e]/(t+n);a[e]=s+t*l,s=n*l}a[o]=s}return a}(a,n,e,t),i=new vt(0,0,0,0);for(let o=0;o<=e;++o){const t=s[a-e+o],n=r[o],l=t.w*n;i.x+=t.x*l,i.y+=t.y*l,i.z+=t.z*l,i.w+=t.w*n}return i}(this.degree,this.knots,this.controlPoints,n);return 1!==a.w&&a.divideScalar(a.w),s.set(a.x,a.y,a.z)}getTangent(e,t=new we){const s=t,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),a=Va(this.degree,this.knots,this.controlPoints,n,1);return s.copy(a[1]).normalize(),s}toJSON(){const e=super.toJSON();return e.degree=this.degree,e.knots=[...this.knots],e.controlPoints=this.controlPoints.map(e=>e.toArray()),e.startKnot=this.startKnot,e.endKnot=this.endKnot,e}fromJSON(e){return super.fromJSON(e),this.degree=e.degree,this.knots=[...e.knots],this.controlPoints=e.controlPoints.map(e=>new vt(e[0],e[1],e[2],e[3])),this.startKnot=e.startKnot,this.endKnot=e.endKnot,this}}let Ga,Ka,Wa;class Ya extends le{constructor(e){super(e)}load(e,t,s,n){const a=this,r=""===a.path?ce.extractUrlBase(e):a.path,i=new ue(this.manager);i.setPath(a.path),i.setResponseType("arraybuffer"),i.setRequestHeader(a.requestHeader),i.setWithCredentials(a.withCredentials),i.load(e,function(s){try{t(a.parse(s,r))}catch(bc){n&&n(bc),a.manager.itemError(e)}},s,n)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===hr(e,0,t.length)}(e))Ga=(new Qa).parse(e);else{const t=hr(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let s=0;function n(t){const n=e[t-1];return e=e.slice(s+t),s++,n}for(let a=0;a<t.length;++a){if(n(1)===t[a])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(sr(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+sr(t));Ga=(new Ja).parse(t)}const s=new Ie(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new $a(s,this.manager).parse(Ga)}}class $a{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Ka=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),s=this.parseMaterials(t),n=this.parseDeformers(),a=(new qa).parse(n);return this.parseScene(n,a,s),Wa}parseConnections(){const e=new Map;if("Connections"in Ga){Ga.Connections.connections.forEach(function(t){const s=t[0],n=t[1],a=t[2];e.has(s)||e.set(s,{parents:[],children:[]});const r={ID:n,relationship:a};e.get(s).parents.push(r),e.has(n)||e.set(n,{parents:[],children:[]});const i={ID:s,relationship:a};e.get(n).children.push(i)})}return e}parseImages(){const e={},t={};if("Video"in Ga.Objects){const s=Ga.Objects.Video;for(const n in s){const a=s[n];if(e[parseInt(n)]=a.RelativeFilename||a.Filename,"Content"in a){const e=a.Content instanceof ArrayBuffer&&a.Content.byteLength>0,r="string"==typeof a.Content&&""!==a.Content;if(e||r){const e=this.parseImage(s[n]);t[a.RelativeFilename||a.Filename]=e}}}}for(const s in e){const n=e[s];void 0!==t[n]?e[s]=t[n]:e[s]=e[s].split("\\").pop()}return e}parseImage(e){const t=e.Content,s=e.RelativeFilename||e.Filename;let n;switch(s.slice(s.lastIndexOf(".")+1).toLowerCase()){case"bmp":n="image/bmp";break;case"jpg":case"jpeg":n="image/jpeg";break;case"png":n="image/png";break;case"tif":n="image/tiff";break;case"tga":this.manager.getHandler(".tga"),n="image/tga";break;case"webp":n="image/webp";break;default:return}if("string"==typeof t)return"data:"+n+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:n}))}}parseTextures(e){const t=new Map;if("Texture"in Ga.Objects){const s=Ga.Objects.Texture;for(const n in s){const a=this.parseTexture(s[n],e);t.set(parseInt(n),a)}}return t}parseTexture(e,t){const s=this.loadTexture(e,t);s.ID=e.id,s.name=e.attrName;const n=e.WrapModeU,a=e.WrapModeV,r=void 0!==n?n.value:0,i=void 0!==a?a.value:0;if(s.wrapS=0===r?Ne:Ue,s.wrapT=0===i?Ne:Ue,"Scaling"in e){const t=e.Scaling.value;s.repeat.x=t[0],s.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;s.offset.x=t[0],s.offset.y=t[1]}return s}loadTexture(e,t){const s=e.FileName.split(".").pop().toLowerCase();let n=this.manager.getHandler(`.${s}`);null===n&&(n=this.textureLoader);const a=n.path;a||n.setPath(this.textureLoader.path);const r=Ka.get(e.id).children;let i;if(void 0!==r&&r.length>0&&void 0!==t[r[0].ID]&&(i=t[r[0].ID],0!==i.indexOf("blob:")&&0!==i.indexOf("data:")||n.setPath(void 0)),void 0===i)return new lt;const o=n.load(i);return n.setPath(a),o}parseMaterials(e){const t=new Map;if("Material"in Ga.Objects){const s=Ga.Objects.Material;for(const n in s){const a=this.parseMaterial(s[n],e);null!==a&&t.set(parseInt(n),a)}}return t}parseMaterial(e,t){const s=e.id,n=e.attrName;let a=e.ShadingModel;if("object"==typeof a&&(a=a.value),!Ka.has(s))return null;const r=this.parseParameters(e,t,s);let i;switch(a.toLowerCase()){case"phong":default:i=new xt;break;case"lambert":i=new wt}return i.setValues(r),i.name=n,i}parseParameters(e,t,s){const n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=dt.colorSpaceToWorking((new pe).fromArray(e.Diffuse.value),fe):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(n.color=dt.colorSpaceToWorking((new pe).fromArray(e.DiffuseColor.value),fe)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=dt.colorSpaceToWorking((new pe).fromArray(e.Emissive.value),fe):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(n.emissive=dt.colorSpaceToWorking((new pe).fromArray(e.EmissiveColor.value),fe)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),n.opacity=1-(e.TransparencyFactor?parseFloat(e.TransparencyFactor.value):0),1!==n.opacity&&0!==n.opacity||(n.opacity=e.Opacity?parseFloat(e.Opacity.value):null,null===n.opacity&&(n.opacity=1-(e.TransparentColor?parseFloat(e.TransparentColor.value[0]):0))),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=dt.colorSpaceToWorking((new pe).fromArray(e.Specular.value),fe):e.SpecularColor&&"Color"===e.SpecularColor.type&&(n.specular=dt.colorSpaceToWorking((new pe).fromArray(e.SpecularColor.value),fe));const a=this;return Ka.get(s).children.forEach(function(e){switch(e.relationship){case"Bump":n.bumpMap=a.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":n.aoMap=a.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=a.getTexture(t,e.ID),void 0!==n.map&&(n.map.colorSpace=fe);break;case"DisplacementColor":n.displacementMap=a.getTexture(t,e.ID);break;case"EmissiveColor":n.emissiveMap=a.getTexture(t,e.ID),void 0!==n.emissiveMap&&(n.emissiveMap.colorSpace=fe);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=a.getTexture(t,e.ID);break;case"ReflectionColor":n.envMap=a.getTexture(t,e.ID),void 0!==n.envMap&&(n.envMap.mapping=bt,n.envMap.colorSpace=fe);break;case"SpecularColor":n.specularMap=a.getTexture(t,e.ID),void 0!==n.specularMap&&(n.specularMap.colorSpace=fe);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=a.getTexture(t,e.ID),n.transparent=!0}}),n}getTexture(e,t){return"LayeredTexture"in Ga.Objects&&t in Ga.Objects.LayeredTexture&&(t=Ka.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Ga.Objects){const s=Ga.Objects.Deformer;for(const n in s){const a=s[n],r=Ka.get(parseInt(n));if("Skin"===a.attrType){const t=this.parseSkeleton(r,s);t.ID=n,r.parents.length,t.geometryID=r.parents[0].ID,e[n]=t}else if("BlendShape"===a.attrType){const e={id:n};e.rawTargets=this.parseMorphTargets(r,s),e.id=n,r.parents.length,t[n]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const s=[];return e.children.forEach(function(e){const n=t[e.ID];if("Cluster"!==n.attrType)return;const a={ID:e.ID,indices:[],weights:[],transformLink:(new xe).fromArray(n.TransformLink.a)};"Indexes"in n&&(a.indices=n.Indexes.a,a.weights=n.Weights.a),s.push(a)}),{rawBones:s,bones:[]}}parseMorphTargets(e,t){const s=[];for(let n=0;n<e.children.length;n++){const a=e.children[n],r=t[a.ID],i={name:r.attrName,initialWeight:r.DeformPercent,id:r.id,fullWeights:r.FullWeights.a};if("BlendShapeChannel"!==r.attrType)return;i.geoID=Ka.get(parseInt(a.ID)).children.filter(function(e){return void 0===e.relationship})[0].ID,s.push(i)}return s}parseScene(e,t,s){Wa=new Je;const n=this.parseModels(e.skeletons,t,s),a=Ga.Objects.Model,r=this;n.forEach(function(e){const t=a[e.ID];r.setLookAtProperties(e,t);Ka.get(e.ID).parents.forEach(function(t){const s=n.get(t.ID);void 0!==s&&s.add(e)}),null===e.parent&&Wa.add(e)}),this.bindSkeleton(e.skeletons,t,n),this.addGlobalSceneSettings(),Wa.traverse(function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=lr(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}});const i=(new Za).parse();1===Wa.children.length&&Wa.children[0].isGroup&&(Wa.children[0].animations=i,Wa=Wa.children[0]),Wa.animations=i}parseModels(e,t,s){const n=new Map,a=Ga.Objects.Model;for(const r in a){const i=parseInt(r),o=a[r],l=Ka.get(i);let c=this.buildSkeleton(l,e,i,o.attrName);if(!c){switch(o.attrType){case"Camera":c=this.createCamera(l);break;case"Light":c=this.createLight(l);break;case"Mesh":c=this.createMesh(l,t,s);break;case"NurbsCurve":c=this.createCurve(l,t);break;case"LimbNode":case"Root":c=new at;break;default:c=new Je}c.name=o.attrName?Xe.sanitizeNodeName(o.attrName):"",c.userData.originalName=o.attrName,c.ID=i}this.getTransformData(c,o),n.set(i,c)}return n}buildSkeleton(e,t,s,n){let a=null;return e.parents.forEach(function(e){for(const r in t){const i=t[r];i.rawBones.forEach(function(t,r){if(t.ID===e.ID){const e=a;a=new at,a.matrixWorld.copy(t.transformLink),a.name=n?Xe.sanitizeNodeName(n):"",a.userData.originalName=n,a.ID=s,i.bones[r]=a,null!==e&&a.add(e)}})}}),a}createCamera(e){let t,s;if(e.children.forEach(function(e){const t=Ga.Objects.NodeAttribute[e.ID];void 0!==t&&(s=t)}),void 0===s)t=new Me;else{let e=0;void 0!==s.CameraProjectionType&&1===s.CameraProjectionType.value&&(e=1);let n=1;void 0!==s.NearPlane&&(n=s.NearPlane.value/1e3);let a=1e3;void 0!==s.FarPlane&&(a=s.FarPlane.value/1e3);let r=window.innerWidth,i=window.innerHeight;void 0!==s.AspectWidth&&void 0!==s.AspectHeight&&(r=s.AspectWidth.value,i=s.AspectHeight.value);const o=r/i;let l=45;void 0!==s.FieldOfView&&(l=s.FieldOfView.value);const c=s.FocalLength?s.FocalLength.value:null;if(0===e)t=new Qe(l,o,n,a),null!==c&&t.setFocalLength(c);else t=new Me}return t}createLight(e){let t,s;if(e.children.forEach(function(e){const t=Ga.Objects.NodeAttribute[e.ID];void 0!==t&&(s=t)}),void 0===s)t=new Me;else{let e;e=void 0===s.LightType?0:s.LightType.value;let n=16777215;void 0!==s.Color&&(n=dt.colorSpaceToWorking((new pe).fromArray(s.Color.value),fe));let a=void 0===s.Intensity?1:s.Intensity.value/100;void 0!==s.CastLightOnObject&&0===s.CastLightOnObject.value&&(a=0);let r=0;void 0!==s.FarAttenuationEnd&&(r=void 0!==s.EnableFarAttenuation&&0===s.EnableFarAttenuation.value?0:s.FarAttenuationEnd.value);const i=1;switch(e){case 0:t=new ve(n,a,r,i);break;case 1:t=new ye(n,a);break;case 2:let e=Math.PI/3;void 0!==s.InnerAngle&&(e=et.degToRad(s.InnerAngle.value));let o=0;void 0!==s.OuterAngle&&(o=et.degToRad(s.OuterAngle.value),o=Math.max(o,1)),t=new ge(n,a,r,e,o,i);break;default:t=new ve(n,a)}void 0!==s.CastShadows&&1===s.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,s){let n,a=null,r=null;const i=[];if(e.children.forEach(function(e){t.has(e.ID)&&(a=t.get(e.ID)),s.has(e.ID)&&i.push(s.get(e.ID))}),i.length>1?r=i:i.length>0?r=i[0]:(r=new xt({name:le.DEFAULT_MATERIAL_NAME,color:13421772}),i.push(r)),"color"in a.attributes&&i.forEach(function(e){e.vertexColors=!0}),a.groups.length>0){let e=!1;for(let t=0,s=a.groups.length;t<s;t++){const s=a.groups[t];(s.materialIndex<0||s.materialIndex>=i.length)&&(s.materialIndex=i.length,e=!0)}if(e){const e=new xt;i.push(e)}}return a.FBX_Deformer?(n=new Ke(a,r),n.normalizeSkinWeights()):n=new We(a,r),n}createCurve(e,t){const s=e.children.reduce(function(e,s){return t.has(s.ID)&&(e=t.get(s.ID)),e},null),n=new ze({name:le.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new $e(s,n)}getTransformData(e,t){const s={};"InheritType"in t&&(s.inheritType=parseInt(t.InheritType.value)),s.eulerOrder=cr("RotationOrder"in t?t.RotationOrder.value:0),"Lcl_Translation"in t&&(s.translation=t.Lcl_Translation.value),"PreRotation"in t&&(s.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(s.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(s.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(s.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(s.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(s.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(s.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(s.rotationPivot=t.RotationPivot.value),e.userData.transformData=s}setLookAtProperties(e,t){if("LookAtProperty"in t){Ka.get(e.ID).children.forEach(function(t){if("LookAtProperty"===t.relationship){const s=Ga.Objects.Model[t.ID];if("Lcl_Translation"in s){const t=s.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),Wa.add(e.target)):e.lookAt((new we).fromArray(t))}}})}}bindSkeleton(e,t,s){const n=this.parsePoseNodes();for(const a in e){const r=e[a];Ka.get(parseInt(r.ID)).parents.forEach(function(e){if(t.has(e.ID)){const t=e.ID;Ka.get(t).parents.forEach(function(e){if(s.has(e.ID)){s.get(e.ID).bind(new st(r.bones),n[e.ID])}})}})}}parsePoseNodes(){const e={};if("Pose"in Ga.Objects){const t=Ga.Objects.Pose;for(const s in t)if("BindPose"===t[s].attrType&&t[s].NbPoseNodes>0){const n=t[s].PoseNode;Array.isArray(n)?n.forEach(function(t){e[t.Node]=(new xe).fromArray(t.Matrix.a)}):e[n.Node]=(new xe).fromArray(n.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in Ga){if("AmbientColor"in Ga.GlobalSettings){const e=Ga.GlobalSettings.AmbientColor.value,t=e[0],s=e[1],n=e[2];if(0!==t||0!==s||0!==n){const e=(new pe).setRGB(t,s,n,fe);Wa.add(new Tt(e,1))}}"UnitScaleFactor"in Ga.GlobalSettings&&(Wa.userData.unitScaleFactor=Ga.GlobalSettings.UnitScaleFactor.value)}}}class qa{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in Ga.Objects){const s=Ga.Objects.Geometry;for(const n in s){const a=Ka.get(parseInt(n)),r=this.parseGeometry(a,s[n],e);t.set(parseInt(n),r)}}return this.negativeMaterialIndices,t}parseGeometry(e,t,s){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,s);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,s){const n=s.skeletons,a=[],r=e.parents.map(function(e){return Ga.Objects.Model[e.ID]});if(0===r.length)return;const i=e.children.reduce(function(e,t){return void 0!==n[t.ID]&&(e=n[t.ID]),e},null);e.children.forEach(function(e){void 0!==s.morphTargets[e.ID]&&a.push(s.morphTargets[e.ID])});const o=r[0],l={};"RotationOrder"in o&&(l.eulerOrder=cr(o.RotationOrder.value)),"InheritType"in o&&(l.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(l.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(l.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(l.scale=o.GeometricScaling.value);const c=lr(l);return this.genGeometry(t,i,a,c)}genGeometry(e,t,s,n){const a=new Ge;e.attrName&&(a.name=e.attrName);const r=this.parseGeoNode(e,t),i=this.genBuffers(r),o=new _t(i.vertex,3);if(o.applyMatrix4(n),a.setAttribute("position",o),i.colors.length>0&&a.setAttribute("color",new _t(i.colors,3)),t&&(a.setAttribute("skinIndex",new Mt(i.weightsIndices,4)),a.setAttribute("skinWeight",new _t(i.vertexWeights,4)),a.FBX_Deformer=t),i.normal.length>0){const e=(new It).getNormalMatrix(n),t=new _t(i.normal,3);t.applyNormalMatrix(e),a.setAttribute("normal",t)}if(i.uvs.forEach(function(e,t){const s=0===t?"uv":`uv${t}`;a.setAttribute(s,new _t(i.uvs[t],2))}),r.material&&"AllSame"!==r.material.mappingType){let e=i.materialIndex[0],t=0;if(i.materialIndex.forEach(function(s,n){s!==e&&(a.addGroup(t,n-t,e),e=s,t=n)}),a.groups.length>0){const t=a.groups[a.groups.length-1],s=t.start+t.count;s!==i.materialIndex.length&&a.addGroup(s,i.materialIndex.length-s,e)}0===a.groups.length&&a.addGroup(0,i.materialIndex.length,i.materialIndex[0])}return this.addMorphTargets(a,e,s,n),a}parseGeoNode(e,t){const s={};if(s.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],s.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&e.LayerElementColor[0].Colors&&(s.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(s.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(s.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){s.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&s.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return s.weightTable={},null!==t&&(s.skeleton=t,t.rawBones.forEach(function(e,t){e.indices.forEach(function(n,a){void 0===s.weightTable[n]&&(s.weightTable[n]=[]),s.weightTable[n].push({id:t,weight:e.weights[a]})})})),s}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let s=0,n=0,a=!1,r=[],i=[],o=[],l=[],c=[],u=[];const h=this;return e.vertexIndices.forEach(function(d,p){let m,f=!1;d<0&&(d^=-1,f=!0);let g=[],v=[];if(r.push(3*d,3*d+1,3*d+2),e.color){const t=rr(p,s,d,e.color);o.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach(function(e){v.push(e.weight),g.push(e.id)}),v.length>4){a||(a=!0);const e=[0,0,0,0],t=[0,0,0,0];v.forEach(function(s,n){let a=s,r=g[n];t.forEach(function(t,s,n){if(a>t){n[s]=a,a=t;const i=e[s];e[s]=r,r=i}})}),g=e,v=t}for(;v.length<4;)v.push(0),g.push(0);for(let e=0;e<4;++e)c.push(v[e]),u.push(g[e])}if(e.normal){const t=rr(p,s,d,e.normal);i.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=rr(p,s,d,e.material)[0],m<0&&(h.negativeMaterialIndices=!0,m=0)),e.uv&&e.uv.forEach(function(e,t){const n=rr(p,s,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(n[0]),l[t].push(n[1])}),n++,f&&(h.genFace(t,e,r,m,i,o,l,c,u,n),s++,n=0,r=[],i=[],o=[],l=[],c=[],u=[])}),t}getNormalNewell(e){const t=new we(0,0,0);for(let s=0;s<e.length;s++){const n=e[s],a=e[(s+1)%e.length];t.x+=(n.y-a.y)*(n.z+a.z),t.y+=(n.z-a.z)*(n.x+a.x),t.z+=(n.x-a.x)*(n.y+a.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),s=(Math.abs(t.z)>.5?new we(0,1,0):new we(0,0,1)).cross(t).normalize(),n=t.clone().cross(s).normalize();return{normal:t,tangent:s,bitangent:n}}flattenVertex(e,t,s){return new de(e.dot(t),e.dot(s))}genFace(e,t,s,n,a,r,i,o,l,c){let u;if(c>3){const e=[],n=t.baseVertexPositions||t.vertexPositions;for(let t=0;t<s.length;t+=3)e.push(new we(n[s[t]],n[s[t+1]],n[s[t+2]]));const{tangent:a,bitangent:r}=this.getNormalTangentAndBitangent(e),i=[];for(const t of e)i.push(this.flattenVertex(t,a,r));u=At.triangulateShape(i,[])}else u=[[0,1,2]];for(const[h,d,p]of u)e.vertex.push(t.vertexPositions[s[3*h]]),e.vertex.push(t.vertexPositions[s[3*h+1]]),e.vertex.push(t.vertexPositions[s[3*h+2]]),e.vertex.push(t.vertexPositions[s[3*d]]),e.vertex.push(t.vertexPositions[s[3*d+1]]),e.vertex.push(t.vertexPositions[s[3*d+2]]),e.vertex.push(t.vertexPositions[s[3*p]]),e.vertex.push(t.vertexPositions[s[3*p+1]]),e.vertex.push(t.vertexPositions[s[3*p+2]]),t.skeleton&&(e.vertexWeights.push(o[4*h]),e.vertexWeights.push(o[4*h+1]),e.vertexWeights.push(o[4*h+2]),e.vertexWeights.push(o[4*h+3]),e.vertexWeights.push(o[4*d]),e.vertexWeights.push(o[4*d+1]),e.vertexWeights.push(o[4*d+2]),e.vertexWeights.push(o[4*d+3]),e.vertexWeights.push(o[4*p]),e.vertexWeights.push(o[4*p+1]),e.vertexWeights.push(o[4*p+2]),e.vertexWeights.push(o[4*p+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3]),e.weightsIndices.push(l[4*d]),e.weightsIndices.push(l[4*d+1]),e.weightsIndices.push(l[4*d+2]),e.weightsIndices.push(l[4*d+3]),e.weightsIndices.push(l[4*p]),e.weightsIndices.push(l[4*p+1]),e.weightsIndices.push(l[4*p+2]),e.weightsIndices.push(l[4*p+3])),t.color&&(e.colors.push(r[3*h]),e.colors.push(r[3*h+1]),e.colors.push(r[3*h+2]),e.colors.push(r[3*d]),e.colors.push(r[3*d+1]),e.colors.push(r[3*d+2]),e.colors.push(r[3*p]),e.colors.push(r[3*p+1]),e.colors.push(r[3*p+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(a[3*h]),e.normal.push(a[3*h+1]),e.normal.push(a[3*h+2]),e.normal.push(a[3*d]),e.normal.push(a[3*d+1]),e.normal.push(a[3*d+2]),e.normal.push(a[3*p]),e.normal.push(a[3*p+1]),e.normal.push(a[3*p+2])),t.uv&&t.uv.forEach(function(t,s){void 0===e.uvs[s]&&(e.uvs[s]=[]),e.uvs[s].push(i[s][2*h]),e.uvs[s].push(i[s][2*h+1]),e.uvs[s].push(i[s][2*d]),e.uvs[s].push(i[s][2*d+1]),e.uvs[s].push(i[s][2*p]),e.uvs[s].push(i[s][2*p+1])})}addMorphTargets(e,t,s,n){if(0===s.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const a=this;s.forEach(function(s){s.rawTargets.forEach(function(s){const r=Ga.Objects.Geometry[s.geoID];void 0!==r&&a.genMorphGeometry(e,t,r,n,s.name)})})}genMorphGeometry(e,t,s,n,a){const r=void 0!==t.Vertices?t.Vertices.a:[],i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],o=void 0!==s.Vertices?s.Vertices.a:[],l=void 0!==s.Indexes?s.Indexes.a:[],c=3*e.attributes.position.count,u=new Float32Array(c);for(let m=0;m<l.length;m++){const e=3*l[m];u[e]=o[3*m],u[e+1]=o[3*m+1],u[e+2]=o[3*m+2]}const h={vertexIndices:i,vertexPositions:u,baseVertexPositions:r},d=this.genBuffers(h),p=new _t(d.vertex,3);p.name=a||s.attrName,p.applyMatrix4(n),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,n=e.Normals.a;let a=[];return"IndexToDirect"===s&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:a,mappingType:t,referenceType:s}}parseUVs(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,n=e.UV.a;let a=[];return"IndexToDirect"===s&&(a=e.UVIndex.a),{dataSize:2,buffer:n,indices:a,mappingType:t,referenceType:s}}parseVertexColors(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,n=e.Colors.a;let a=[];"IndexToDirect"===s&&(a=e.ColorIndex.a);for(let r=0,i=new pe;r<n.length;r+=4)i.fromArray(n,r),dt.colorSpaceToWorking(i,fe),i.toArray(n,r);return{dataSize:4,buffer:n,indices:a,mappingType:t,referenceType:s}}parseMaterialIndices(e){const t=e.MappingInformationType,s=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:s};const n=e.Materials.a,a=[];for(let r=0;r<n.length;++r)a.push(r);return{dataSize:1,buffer:n,indices:a,mappingType:t,referenceType:s}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return new Ge;const s=t-1,n=e.KnotVector.a,a=[],r=e.Points.a;for(let c=0,u=r.length;c<u;c+=4)a.push((new vt).fromArray(r,c));let i,o;if("Closed"===e.Form)a.push(a[0]);else if("Periodic"===e.Form){i=s,o=n.length-1-i;for(let e=0;e<s;++e)a.push(a[e])}const l=new Xa(s,n,a,i,o).getPoints(12*a.length);return(new Ge).setFromPoints(l)}}class Za{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const s in t){const n=t[s],a=this.addClip(n);e.push(a)}return e}parseClips(){if(void 0===Ga.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Ga.Objects.AnimationCurveNode,t=new Map;for(const s in e){const n=e[s];if(null!==n.attrName.match(/S|R|T|DeformPercent/)){const e={id:n.id,attr:n.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Ga.Objects.AnimationCurve;for(const s in t){const n={id:t[s].id,times:t[s].KeyTime.a.map(nr),values:t[s].KeyValueFloat.a},a=Ka.get(n.id);if(void 0!==a){const t=a.parents[0].ID,s=a.parents[0].relationship;s.match(/X/)?e.get(t).curves.x=n:s.match(/Y/)?e.get(t).curves.y=n:s.match(/Z/)?e.get(t).curves.z=n:s.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=n)}}}parseAnimationLayers(e){const t=Ga.Objects.AnimationLayer,s=new Map;for(const n in t){const t=[],a=Ka.get(parseInt(n));if(void 0!==a){a.children.forEach(function(s,n){if(e.has(s.ID)){const a=e.get(s.ID);if(void 0!==a.curves.x||void 0!==a.curves.y||void 0!==a.curves.z){if(void 0===t[n]){const e=Ka.get(s.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID;if(void 0!==e){const s=Ga.Objects.Model[e.toString()];if(void 0===s)return;const a={modelName:s.attrName?Xe.sanitizeNodeName(s.attrName):"",ID:s.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Wa.traverse(function(e){e.ID===s.id&&(a.transform=e.matrix,e.userData.transformData&&(a.eulerOrder=e.userData.transformData.eulerOrder))}),a.transform||(a.transform=new xe),"PreRotation"in s&&(a.preRotation=s.PreRotation.value),"PostRotation"in s&&(a.postRotation=s.PostRotation.value),t[n]=a}}t[n]&&(t[n][a.attr]=a)}else if(void 0!==a.curves.morph){if(void 0===t[n]){const e=Ka.get(s.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID,a=Ka.get(e).parents[0].ID,r=Ka.get(a).parents[0].ID,i=Ka.get(r).parents[0].ID,o=Ga.Objects.Model[i],l={modelName:o.attrName?Xe.sanitizeNodeName(o.attrName):"",morphName:Ga.Objects.Deformer[e].attrName};t[n]=l}t[n][a.attr]=a}}}),s.set(parseInt(n),t)}}return s}parseAnimStacks(e){const t=Ga.Objects.AnimationStack,s={};for(const n in t){const a=Ka.get(parseInt(n)).children;a.length;const r=e.get(a[0].ID);s[n]={name:t[n].attrName,layer:r}}return s}addClip(e){let t=[];const s=this;return e.layer.forEach(function(e){t=t.concat(s.generateTracks(e))}),new nt(e.name,-1,t)}generateTracks(e){const t=[];let s=new we,n=new we;if(e.transform&&e.transform.decompose(s,new Te,n),s=s.toArray(),n=n.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.T.curves,s,"position");void 0!==n&&t.push(n)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const s=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);void 0!==s&&t.push(s)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const s=this.generateVectorTrack(e.modelName,e.S.curves,n,"scale");void 0!==s&&t.push(s)}if(void 0!==e.DeformPercent){const s=this.generateMorphTrack(e);void 0!==s&&t.push(s)}return t}generateVectorTrack(e,t,s,n){const a=this.getTimesForAllAxes(t),r=this.getKeyframeTrackValues(a,t,s);return new ct(e+"."+n,a,r)}generateRotationTrack(e,t,s,n,a){let r,i;if(void 0!==t.x&&void 0!==t.y&&void 0!==t.z){const e=this.interpolateRotations(t.x,t.y,t.z,a);r=e[0],i=e[1]}const o=cr(0);void 0!==s&&((s=s.map(et.degToRad)).push(o),s=(new kt).fromArray(s),s=(new Te).setFromEuler(s)),void 0!==n&&((n=n.map(et.degToRad)).push(o),n=(new kt).fromArray(n),n=(new Te).setFromEuler(n).invert());const l=new Te,c=new kt,u=[];if(!i||!r)return new ht(e+".quaternion",[0],[0]);for(let h=0;h<i.length;h+=3){if(c.set(i[h],i[h+1],i[h+2],a),l.setFromEuler(c),void 0!==s&&l.premultiply(s),void 0!==n&&l.multiply(n),h>2){(new Te).fromArray(u,(h-3)/3*4).dot(l)<0&&l.set(-l.x,-l.y,-l.z,-l.w)}l.toArray(u,h/3*4)}return new ht(e+".quaternion",r,u)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,s=t.values.map(function(e){return e/100}),n=Wa.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new ut(e.modelName+".morphTargetInfluences["+n+"]",t.times,s)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort(function(e,t){return e-t}),t.length>1){let e=1,s=t[0];for(let n=1;n<t.length;n++){const a=t[n];a!==s&&(t[e]=a,s=a,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,s){const n=s,a=[];let r=-1,i=-1,o=-1;return e.forEach(function(e){if(t.x&&(r=t.x.times.indexOf(e)),t.y&&(i=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==r){const e=t.x.values[r];a.push(e),n[0]=e}else a.push(n[0]);if(-1!==i){const e=t.y.values[i];a.push(e),n[1]=e}else a.push(n[1]);if(-1!==o){const e=t.z.values[o];a.push(e),n[2]=e}else a.push(n[2])}),a}interpolateRotations(e,t,s,n){const a=[],r=[];a.push(e.times[0]),r.push(et.degToRad(e.values[0])),r.push(et.degToRad(t.values[0])),r.push(et.degToRad(s.values[0]));for(let i=1;i<e.values.length;i++){const o=[e.values[i-1],t.values[i-1],s.values[i-1]];if(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))continue;const l=o.map(et.degToRad),c=[e.values[i],t.values[i],s.values[i]];if(isNaN(c[0])||isNaN(c[1])||isNaN(c[2]))continue;const u=c.map(et.degToRad),h=[c[0]-o[0],c[1]-o[1],c[2]-o[2]],d=[Math.abs(h[0]),Math.abs(h[1]),Math.abs(h[2])];if(d[0]>=180||d[1]>=180||d[2]>=180){const t=Math.max(...d)/180,s=new kt(...l,n),o=new kt(...u,n),c=(new Te).setFromEuler(s),h=(new Te).setFromEuler(o);c.dot(h)&&h.set(-h.x,-h.y,-h.z,-h.w);const p=e.times[i-1],m=e.times[i]-p,f=new Te,g=new kt;for(let e=0;e<1;e+=1/t)f.copy(c.clone().slerp(h.clone(),e)),a.push(p+e*m),g.setFromQuaternion(f,n),r.push(g.x),r.push(g.y),r.push(g.z)}else a.push(e.times[i]),r.push(et.degToRad(e.values[i])),r.push(et.degToRad(t.values[i])),r.push(et.degToRad(s.values[i]))}return[a,r]}}class Ja{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new tr,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,s=e.split(/[\r\n]+/);return s.forEach(function(e,n){const a=e.match(/^[\s\t]*;/),r=e.match(/^[\s\t]*$/);if(a||r)return;const i=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(e,i):o?t.parseNodeProperty(e,o,s[++n]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}),this.allNodes}parseNodeBegin(e,t){const s=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),a={name:s},r=this.parseNodeAttr(n),i=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(s,a):s in i?("PoseNode"===s?i.PoseNode.push(a):void 0!==i[s].id&&(i[s]={},i[s][i[s].id]=i[s]),""!==r.id&&(i[s][r.id]=a)):"number"==typeof r.id?(i[s]={},i[s][r.id]=a):"Properties70"!==s&&(i[s]="PoseNode"===s?[a]:a),"number"==typeof r.id&&(a.id=r.id),""!==r.name&&(a.attrName=r.name),""!==r.type&&(a.attrType=r.type),this.pushStack(a)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let s="",n="";return e.length>1&&(s=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:s,type:n}}parseNodeProperty(e,t,s){let n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===n&&","===a&&(a=s.replace(/"/g,"").replace(/,$/,"").trim());const r=this.getCurrentNode();if("Properties70"!==r.name){if("C"===n){const e=a.split(",").slice(1),t=parseInt(e[0]),s=parseInt(e[1]);let i=a.split(",").slice(3);i=i.map(function(e){return e.trim().replace(/^"/,"")}),n="connections",a=[t,s],function(e,t){for(let s=0,n=e.length,a=t.length;s<a;s++,n++)e[n]=t[s]}(a,i),void 0===r[n]&&(r[n]=[])}"Node"===n&&(r.id=a),n in r&&Array.isArray(r[n])?r[n].push(a):"a"!==n?r[n]=a:r.a=a,this.setCurrentProp(r,n),"a"===n&&","!==a.slice(-1)&&(r.a=ur(a))}else this.parseNodeSpecialProperty(e,n,a)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=ur(t.a))}parseNodeSpecialProperty(e,t,s){const n=s.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),a=n[0],r=n[1],i=n[2],o=n[3];let l=n[4];switch(r){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=ur(l)}this.getPrevNode()[a]={type:r,type2:i,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),a)}}class Qa{parse(e){const t=new er(e);t.skip(23);const s=t.getUint32();if(s<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+s);const n=new tr;for(;!this.endOfContent(t);){const e=this.parseNode(t,s);null!==e&&n.add(e.name,e)}return n}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const s={},n=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const r=e.getUint8(),i=e.getString(r);if(0===n)return null;const o=[];for(let h=0;h<a;h++)o.push(this.parseProperty(e));const l=o.length>0?o[0]:"",c=o.length>1?o[1]:"",u=o.length>2?o[2]:"";for(s.singleProperty=1===a&&e.getOffset()===n;n>e.getOffset();){const n=this.parseNode(e,t);null!==n&&this.parseSubNode(i,s,n)}return s.propertyList=o,"number"==typeof l&&(s.id=l),""!==c&&(s.attrName=c),""!==u&&(s.attrType=u),""!==i&&(s.name=i),s}parseSubNode(e,t,s){if(!0===s.singleProperty){const e=s.propertyList[0];Array.isArray(e)?(t[s.name]=s,s.a=e):t[s.name]=e}else if("Connections"===e&&"C"===s.name){const e=[];s.propertyList.forEach(function(t,s){0!==s&&e.push(t)}),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===s.name){Object.keys(s).forEach(function(e){t[e]=s[e]})}else if("Properties70"===e&&"P"===s.name){let e=s.propertyList[0],n=s.propertyList[1];const a=s.propertyList[2],r=s.propertyList[3];let i;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===n.indexOf("Lcl ")&&(n=n.replace("Lcl ","Lcl_")),i="Color"===n||"ColorRGB"===n||"Vector"===n||"Vector3D"===n||0===n.indexOf("Lcl_")?[s.propertyList[4],s.propertyList[5],s.propertyList[6]]:s.propertyList[4],t[e]={type:n,type2:a,flag:r,value:i}}else void 0===t[s.name]?"number"==typeof s.id?(t[s.name]={},t[s.name][s.id]=s):t[s.name]=s:"PoseNode"===s.name?(Array.isArray(t[s.name])||(t[s.name]=[t[s.name]]),t[s.name].push(s)):void 0===t[s.name][s.id]&&(t[s.name][s.id]=s)}parseProperty(e){const t=e.getString(1);let s;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return s=e.getUint32(),e.getArrayBuffer(s);case"S":return s=e.getUint32(),e.getString(s);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const n=e.getUint32(),a=e.getUint32(),r=e.getUint32();if(0===a)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}const i=ja(new Uint8Array(e.getArrayBuffer(r))),o=new er(i.buffer);switch(t){case"b":case"c":return o.getBooleanArray(n);case"d":return o.getFloat64Array(n);case"f":return o.getFloat32Array(n);case"i":return o.getInt32Array(n);case"l":return o.getInt64Array(n)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class er{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let s=0;s<e;s++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let s=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const n=s.indexOf(0);return n>=0&&(s=new Uint8Array(this.dv.buffer,t,n)),this._textDecoder.decode(s)}}class tr{add(e,t){this[e]=t}}function sr(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function nr(e){return e/46186158e3}const ar=[];function rr(e,t,s,n){let a;switch(n.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=s;break;case"AllSame":a=n.indices[0]}"IndexToDirect"===n.referenceType&&(a=n.indices[a]);const r=a*n.dataSize,i=r+n.dataSize;return function(e,t,s,n){for(let a=s,r=0;a<n;a++,r++)e[r]=t[a];return e}(ar,n.buffer,r,i)}const ir=new kt,or=new we;function lr(e){const t=new xe,s=new xe,n=new xe,a=new xe,r=new xe,i=new xe,o=new xe,l=new xe,c=new xe,u=new xe,h=new xe,d=new xe,p=e.inheritType?e.inheritType:0;e.translation&&t.setPosition(or.fromArray(e.translation));const m=cr(0);if(e.preRotation){const t=e.preRotation.map(et.degToRad);t.push(m),s.makeRotationFromEuler(ir.fromArray(t))}if(e.rotation){const t=e.rotation.map(et.degToRad);t.push(e.eulerOrder||m),n.makeRotationFromEuler(ir.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(et.degToRad);t.push(m),a.makeRotationFromEuler(ir.fromArray(t)),a.invert()}e.scale&&r.scale(or.fromArray(e.scale)),e.scalingOffset&&o.setPosition(or.fromArray(e.scalingOffset)),e.scalingPivot&&i.setPosition(or.fromArray(e.scalingPivot)),e.rotationOffset&&l.setPosition(or.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(or.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(h.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const f=s.clone().multiply(n).multiply(a),g=new xe;g.extractRotation(u);const v=new xe;v.copyPosition(u);const y=v.clone().invert().multiply(u),x=g.clone().invert().multiply(y),w=r,b=new xe;if(0===p)b.copy(g).multiply(f).multiply(x).multiply(w);else if(1===p)b.copy(g).multiply(x).multiply(f).multiply(w);else{const e=(new xe).scale((new we).setFromMatrixScale(h)).clone().invert(),t=x.clone().multiply(e);b.copy(g).multiply(f).multiply(t).multiply(w)}const T=c.clone().invert(),_=i.clone().invert();let M=t.clone().multiply(l).multiply(c).multiply(s).multiply(n).multiply(a).multiply(T).multiply(o).multiply(i).multiply(r).multiply(_);const I=(new xe).copyPosition(M),A=u.clone().multiply(I);return d.copyPosition(A),M=d.clone().multiply(b),M.premultiply(u.invert()),M}function cr(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?t[0]:t[e]}function ur(e){return e.split(",").map(function(e){return parseFloat(e)})}function hr(e,t,s){return void 0===t&&(t=0),void 0===s&&(s=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,s))}const dr={type:"change"},pr={type:"start"},mr={type:"end"},fr=new Dt,gr=new Pt,vr=Math.cos(70*et.DEG2RAD),yr=new we,xr=2*Math.PI,wr=-1,br=0,Tr=1,_r=2,Mr=3,Ir=4,Ar=5,kr=6,Rr=1e-6;class Cr extends Rt{constructor(e,t=null){super(e,t),this.state=wr,this.target=new we,this.cursor=new we,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:Ct.ROTATE,MIDDLE:Ct.DOLLY,RIGHT:Ct.PAN},this.touches={ONE:Et.ROTATE,TWO:Et.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new we,this._lastQuaternion=new Te,this._lastTargetPosition=new we,this._quat=(new Te).setFromUnitVectors(e.up,new we(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new St,this._sphericalDelta=new St,this._scale=1,this._panOffset=new we,this._rotateStart=new de,this._rotateEnd=new de,this._rotateDelta=new de,this._panStart=new de,this._panEnd=new de,this._panDelta=new de,this._dollyStart=new de,this._dollyEnd=new de,this._dollyDelta=new de,this._dollyDirection=new we,this._mouse=new de,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=Sr.bind(this),this._onPointerDown=Er.bind(this),this._onPointerUp=Dr.bind(this),this._onContextMenu=jr.bind(this),this._onMouseWheel=Nr.bind(this),this._onKeyDown=Or.bind(this),this._onTouchStart=Ur.bind(this),this._onTouchMove=Fr.bind(this),this._onMouseDown=Pr.bind(this),this._onMouseMove=Lr.bind(this),this._interceptControlDown=zr.bind(this),this._interceptControlUp=Br.bind(this),null!==this.domElement&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1});this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents();this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){null!==this._domElementKeyEvents&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(dr),this.update(),this.state=wr}update(e=null){const t=this.object.position;yr.copy(t).sub(this.target),yr.applyQuaternion(this._quat),this._spherical.setFromVector3(yr),this.autoRotate&&this.state===wr&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let s=this.minAzimuthAngle,n=this.maxAzimuthAngle;isFinite(s)&&isFinite(n)&&(s<-Math.PI?s+=xr:s>Math.PI&&(s-=xr),n<-Math.PI?n+=xr:n>Math.PI&&(n-=xr),this._spherical.theta=s<=n?Math.max(s,Math.min(n,this._spherical.theta)):this._spherical.theta>(s+n)/2?Math.max(s,this._spherical.theta):Math.min(n,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),!0===this.enableDamping?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let a=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const e=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),a=e!=this._spherical.radius}if(yr.setFromSpherical(this._spherical),yr.applyQuaternion(this._quatInverse),t.copy(this.target).add(yr),this.object.lookAt(this.target),!0===this.enableDamping?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let e=null;if(this.object.isPerspectiveCamera){const t=yr.length();e=this._clampDistance(t*this._scale);const s=t-e;this.object.position.addScaledVector(this._dollyDirection,s),this.object.updateMatrixWorld(),a=!!s}else if(this.object.isOrthographicCamera){const t=new we(this._mouse.x,this._mouse.y,0);t.unproject(this.object);const s=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),a=s!==this.object.zoom;const n=new we(this._mouse.x,this._mouse.y,0);n.unproject(this.object),this.object.position.sub(n).add(t),this.object.updateMatrixWorld(),e=yr.length()}else this.zoomToCursor=!1;null!==e&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(e).add(this.object.position):(fr.origin.copy(this.object.position),fr.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(fr.direction))<vr?this.object.lookAt(this.target):(gr.setFromNormalAndCoplanarPoint(this.object.up,this.target),fr.intersectPlane(gr,this.target))))}else if(this.object.isOrthographicCamera){const e=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),e!==this.object.zoom&&(this.object.updateProjectionMatrix(),a=!0)}return this._scale=1,this._performCursorZoom=!1,!!(a||this._lastPosition.distanceToSquared(this.object.position)>Rr||8*(1-this._lastQuaternion.dot(this.object.quaternion))>Rr||this._lastTargetPosition.distanceToSquared(this.target)>Rr)&&(this.dispatchEvent(dr),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0)}_getAutoRotationAngle(e){return null!==e?xr/60*this.autoRotateSpeed*e:xr/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(.01*e);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){yr.setFromMatrixColumn(t,0),yr.multiplyScalar(-e),this._panOffset.add(yr)}_panUp(e,t){!0===this.screenSpacePanning?yr.setFromMatrixColumn(t,1):(yr.setFromMatrixColumn(t,0),yr.crossVectors(this.object.up,yr)),yr.multiplyScalar(e),this._panOffset.add(yr)}_pan(e,t){const s=this.domElement;if(this.object.isPerspectiveCamera){const n=this.object.position;yr.copy(n).sub(this.target);let a=yr.length();a*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*a/s.clientHeight,this.object.matrix),this._panUp(2*t*a/s.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/s.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/s.clientHeight,this.object.matrix)):this.enablePan=!1}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:this.enableZoom=!1}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:this.enableZoom=!1}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const s=this.domElement.getBoundingClientRect(),n=e-s.left,a=t-s.top,r=s.width,i=s.height;this._mouse.x=n/r*2-1,this._mouse.y=-a/i*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(xr*this._rotateDelta.x/t.clientHeight),this._rotateUp(xr*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(xr*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-xr*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(xr*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-xr*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(1===this._pointers.length)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._rotateStart.set(s,n)}}_handleTouchStartPan(e){if(1===this._pointers.length)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._panStart.set(s,n)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,n=e.pageY-t.y,a=Math.sqrt(s*s+n*n);this._dollyStart.set(0,a)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(1==this._pointers.length)this._rotateEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._rotateEnd.set(s,n)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(xr*this._rotateDelta.x/t.clientHeight),this._rotateUp(xr*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(1===this._pointers.length)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._panEnd.set(s,n)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,n=e.pageY-t.y,a=Math.sqrt(s*s+n*n);this._dollyEnd.set(0,a),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._updateZoomParameters(r,i)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return void this._pointers.splice(t,1)}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new de,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,s={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:s.deltaY*=16;break;case 2:s.deltaY*=100}return e.ctrlKey&&!this._controlActive&&(s.deltaY*=10),s}}function Er(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._isTrackingPointer(e)||(this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e)))}function Sr(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function Dr(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(mr),this.state=wr;break;case 1:const t=this._pointers[0],s=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:s.x,pageY:s.y})}}function Pr(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case Ct.DOLLY:if(!1===this.enableZoom)return;this._handleMouseDownDolly(e),this.state=Tr;break;case Ct.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=_r}else{if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=br}break;case Ct.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=br}else{if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=_r}break;default:this.state=wr}this.state!==wr&&this.dispatchEvent(pr)}function Lr(e){switch(this.state){case br:if(!1===this.enableRotate)return;this._handleMouseMoveRotate(e);break;case Tr:if(!1===this.enableZoom)return;this._handleMouseMoveDolly(e);break;case _r:if(!1===this.enablePan)return;this._handleMouseMovePan(e)}}function Nr(e){!1!==this.enabled&&!1!==this.enableZoom&&this.state===wr&&(e.preventDefault(),this.dispatchEvent(pr),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(mr))}function Or(e){!1!==this.enabled&&this._handleKeyDown(e)}function Ur(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case Et.ROTATE:if(!1===this.enableRotate)return;this._handleTouchStartRotate(e),this.state=Mr;break;case Et.PAN:if(!1===this.enablePan)return;this._handleTouchStartPan(e),this.state=Ir;break;default:this.state=wr}break;case 2:switch(this.touches.TWO){case Et.DOLLY_PAN:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchStartDollyPan(e),this.state=Ar;break;case Et.DOLLY_ROTATE:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchStartDollyRotate(e),this.state=kr;break;default:this.state=wr}break;default:this.state=wr}this.state!==wr&&this.dispatchEvent(pr)}function Fr(e){switch(this._trackPointer(e),this.state){case Mr:if(!1===this.enableRotate)return;this._handleTouchMoveRotate(e),this.update();break;case Ir:if(!1===this.enablePan)return;this._handleTouchMovePan(e),this.update();break;case Ar:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchMoveDollyPan(e),this.update();break;case kr:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=wr}}function jr(e){!1!==this.enabled&&e.preventDefault()}function zr(e){if("Control"===e.key){this._controlActive=!0;this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0})}}function Br(e){if("Control"===e.key){this._controlActive=!1;this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0})}}const Hr={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class Vr{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new Ti(e)}),this.register(function(e){return new _i(e)}),this.register(function(e){return new ki(e)}),this.register(function(e){return new Ri(e)}),this.register(function(e){return new Ci(e)}),this.register(function(e){return new Ei(e)}),this.register(function(e){return new Mi(e)}),this.register(function(e){return new Ii(e)}),this.register(function(e){return new Ai(e)}),this.register(function(e){return new Si(e)}),this.register(function(e){return new Di(e)}),this.register(function(e){return new Pi(e)}),this.register(function(e){return new Li(e)}),this.register(function(e){return new Ni(e)})}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,s,n){const a=new bi,r=[];for(let i=0,o=this.pluginCallbacks.length;i<o;i++)r.push(this.pluginCallbacks[i](a));a.setPlugins(r),a.setTextureUtils(this.textureUtils),a.writeAsync(e,t,n).catch(s)}parseAsync(e,t){const s=this;return new Promise(function(n,a){s.parse(e,n,a,t)})}}const Xr=0,Gr=1,Kr=2,Wr=3,Yr=4,$r=5120,qr=5121,Zr=5122,Jr=5123,Qr=5124,ei=5125,ti=5126,si=34962,ni=34963,ai=9728,ri=9729,ii=9984,oi=9985,li=9986,ci=9987,ui=33071,hi=33648,di=10497,pi="KHR_mesh_quantization",mi={};mi[Le]=ai,mi[De]=ii,mi[Ee]=li,mi[Pe]=ri,mi[Se]=oi,mi[Ce]=ci,mi[Ue]=ui,mi[Ne]=di,mi[Oe]=hi;const fi={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},gi=new pe;function vi(e,t){return e.length===t.length&&e.every(function(e,s){return e===t[s]})}function yi(e){return 4*Math.ceil(e/4)}function xi(e,t=0){const s=yi(e.byteLength);if(s!==e.byteLength){const n=new Uint8Array(s);if(n.set(new Uint8Array(e)),0!==t)for(let a=e.byteLength;a<s;a++)n[a]=t;return n.buffer}return e}function wi(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class bi{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+Lt}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);const n=this,a=n.buffers,r=n.json;s=n.options;const i=n.extensionsUsed,o=n.extensionsRequired,l=new Blob(a,{type:"application/octet-stream"}),c=Object.keys(i),u=Object.keys(o);if(c.length>0&&(r.extensionsUsed=c),u.length>0&&(r.extensionsRequired=u),r.buffers&&r.buffers.length>0&&(r.buffers[0].byteLength=l.size),!0===s.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const s=xi(e.result),n=new DataView(new ArrayBuffer(8));n.setUint32(0,s.byteLength,!0),n.setUint32(4,5130562,!0);const a=xi((i=JSON.stringify(r),(new TextEncoder).encode(i).buffer),32);var i;const o=new DataView(new ArrayBuffer(8));o.setUint32(0,a.byteLength,!0),o.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,1179937895,!0),c.setUint32(4,2,!0);const u=12+o.byteLength+a.byteLength+n.byteLength+s.byteLength;c.setUint32(8,u,!0);const h=new Blob([l,o,a,n,s],{type:"application/octet-stream"}),d=new FileReader;d.readAsArrayBuffer(h),d.onloadend=function(){t(d.result)}}}else if(r.buffers&&r.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const s=e.result;r.buffers[0].uri=s,t(r)}}else t(r)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const s=this.options,n=this.extensionsUsed;try{const a=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&a.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in a.gltfExtensions)t.extensions[e]=a.gltfExtensions[e],n[e]=!0;delete a.gltfExtensions}Object.keys(a).length>0&&(t.extras=a)}catch(a){}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new we;for(let s=0,n=e.count;s<n;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const s=e.clone(),n=new we;for(let a=0,r=s.count;a<r;a++)n.fromBufferAttribute(s,a),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),s.setXYZ(a,n.x,n.y,n.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1;const n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(n.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function s(e){return e.colorSpace===fe?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof Nt&&(e=await this.decompressTextureAsync(e)),t instanceof Nt&&(t=await this.decompressTextureAsync(t));const n=e?e.image:null,a=t?t.image:null,r=Math.max(n?n.width:0,a?a.width:0),i=Math.max(n?n.height:0,a?a.height:0),o=wi();o.width=r,o.height=i;const l=o.getContext("2d",{willReadFrequently:!0});l.fillStyle="#00ffff",l.fillRect(0,0,r,i);const c=l.getImageData(0,0,r,i);if(n){l.drawImage(n,0,0,r,i);const t=s(e),a=l.getImageData(0,0,r,i).data;for(let e=2;e<a.length;e+=4)c.data[e]=256*t(a[e]/256)}if(a){l.drawImage(a,0,0,r,i);const e=s(t),n=l.getImageData(0,0,r,i).data;for(let t=1;t<n.length;t+=4)c.data[t]=256*e(n[t]/256)}l.putImageData(c,0,0);const u=(e||t).clone();return u.source=new Ot(o),u.colorSpace=Ut,u.channel=(e||t).channel,e&&t&&(e.channel,t.channel),u}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,n,a){const r=this.json;let i;switch(r.bufferViews||(r.bufferViews=[]),t){case $r:case qr:i=1;break;case Zr:case Jr:i=2;break;default:i=4}let o=e.itemSize*i;a===si&&(o=4*Math.ceil(o/4));const l=yi(n*o),c=new DataView(new ArrayBuffer(l));let u=0;for(let d=s;d<s+n;d++){for(let s=0;s<e.itemSize;s++){let n;e.itemSize>4?n=e.array[d*e.itemSize+s]:(0===s?n=e.getX(d):1===s?n=e.getY(d):2===s?n=e.getZ(d):3===s&&(n=e.getW(d)),!0===e.normalized&&(n=et.normalize(n,e.array))),t===ti?c.setFloat32(u,n,!0):t===Qr?c.setInt32(u,n,!0):t===ei?c.setUint32(u,n,!0):t===Zr?c.setInt16(u,n,!0):t===Jr?c.setUint16(u,n,!0):t===$r?c.setInt8(u,n):t===qr&&c.setUint8(u,n),u+=i}u%o!==0&&(u+=o-u%o)}const h={buffer:this.processBuffer(c.buffer),byteOffset:this.byteOffset,byteLength:l};void 0!==a&&(h.target=a),a===si&&(h.byteStride=o),this.byteOffset+=l,r.bufferViews.push(h);return{id:r.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise(function(n){const a=new FileReader;a.readAsArrayBuffer(e),a.onloadend=function(){const e=xi(a.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(s.bufferViews.push(r)-1)}})}processAccessor(e,t,s,n){const a=this.json;let r;if(e.array.constructor===Float32Array)r=ti;else if(e.array.constructor===Int32Array)r=Qr;else if(e.array.constructor===Uint32Array)r=ei;else if(e.array.constructor===Int16Array)r=Zr;else if(e.array.constructor===Uint16Array)r=Jr;else if(e.array.constructor===Int8Array)r=$r;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);r=qr}if(void 0===s&&(s=0),void 0!==n&&n!==1/0||(n=e.count),0===n)return null;const i=function(e,t,s){const n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let a=t;a<t+s;a++)for(let t=0;t<e.itemSize;t++){let s;e.itemSize>4?s=e.array[a*e.itemSize+t]:(0===t?s=e.getX(a):1===t?s=e.getY(a):2===t?s=e.getZ(a):3===t&&(s=e.getW(a)),!0===e.normalized&&(s=et.normalize(s,e.array))),n.min[t]=Math.min(n.min[t],s),n.max[t]=Math.max(n.max[t],s)}return n}(e,s,n);let o;void 0!==t&&(o=e===t.index?ni:si);const l=this.processBufferView(e,r,s,n,o),c={bufferView:l.id,byteOffset:l.byteOffset,componentType:r,count:n,max:i.max,min:i.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(c)-1}processImage(e,t,s,n="image/png"){if(null!==e){const t=this,a=t.cache,r=t.json,i=t.options,o=t.pending;a.images.has(e)||a.images.set(e,{});const l=a.images.get(e),c=n+":flipY/"+s.toString();if(void 0!==l[c])return l[c];r.images||(r.images=[]);const u={mimeType:n},h=wi();h.width=Math.min(e.width,i.maxTextureSize),h.height=Math.min(e.height,i.maxTextureSize);const d=h.getContext("2d",{willReadFrequently:!0});if(!0===s&&(d.translate(0,h.height),d.scale(1,-1)),void 0!==e.data){e.width>i.maxTextureSize||(e.height,i.maxTextureSize);const t=new Uint8ClampedArray(e.height*e.width*4);for(let s=0;s<t.length;s+=4)t[s+0]=e.data[s+0],t[s+1]=e.data[s+1],t[s+2]=e.data[s+2],t[s+3]=e.data[s+3];d.putImageData(new ImageData(t,e.width,e.height),0,0)}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");d.drawImage(e,0,0,h.width,h.height)}!0===i.binary?o.push(function(e,t){if("undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas){let s;return"image/jpeg"===t?s=.92:"image/webp"===t&&(s=.8),e.convertToBlob({type:t,quality:s})}return new Promise(s=>e.toBlob(s,t))}(h,n).then(e=>t.processBufferViewImage(e)).then(e=>{u.bufferView=e})):u.uri=jt.getDataURL(h,n);const p=r.images.push(u)-1;return l[c]=p,p}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:mi[e.magFilter],minFilter:mi[e.minFilter],wrapS:mi[e.wrapS],wrapT:mi[e.wrapT]};return t.samplers.push(s)-1}async processTextureAsync(e){const t=this.options,s=this.cache,n=this.json;if(s.textures.has(e))return s.textures.get(e);n.textures||(n.textures=[]),e instanceof Nt&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let a=e.userData.mimeType;"image/webp"===a&&(a="image/png");const r={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,a)};e.name&&(r.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,r)});const i=n.textures.push(r)-1;return s.textures.set(e,i),i}async processMaterialAsync(e){const t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return null;s.materials||(s.materials=[]);const n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&e.isMeshBasicMaterial;const a=e.color.toArray().concat([e.opacity]);if(vi(a,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=a),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=0,n.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){const t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),s={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(s,t),n.pbrMetallicRoughness.metallicRoughnessTexture=s}if(e.map){const t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),n.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(n.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),n.emissiveTexture=t}}if(e.normalMap){const t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),n.normalTexture=t}if(e.aoMap){const t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),n.occlusionTexture=t}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===He&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,n)});const r=s.materials.push(n)-1;return t.materials.set(e,r),r}async processMeshAsync(e){const t=this.cache,s=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let x=0,w=e.material.length;x<w;x++)n.push(e.material[x].uuid);else n.push(e.material.uuid);const a=n.join(":");if(t.meshes.has(a))return t.meshes.get(a);const r=e.geometry;let i;i=e.isLineSegments?Gr:e.isLineLoop?Kr:e.isLine?Wr:e.isPoints?Xr:e.material.wireframe?Gr:Yr;const o={},l={},c=[],u=[],h={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=r.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||r.setAttribute("normal",this.createNormalizedNormalAttribute(d));let p=null;for(let x in r.attributes){if("morph"===x.slice(0,5))continue;const e=r.attributes[x];x=h[x]||x.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(x)||(x="_"+x),t.attributes.has(this.getUID(e))){l[x]=t.attributes.get(this.getUID(e));continue}p=null;const s=e.array;"JOINTS_0"!==x||s instanceof Uint16Array||s instanceof Uint8Array?(s instanceof Uint32Array||s instanceof Int32Array)&&!x.startsWith("_")&&(p=Vr.Utils.toFloat32BufferAttribute(e)):p=new ke(new Uint16Array(s),e.itemSize,e.normalized);const n=this.processAccessor(p||e,r);null!==n&&(x.startsWith("_")||this.detectMeshQuantization(x,e),l[x]=n,t.attributes.set(this.getUID(e),n))}if(void 0!==d&&r.setAttribute("normal",d),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const s=[],n=[],a={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)a[e.morphTargetDictionary[t]]=t;for(let i=0;i<e.morphTargetInfluences.length;++i){const o={};let l=!1;for(const e in r.morphAttributes){if("position"!==e&&"normal"!==e){l||(l=!0);continue}const s=r.morphAttributes[e][i],n=e.toUpperCase(),a=r.attributes[e];if(t.attributes.has(this.getUID(s,!0))){o[n]=t.attributes.get(this.getUID(s,!0));continue}const c=s.clone();if(!r.morphTargetsRelative)for(let e=0,t=s.count;e<t;e++)for(let n=0;n<s.itemSize;n++)0===n&&c.setX(e,s.getX(e)-a.getX(e)),1===n&&c.setY(e,s.getY(e)-a.getY(e)),2===n&&c.setZ(e,s.getZ(e)-a.getZ(e)),3===n&&c.setW(e,s.getW(e)-a.getW(e));o[n]=this.processAccessor(c,r),t.attributes.set(this.getUID(a,!0),o[n])}u.push(o),s.push(e.morphTargetInfluences[i]),void 0!==e.morphTargetDictionary&&n.push(a[i])}o.weights=s,n.length>0&&(o.extras={},o.extras.targetNames=n)}const m=Array.isArray(e.material);if(m&&0===r.groups.length)return null;let f=!1;if(m&&null===r.index){const e=[];for(let t=0,s=r.attributes.position.count;t<s;t++)e[t]=t;r.setIndex(e),f=!0}const g=m?e.material:[e.material],v=m?r.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let x=0,w=v.length;x<w;x++){const e={mode:i,attributes:l};if(this.serializeUserData(r,e),u.length>0&&(e.targets=u),null!==r.index){let s=this.getUID(r.index);void 0===v[x].start&&void 0===v[x].count||(s+=":"+v[x].start+":"+v[x].count),t.attributes.has(s)?e.indices=t.attributes.get(s):(e.indices=this.processAccessor(r.index,r,v[x].start,v[x].count),t.attributes.set(s,e.indices)),null===e.indices&&delete e.indices}const s=await this.processMaterialAsync(g[v[x].materialIndex]);null!==s&&(e.material=s),c.push(e)}!0===f&&r.setIndex(null),o.primitives=c,s.meshes||(s.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,o)});const y=s.meshes.push(o)-1;return t.meshes.set(a,y),y}detectMeshQuantization(e,t){if(this.extensionsUsed[pi])return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");const n=e.split("_",1)[0];Hr[n]&&Hr[n].includes(s)&&(this.extensionsUsed[pi]=!0,this.extensionsRequired[pi]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const s=e.isOrthographicCamera,n={type:s?"orthographic":"perspective"};return s?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:et.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){const s=this.json,n=this.nodeMap;s.animations||(s.animations=[]);const a=(e=Vr.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,r=[],i=[];for(let l=0;l<a.length;++l){const e=a[l],s=Xe.parseTrackName(e.name);let o=Xe.findNode(t,s.nodeName);const c=fi[s.propertyName];if("bones"===s.objectName&&(o=!0===o.isSkinnedMesh?o.skeleton.getBoneByName(s.objectIndex):void 0),!o||!c)continue;const u=1;let h,d=e.values.length/e.times.length;c===fi.morphTargetInfluences&&(d/=o.morphTargetInfluences.length),!0===e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(h="CUBICSPLINE",d/=3):h=e.getInterpolation()===rt?"STEP":"LINEAR",i.push({input:this.processAccessor(new ke(e.times,u)),output:this.processAccessor(new ke(e.values,d)),interpolation:h}),r.push({sampler:i.length-1,target:{node:n.get(o),path:c}})}const o={name:e.name||"clip_"+s.animations.length,samplers:i,channels:r};return this.serializeUserData(e,o),s.animations.push(o),s.animations.length-1}processSkin(e){const t=this.json,s=this.nodeMap,n=t.nodes[s.get(e)],a=e.skeleton;if(void 0===a)return null;const r=e.skeleton.bones[0];if(void 0===r)return null;const i=[],o=new Float32Array(16*a.bones.length),l=new xe;for(let c=0;c<a.bones.length;++c)i.push(s.get(a.bones[c])),l.copy(a.boneInverses[c]),l.multiply(e.bindMatrix).toArray(o,16*c);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new ke(o,16)),joints:i,skeleton:s.get(r)});return n.skin=t.skins.length-1}async processNodeAsync(e){const t=this.json,s=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const a={};if(s.trs){const t=e.quaternion.toArray(),s=e.position.toArray(),n=e.scale.toArray();vi(t,[0,0,0,1])||(a.rotation=t),vi(s,[0,0,0])||(a.translation=s),vi(n,[1,1,1])||(a.scale=n)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===vi(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(a.matrix=e.matrix.elements);if(""!==e.name&&(a.name=String(e.name)),this.serializeUserData(e,a),e.isMesh||e.isLine||e.isPoints){const t=await this.processMeshAsync(e);null!==t&&(a.mesh=t)}else e.isCamera&&(a.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);const r=t.nodes.push(a)-1;if(n.set(e,r),e.children.length>0){const t=[];for(let n=0,a=e.children.length;n<a;n++){const a=e.children[n];if(a.visible||!1===s.onlyVisible){const e=await this.processNodeAsync(a);null!==e&&t.push(e)}}t.length>0&&(a.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,a)}),r}async processSceneAsync(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);const a=[];for(let r=0,i=e.children.length;r<i;r++){const t=e.children[r];if(t.visible||!1===s.onlyVisible){const e=await this.processNodeAsync(t);null!==e&&a.push(e)}}a.length>0&&(n.nodes=a),this.serializeUserData(e,n)}async processObjectsAsync(e){const t=new zt;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);await this.processSceneAsync(t)}async processInputAsync(e){const t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});const s=[];for(let n=0;n<e.length;n++)e[n]instanceof zt?await this.processSceneAsync(e[n]):s.push(e[n]);s.length>0&&await this.processObjectsAsync(s);for(let n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,s=this.plugins.length;t<s;t++)await e(this.plugins[t])}}class Ti{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return;const s=this.writer,n=s.json,a=s.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(1-e.penumbra)*e.angle,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&e.decay,e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||e.target.position.z),a[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},a[this.name]=!0);const i=n.extensions[this.name].lights;i.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:i.length-1}}}class _i{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class Mi{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const s=this.writer,n=s.extensionsUsed,a={};if(a.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:await s.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(t,e.clearcoatMap),a.clearcoatTexture=t}if(a.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:await s.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(t,e.clearcoatRoughnessMap),a.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:await s.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),s.applyTextureTransform(t,e.clearcoatNormalMap),a.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Ii{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;const s=this.writer.extensionsUsed,n={};n.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}}class Ai{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const s=this.writer,n=s.extensionsUsed,a={};if(a.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:await s.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(t,e.iridescenceMap),a.iridescenceTexture=t}if(a.iridescenceIor=e.iridescenceIOR,a.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],a.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:await s.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(t,e.iridescenceThicknessMap),a.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class ki{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,n=s.extensionsUsed,a={};if(a.transmissionFactor=e.transmission,e.transmissionMap){const t={index:await s.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(t,e.transmissionMap),a.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Ri{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,n=s.extensionsUsed,a={};if(a.thicknessFactor=e.thickness,e.thicknessMap){const t={index:await s.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(t,e.thicknessMap),a.thicknessTexture=t}e.attenuationDistance!==1/0&&(a.attenuationDistance=e.attenuationDistance),a.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Ci{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const s=this.writer.extensionsUsed,n={};n.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}}class Ei{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(gi)&&!e.specularIntensityMap&&!e.specularColorMap)return;const s=this.writer,n=s.extensionsUsed,a={};if(e.specularIntensityMap){const t={index:await s.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(t,e.specularIntensityMap),a.specularTexture=t}if(e.specularColorMap){const t={index:await s.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(t,e.specularColorMap),a.specularColorTexture=t}a.specularFactor=e.specularIntensity,a.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Si{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const s=this.writer,n=s.extensionsUsed,a={};if(e.sheenRoughnessMap){const t={index:await s.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(t,e.sheenRoughnessMap),a.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:await s.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(t,e.sheenColorMap),a.sheenColorTexture=t}a.sheenRoughnessFactor=e.sheenRoughness,a.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Di{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const s=this.writer,n=s.extensionsUsed,a={};if(e.anisotropyMap){const t={index:await s.processTextureAsync(e.anisotropyMap)};s.applyTextureTransform(t,e.anisotropyMap),a.anisotropyTexture=t}a.anisotropyStrength=e.anisotropy,a.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Pi{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const s=this.writer.extensionsUsed,n={};n.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}}class Li{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;const s=this.writer,n=s.extensionsUsed,a={};if(e.bumpMap){const t={index:await s.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};s.applyTextureTransform(t,e.bumpMap),a.bumpTexture=t}a.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}class Ni{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const s=this.writer,n=e,a=new Float32Array(3*n.count),r=new Float32Array(4*n.count),i=new Float32Array(3*n.count),o=new xe,l=new we,c=new Te,u=new we;for(let d=0;d<n.count;d++)n.getMatrixAt(d,o),o.decompose(l,c,u),l.toArray(a,3*d),c.toArray(r,4*d),u.toArray(i,3*d);const h={TRANSLATION:s.processAccessor(new ke(a,3)),ROTATION:s.processAccessor(new ke(r,4)),SCALE:s.processAccessor(new ke(i,3))};n.instanceColor&&(h._COLOR_0=s.processAccessor(n.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},s.extensionsUsed[this.name]=!0,s.extensionsRequired[this.name]=!0}}Vr.Utils={insertKeyframe:function(e,t){const s=.001,n=e.getValueSize(),a=new e.TimeBufferType(e.times.length+1),r=new e.ValueBufferType(e.values.length+n),i=e.createInterpolant(new e.ValueBufferType(n));let o;if(0===e.times.length){a[0]=t;for(let e=0;e<n;e++)r[e]=0;o=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;a[0]=t,a.set(e.times,1),r.set(i.evaluate(t),0),r.set(e.values,n),o=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;a[a.length-1]=t,a.set(e.times,0),r.set(e.values,0),r.set(i.evaluate(t),e.values.length),o=a.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<s)return l;if(e.times[l]<t&&e.times[l+1]>t){a.set(e.times.slice(0,l+1),0),a[l+1]=t,a.set(e.times.slice(l+1),l+2),r.set(e.values.slice(0,(l+1)*n),0),r.set(i.evaluate(t),(l+1)*n),r.set(e.values.slice((l+1)*n),(l+2)*n),o=l+1;break}}return e.times=a,e.values=r,o},mergeMorphTargetTracks:function(e,t){const s=[],n={},a=e.tracks;for(let r=0;r<a.length;++r){let e=a[r];const i=Xe.parseTrackName(e.name),o=Xe.findNode(t,i.nodeName);if("morphTargetInfluences"!==i.propertyName||void 0===i.propertyIndex){s.push(e);continue}if(e.createInterpolant!==e.InterpolantFactoryMethodDiscrete&&e.createInterpolant!==e.InterpolantFactoryMethodLinear){if(e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");e=e.clone(),e.setInterpolation(it)}const l=o.morphTargetInfluences.length,c=o.morphTargetDictionary[i.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+i.propertyIndex);let u;if(void 0===n[o.uuid]){u=e.clone();const t=new u.ValueBufferType(l*u.times.length);for(let e=0;e<u.times.length;e++)t[e*l+c]=u.values[e];u.name=(i.nodeName||"")+".morphTargetInfluences",u.values=t,n[o.uuid]=u,s.push(u);continue}const h=e.createInterpolant(new e.ValueBufferType(1));u=n[o.uuid];for(let t=0;t<u.times.length;t++)u.values[t*l+c]=h.evaluate(u.times[t]);for(let t=0;t<e.times.length;t++){const s=this.insertKeyframe(u,e.times[t]);u.values[s*l+c]=e.values[t]}}return e.tracks=s,e},toFloat32BufferAttribute:function(e){const t=new ke(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let s=0,n=e.count;s<n;s++)for(let a=0;a<e.itemSize;a++)t.setComponent(s,a,e.getComponent(s,a));return t}};class Oi{parse(e){let t="",s=0,n=0,a=0;const r=new we,i=new pe,o=new we,l=new de,c=[];return e.traverse(function(e){!0===e.isMesh&&function(e){let i=0,u=0,h=0;const d=e.geometry,p=new It,m=d.getAttribute("position"),f=d.getAttribute("normal"),g=d.getAttribute("uv"),v=d.getIndex();if(t+="o "+e.name+"\n",e.material&&e.material.name&&(t+="usemtl "+e.material.name+"\n"),void 0!==m)for(let s=0,n=m.count;s<n;s++,i++)r.fromBufferAttribute(m,s),r.applyMatrix4(e.matrixWorld),t+="v "+r.x+" "+r.y+" "+r.z+"\n";if(void 0!==g)for(let s=0,n=g.count;s<n;s++,h++)l.fromBufferAttribute(g,s),t+="vt "+l.x+" "+l.y+"\n";if(void 0!==f){p.getNormalMatrix(e.matrixWorld);for(let e=0,s=f.count;e<s;e++,u++)o.fromBufferAttribute(f,e),o.applyMatrix3(p).normalize(),t+="vn "+o.x+" "+o.y+" "+o.z+"\n"}if(null!==v)for(let r=0,o=v.count;r<o;r+=3){for(let e=0;e<3;e++){const t=v.getX(r+e)+1;c[e]=s+t+(f||g?"/"+(g?n+t:"")+(f?"/"+(a+t):""):"")}t+="f "+c.join(" ")+"\n"}else for(let r=0,o=m.count;r<o;r+=3){for(let e=0;e<3;e++){const t=r+e+1;c[e]=s+t+(f||g?"/"+(g?n+t:"")+(f?"/"+(a+t):""):"")}t+="f "+c.join(" ")+"\n"}s+=i,n+=h,a+=u}(e),!0===e.isLine&&function(e){let n=0;const a=e.geometry,i=e.type,o=a.getAttribute("position");if(t+="o "+e.name+"\n",void 0!==o)for(let s=0,l=o.count;s<l;s++,n++)r.fromBufferAttribute(o,s),r.applyMatrix4(e.matrixWorld),t+="v "+r.x+" "+r.y+" "+r.z+"\n";if("Line"===i){t+="l ";for(let e=1,n=o.count;e<=n;e++)t+=s+e+" ";t+="\n"}if("LineSegments"===i)for(let r=1,l=r+1,c=o.count;r<c;r+=2,l=r+1)t+="l "+(s+r)+" "+(s+l)+"\n";s+=n}(e),!0===e.isPoints&&function(e){let n=0;const a=e.geometry,o=a.getAttribute("position"),l=a.getAttribute("color");if(t+="o "+e.name+"\n",void 0!==o){for(let s=0,a=o.count;s<a;s++,n++)r.fromBufferAttribute(o,s),r.applyMatrix4(e.matrixWorld),t+="v "+r.x+" "+r.y+" "+r.z,void 0!==l&&(i.fromBufferAttribute(l,s),dt.workingToColorSpace(i,fe),t+=" "+i.r+" "+i.g+" "+i.b),t+="\n";t+="p ";for(let e=1,n=o.count;e<=n;e++)t+=s+e+" ";t+="\n"}s+=n}(e)}),t}}class Ui{parse(e,t={}){const s=(t=Object.assign({binary:!1},t)).binary,n=[];let a,r=0;e.traverse(function(e){if(e.isMesh){const t=e.geometry,s=t.index,a=t.getAttribute("position");r+=null!==s?s.count/3:a.count/3,n.push({object3d:e,geometry:t})}});let i=80;if(!0===s){const e=new ArrayBuffer(2*r+3*r*4*4+80+4);a=new DataView(e),a.setUint32(i,r,!0),i+=4}else a="",a+="solid exported\n";const o=new we,l=new we,c=new we,u=new we,h=new we,d=new we;for(let f=0,g=n.length;f<g;f++){const e=n[f].object3d,t=n[f].geometry,s=t.index,a=t.getAttribute("position");if(null!==s)for(let n=0;n<s.count;n+=3){p(s.getX(n+0),s.getX(n+1),s.getX(n+2),a,e)}else for(let n=0;n<a.count;n+=3){p(n+0,n+1,n+2,a,e)}}return!1===s&&(a+="endsolid exported\n"),a;function p(e,t,n,r,p){var f,g,v;o.fromBufferAttribute(r,e),l.fromBufferAttribute(r,t),c.fromBufferAttribute(r,n),!0===p.isSkinnedMesh&&(p.applyBoneTransform(e,o),p.applyBoneTransform(t,l),p.applyBoneTransform(n,c)),o.applyMatrix4(p.matrixWorld),l.applyMatrix4(p.matrixWorld),c.applyMatrix4(p.matrixWorld),f=o,g=l,v=c,u.subVectors(v,g),h.subVectors(f,g),u.cross(h).normalize(),d.copy(u).normalize(),!0===s?(a.setFloat32(i,d.x,!0),i+=4,a.setFloat32(i,d.y,!0),i+=4,a.setFloat32(i,d.z,!0),i+=4):(a+="\tfacet normal "+d.x+" "+d.y+" "+d.z+"\n",a+="\t\touter loop\n"),m(o),m(l),m(c),!0===s?(a.setUint16(i,0,!0),i+=2):(a+="\t\tendloop\n",a+="\tendfacet\n")}function m(e){!0===s?(a.setFloat32(i,e.x,!0),i+=4,a.setFloat32(i,e.y,!0),i+=4,a.setFloat32(i,e.z,!0),i+=4):a+="\t\t\tvertex "+e.x+" "+e.y+" "+e.z+"\n"}}}const Fi={key:0,class:"loading-overlay"},ji={class:"loading-progress"},zi={class:"loading-bar"},Bi={key:1,class:"error-overlay"},Hi={class:"error-text"},Vi={class:"error-message"},Xi={__name:"index",props:{modelUrl:{type:String,default:""},containerWidth:{type:Number,default:200},showBorder:{type:Boolean,default:!0},borderRadius:{type:Number,default:8},backgroundColor:{type:String,default:"#1a1a1a"},enableControls:{type:Boolean,default:!0},autoRotate:{type:Boolean,default:!0},rotationSpeed:{type:Number,default:.005},cameraDistance:{type:Number,default:5},fullScreen:{type:Boolean,default:!1},useStarryBackground:{type:Boolean,default:!1}},emits:["loading","loaded","error"],setup(e,{expose:p,emit:m}){const{t:f}=_(),g=e,v=m,y=n(()=>{if(g.fullScreen)return{width:"100%",height:"100%",borderRadius:`${g.borderRadius}px`,border:g.showBorder?"1px solid #e0e0e0":"none",backgroundColor:g.backgroundColor};const e=g.containerWidth;return{width:`${e}px`,height:`${16*e/9}px`,borderRadius:`${g.borderRadius}px`,border:g.showBorder?"1px solid #e0e0e0":"none",backgroundColor:g.backgroundColor}});let w,b,T,M,I,k,R=new Map;const C=t(null);let E=null,S=null;const D=t(!1),P=t(0),L=t(null),N=()=>{if(g.fullScreen&&C.value){const e=C.value,t=e.getBoundingClientRect(),s=e.parentElement;return{width:Math.floor(t.width||e.clientWidth||(s?s.clientWidth:0)||window.innerWidth),height:Math.floor(t.height||e.clientHeight||(s?s.clientHeight:0)||window.innerHeight)}}const e=g.containerWidth;return{width:e,height:16*e/9}},O=()=>{const e=new Ge,t=new Float32Array(4500);for(let n=0;n<1500;n++){const e=50;t[3*n]=(Math.random()-.5)*e*2,t[3*n+1]=(Math.random()-.5)*e*2,t[3*n+2]=(Math.random()-.5)*e*2}e.setAttribute("position",new ke(t,3));const s=new Fe({color:12371411,size:.08,sizeAttenuation:!0});E=new Ze(e,s),w.add(E)},U=e=>{D.value=!0,P.value=0,L.value=null,v("loading");const t=e.split(".").pop().toLowerCase();let s;s="fbx"===t?new Ya:new mn,s.load(e,e=>{M&&(w.remove(M),M.geometry&&M.geometry.dispose(),M.material&&(Array.isArray(M.material)?M.material.forEach(e=>e.dispose()):M.material.dispose())),M="fbx"===t?e:e.scene,M.traverse(e=>{e.isMesh&&e.material&&(e.material.transparent=!1,e.material.alphaTest=.01,"MeshStandardMaterial"!==e.material.type&&"MeshPhysicalMaterial"!==e.material.type||(e.material.metalness=Math.min(e.material.metalness||0,.5),e.material.roughness=Math.max(e.material.roughness||.5,.5)))});const s=(new ft).setFromObject(M),n=s.getCenter(new we),a=s.getSize(new we);M.position.x=-n.x,M.position.y=-n.y,M.position.z=-n.z;const r=2/Math.max(a.x,a.y,a.z);M.scale.multiplyScalar(r),w.add(M),D.value=!1,z(),v("loaded")},e=>{const t=e.loaded/e.total*100;P.value=t},e=>{L.value="æ¨¡åž‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–æ ¼å¼æ˜¯å¦æ­£ç¡®",D.value=!1,F(),z(),v("error",String(e)),v("loaded")})},F=()=>{M&&(w.remove(M),M.geometry&&M.geometry.dispose(),M.material&&(Array.isArray(M.material)?M.material.forEach(e=>e.dispose()):M.material.dispose()));const e=new Vt(2,2,2),t=new Be({color:4360181,metalness:.3,roughness:.4});M=new We(e,t),w.add(M),v("loaded")},j=()=>{k=requestAnimationFrame(j),I&&I.update(),M&&g.autoRotate&&(M.rotation.y+=g.rotationSpeed),T&&w&&b&&T.render(w,b)},z=()=>{if(!b||!T||!C.value)return;const e=C.value,t=e.parentElement,s=Math.floor(e.clientWidth||(t?t.clientWidth:0)||window.innerWidth),n=Math.floor(e.clientHeight||(t?t.clientHeight:0)||window.innerHeight);s<=0||n<=0||(b.aspect=s/n,b.updateProjectionMatrix(),T.setSize(s,n,!1),T.domElement.style.width="100%",T.domElement.style.height="100%")};a(()=>g.containerWidth,e=>{if(T&&b){const t=e/(16*e/9);b.aspect=t,b.updateProjectionMatrix(),T.setSize(e,16*e/9)}}),a(()=>g.backgroundColor,e=>{g.useStarryBackground||(w&&(w.background=new pe(e)),T&&T.setClearColor(e,1))}),a(()=>g.modelUrl,e=>{w&&e?U(e):w&&!e&&F()}),a(()=>g.cameraDistance,e=>{b&&(b.position.z=e,I&&(I.minDistance=.5*e,I.maxDistance=10*e,I.update()))}),s(async()=>{await r(),requestAnimationFrame(()=>{(()=>{if(!C.value)return;w=new zt,w.background=new pe(g.useStarryBackground?"#0b0d12":g.backgroundColor);const e=N();if(b=new Qe(75,e.width/e.height,.1,1e3),b.position.z=g.cameraDistance,T=new Bt({antialias:!0,alpha:!0}),T.setSize(e.width,e.height),T.setPixelRatio(window.devicePixelRatio),T.setClearColor(g.backgroundColor,1),C.value.appendChild(T.domElement),T.domElement.style.width="100%",T.domElement.style.height="100%",g.enableControls&&(I=new Cr(b,T.domElement),I.enableDamping=!0,I.dampingFactor=.05,I.screenSpacePanning=!1,I.minDistance=.5*g.cameraDistance,I.maxDistance=10*g.cameraDistance,I.maxPolarAngle=Math.PI),g.useStarryBackground)O();else{const e=new Ht(10,10,4473924,2236962);e.position.y=-2,w.add(e)}const t=new Tt(16777215,.6);w.add(t);const s=new ye(16777215,.8);s.position.set(1,1,1),w.add(s),g.modelUrl?U(g.modelUrl):F(),j()})(),z(),window.addEventListener("resize",z),C.value&&"undefined"!=typeof ResizeObserver&&(S=new ResizeObserver(()=>z()),S.observe(C.value))})}),A(()=>{if(window.removeEventListener("resize",z),S){try{S.disconnect()}catch(bc){}S=null}(()=>{if(k&&cancelAnimationFrame(k),I&&(I.dispose(),I=null),M){const e=e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())};"Scene"===M.type||"Group"===M.type?M.traverse(t=>{e(t)}):e(M),w.remove(M),M=null}T&&(T.dispose(),C.value&&T.domElement&&C.value.removeChild(T.domElement),T=null),E&&(E.geometry&&E.geometry.dispose(),E.material&&E.material.dispose(),w&&w.remove(E),E=null),w=null,b=null})()});return p({exportModel:()=>{if(!w||!b||!T)return null;const e=new zt,t=b.clone();if(M){const t=M.clone();e.add(t)}T.render(e,t);const s=T.domElement.toDataURL("image/png");return e.clear(),s},exportAsGLB:()=>{if(!M)return;(new Vr).parse(M,e=>{const t=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="model.glb",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)},e=>{},{binary:!0})},exportAsOBJ:()=>{if(!M)return;const e=(new Oi).parse(M),t=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="model.obj",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)},exportAsSTL:()=>{if(!M)return;const e=(new Ui).parse(M),t=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="model.stl",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)},exportAsFBX:()=>{if(!M)return;(new Vr).parse(M,e=>{const t=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="model_for_fbx_conversion.glb",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)},e=>{},{binary:!0})},setWireframe:e=>{M&&M.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(t=>t.wireframe=e):t.material.wireframe=e)})},setWhiteMode:e=>{M&&(e?(R.clear(),M.traverse(e=>{if(e.isMesh&&e.material){R.set(e.uuid,e.material);const t=new Be({color:16777215,metalness:0,roughness:1});Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose(),e.material=t}})):(M.traverse(e=>{if(e.isMesh){const t=R.get(e.uuid);t&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material&&e.material.dispose(),e.material=t)}}),R.clear()))}}),(t,s)=>(o(),i("div",{class:d(["model-viewer-wrapper",{fullscreen:e.fullScreen}])},[l("div",{ref_key:"containerRef",ref:C,class:"three-model-container",style:x(y.value)},[D.value?(o(),i("div",Fi,[l("div",ji,u(Math.round(P.value))+"%",1),l("div",zi,[l("div",{class:"loading-progress-bar",style:x({width:P.value+"%"})},null,4)])])):c("",!0),L.value?(o(),i("div",Bi,[s[0]||(s[0]=l("div",{class:"error-icon"},"âš ï¸",-1)),l("div",Hi,u(h(f)("modelCard.loadingErrorText")),1),l("div",Vi,u(L.value),1)])):c("",!0)],4)],2))}},Gi=D(Xi,[["__scopeId","data-v-10640bad"]]),Ki={class:"ip-card-wrapper"},Wi={key:0,class:"image-preview"},Yi=["src"],$i={class:"generating-indicator"},qi={class:"progress-bar"},Zi={class:"progress-background-text"},Ji={key:1,style:{position:"relative"}},Qi={key:0,class:"right-circular-controls"},eo=D({__name:"index",props:{projectId:{type:String,default:""},cardData:{type:Object,default:()=>({})},backgroundColor:{type:String,default:"#1a1a1a"},cardWidth:{type:[Number,String],default:200},showBorder:{type:Boolean,default:!0},borderRadius:{type:Number,default:8},clickDisabled:{type:Boolean,default:!1}},emits:["clickModel","refineModel","save-project","delete","customize-to-home"],setup(e,{emit:a}){const{t:r}=_(),p=a,m=new Xt,g=t(!1),v=t(null),y=t(!0),b=t(!0),T=t(!0),M=t(0),I=t(!1),A=t(!1),k=()=>{const e={modelUrl:F.value,imageUrl:N.cardData.imageUrl,projectId:N.projectId,altText:N.altText,cardId:N.cardId,cardWidth:N.cardWidth};p("clickModel",e)},R=()=>{p("customize-to-home",{imageUrl:N.cardData.imageUrl,modelUrl:F.value,cardData:N.cardData})},C=(e,t)=>{m.getModelTaskStatus({result:e,resultTask:t},t=>{t?(O.value=t,b.value=!1,M.value=100,p("save-project",{...N.cardData,modelUrl:t,taskId:e,status:"success"})):p("delete")},e=>{p("delete")},e=>{void 0!==e&&(M.value=e)})};s(()=>{switch(N.cardData.status){case"loading":(async()=>{let e;if(b.value=!0,M.value=10,N.cardData.taskId)return e=N.cardData.taskId,void C(e,N.cardData.resultTask);m.createModelTask({project_id:N.cardData.project_id,image_url:N.cardData.imageUrl},(e,t)=>{e&&(p("save-project",{...N.cardData,resultTask:t,taskId:e}),C(e,t))},e=>{p("delete")},{})})();break;case"success":O.value=N.cardData.modelUrl,b.value=!1,M.value=100}});const E=()=>{g.value=!1},S=()=>{I.value=!0,I.value&&(A.value=!0)},D=()=>{I.value=!1,setTimeout(()=>{A.value=!1},3e3)},P=e=>{const t=e.target,s=t.naturalWidth,n=t.naturalHeight;s>0&&n>0&&(U.value=s/n)},L=e=>{},N=e,O=t(""),U=t(16/9),F=n(()=>O.value||N.cardData.modelUrl),j=n(()=>{const e=N.cardWidth;return{width:`${e}px`,height:`${F.value?16*e/9:e/U.value}px`,borderRadius:`${N.borderRadius}px`,border:N.showBorder?"1px solid #e0e0e0":"none"}});return(t,s)=>(o(),i("div",{class:d(["ip-card-container",{"controls-visible":A.value}]),onMouseleave:E,onTouchstart:S,onTouchend:D},[l("div",Ki,[l("div",{class:d(["ip-card",{loading:b.value,initializing:T.value}]),style:x(j.value)},[!F.value&&N.cardData.imageUrl?(o(),i("div",Wi,[l("img",{src:N.cardData.imageUrl,class:"preview-image",onLoad:P,onError:L},null,40,Yi),l("div",$i,[l("div",qi,[l("div",{class:"progress-fill",style:x({width:M.value+"%"})},null,4),l("div",Zi,u(h(r)("modelCard.progressText",{percentage:Math.round(M.value)})),1)])]),N.cardData.imageUrl?(o(),i("button",{key:0,class:"customize-to-home-btn",onClick:R,onTouchend:f(R,["prevent"])},u(h(r)("modelModal.customizeToHome")),33)):c("",!0)])):(o(),i("div",Ji,[s[1]||(s[1]=l("div",{style:{position:"absolute",width:"100%",height:"100%","z-index":"2"}},null,-1)),w(Gi,{ref_key:"threeModelViewer",ref:v,"model-url":F.value,"container-width":e.cardWidth,"show-border":!1,"border-radius":0,"background-color":e.backgroundColor,"enable-controls":!N.clickDisabled,"auto-rotate":y.value,"rotation-speed":.005,"camera-distance":2.5},null,8,["model-url","container-width","background-color","enable-controls","auto-rotate"]),F.value?(o(),i("button",{key:0,class:"customize-to-home-btn",onClick:R,onTouchend:f(R,["prevent"])},u(h(r)("modelModal.customizeToHome")),33)):c("",!0)]))],6),l("div",{class:"right-controls-container",onClick:s[0]||(s[0]=f(()=>{},["stop"]))},[F.value?(o(),i("div",Qi,[l("button",{class:"control-button rotate-btn",title:"detail",onClick:k,onTouchend:f(k,["prevent"])},[...s[2]||(s[2]=[l("span",{class:"btn-icon"},"ðŸ”",-1)])],32)])):c("",!0)])])],34))}},[["__scopeId","data-v-6ddeb7a0"]]),to={key:0,class:"model-modal-overlay"},so={class:"model-viewer-container"},no=D({__name:"index",props:{show:{type:Boolean,default:!1},modelData:{type:Object,default:null}},emits:["close"],setup(e,{emit:s}){const{t:n}=_(),r=e,u=s,d=t(!0);t(!1);const p=()=>{u("close")};return a(()=>r.show,e=>{document.body.style.overflow=e?"hidden":""}),A(()=>{document.body.style.overflow=""}),(t,s)=>e.show?(o(),i("div",to,[l("div",{class:"model-modal-container",onClick:s[0]||(s[0]=f(()=>{},["stop"]))},[l("button",{class:"close-button",onClick:p,"aria-label":"å…³é—­"},[w(h(B),{class:"close-icon"},{default:b(()=>[w(h(z))]),_:1})]),l("div",so,[w(Gi,{ref:"threeModelViewer","model-url":e.modelData?.modelUrl,"show-border":!1,"border-radius":0,"background-color":"#0b0d12","auto-rotate":d.value,cameraDistance:2,"rotation-speed":.001,"enable-controls":!0,"full-screen":!0,"use-starry-background":!0},null,8,["model-url","auto-rotate"])]),c("",!0)])])):c("",!0)}},[["__scopeId","data-v-88f8edcb"]]),ao={class:"iframe-container"},ro=["src"],io=D({__name:"index",props:{show:{type:Boolean,default:!1},url:{type:String,default:"https://xiaozhi.me/console/agents"}},emits:["close"],setup(e,{emit:t}){const s=e,r=t,u=n(()=>s.url||"https://xiaozhi.me/console/agents"),h=()=>{d()},d=()=>{r("close")};return a(()=>s.show,e=>{document.body.style.overflow=e?"hidden":""}),A(()=>{document.body.style.overflow=""}),(t,s)=>e.show?(o(),i("div",{key:0,class:"import-modal-overlay",onClick:h},[l("div",{class:"import-modal-container",onClick:s[0]||(s[0]=f(()=>{},["stop"]))},[l("button",{class:"close-button",onClick:d,title:"å…³é—­"},[...s[1]||(s[1]=[l("span",{class:"close-icon"},"Ã—",-1)])]),s[2]||(s[2]=l("div",{class:"import-header"},[l("h2",{class:"import-title"},"è§’è‰²å¯¼å…¥")],-1)),l("div",ao,[l("iframe",{class:"import-iframe",src:u.value,frameborder:"0",allowfullscreen:""},null,8,ro)])])])):c("",!0)}},[["__scopeId","data-v-8d5d36df"]]),oo={class:"header-component"},lo={class:"back-button-area"},co=["title"],uo={class:"project-name-section"},ho={key:0,class:"project-title-container"},po={class:"project-title"},mo=["title"],fo={key:1,class:"project-edit-container"},go=["title"],vo={class:"header-right-section"},yo={class:"model-count"},xo={class:"count-text"},wo=["title"],bo={class:"recharge-text"},To=["title"],_o=D({__name:"HeaderComponent",props:{total_score:{type:Number,default:0},projectName:{type:String,default:"project"}},emits:["openGuideModal","back"],setup(e,{expose:s,emit:n}){const a=n,c=t(null),d=e,p=k(),{t:m,locale:f}=_(),g=()=>{p.push("/points-recharge")},v=t(!1),y=t(""),x=t(null),T=()=>{a("back")},I=()=>{v.value=!0,y.value=d.projectName,r(()=>{x.value&&x.value.focus()})},A=()=>{const e=y.value.trim();e&&e!==d.projectName&&a("updateProjectInfo",{title:e}),v.value=!1};return s({RechargeRef:c}),(t,s)=>(o(),i("header",oo,[l("div",lo,[l("button",{class:"back-btn",onClick:T,title:h(m)("header.back")},[w(h(B),{class:"back-icon"},{default:b(()=>[w(h(Z))]),_:1})],8,co)]),l("div",uo,[v.value?(o(),i("div",fo,[w(h(Q),{modelValue:y.value,"onUpdate:modelValue":s[0]||(s[0]=e=>y.value=e),ref_key:"editInput",ref:x,class:"project-name-input",size:"default",maxlength:"50",placeholder:h(m)("header.projectNamePlaceholder"),onKeyup:M(A,["enter"])},null,8,["modelValue","placeholder"]),l("button",{class:"save-btn",onClick:A,title:h(m)("header.saveProjectName")},[w(h(B),{class:"save-icon"},{default:b(()=>[w(h(ee))]),_:1})],8,go)])):(o(),i("div",ho,[l("h1",po,u(e.projectName),1),l("button",{class:"edit-btn",onClick:I,title:h(m)("header.editProjectName")},[w(h(B),{class:"edit-icon"},{default:b(()=>[w(h(J))]),_:1})],8,mo)]))]),l("div",vo,[l("div",{ref_key:"RechargeRef",ref:c,class:"free-counts-display"},[l("div",yo,[w(h(B),{class:"count-icon"},{default:b(()=>[w(h(te))]),_:1}),l("span",xo,u(h(m)("header.remainingCredits"))+": "+u(e.total_score),1),l("button",{class:"recharge-btn",onClick:g,title:h(m)("header.recharge")},[l("span",bo,u(h(m)("header.recharge")),1)],8,wo)])],512),w(O,{position:"top-right"}),l("button",{class:"guide-btn",onClick:s[1]||(s[1]=e=>a("openGuideModal")),title:h(m)("header.guide")},[w(h(B),{class:"guide-icon"},{default:b(()=>[w(h(se))]),_:1})],8,To),w(U,{compact:!1,position:"top-right"})])]))}},[["__scopeId","data-v-787d8be3"]]),Mo=["title"],Io={class:"progress-indicator"},Ao={class:"guide-content"},ko={class:"guide-image-container"},Ro={class:"image-wrapper"},Co=["src","alt"],Eo={class:"guide-text-container"},So={class:"text-content"},Do={class:"guide-title"},Po=["innerHTML"],Lo={key:0,class:"guide-tips"},No={class:"tips-text"},Oo={class:"guide-actions"},Uo={class:"step-indicator"},Fo={class:"step-text"},jo=D({__name:"index",props:{show:{type:Boolean,default:!1}},emits:["close","complete"],setup(e,{emit:s}){const a=s,{t:r}=_(),p=t(0),m=n(()=>[{id:1,title:r("guideModal.step1.title"),description:r("guideModal.step1.description"),image:"https://draft-user.s3.us-east-2.amazonaws.com/images/f1cde4d7-bafd-41cb-8795-ad9ddcd521fb.png",tips:r("guideModal.step1.tips")},{id:2,title:r("guideModal.step2.title"),description:r("guideModal.step2.description"),image:"https://draft-user.s3.us-east-2.amazonaws.com/images/2ec4b422-3b42-4447-b049-6342184a5c50.png",tips:r("guideModal.step2.tips")}]);n(()=>m.value[p.value]||{});const g=n(()=>p.value===m.value.length-1),w=()=>{p.value>0&&p.value--},b=()=>{p.value<m.value.length-1?p.value++:M()},T=()=>{a("close")},M=()=>{a("complete"),T()},I=()=>{T()};return(t,s)=>e.show?(o(),i("div",{key:0,class:"guide-modal-overlay",onClick:s[1]||(s[1]=(...e)=>t.handleOverlayClick&&t.handleOverlayClick(...e))},[l("div",{class:"guide-modal-container",onClick:s[0]||(s[0]=f(()=>{},["stop"]))},[l("button",{class:"close-button",onClick:T,title:h(r)("header.skipGuide")},[...s[2]||(s[2]=[l("span",{class:"close-icon"},"Ã—",-1)])],8,Mo),l("div",Io,[(o(!0),i(v,null,y(m.value,(e,t)=>(o(),i("div",{key:t,class:d(["progress-dot",{active:t===p.value,completed:t<p.value}])},null,2))),128))]),l("div",Ao,[l("div",{class:"guide-content-wrapper",style:x({transform:`translateX(-${100*p.value}%)`})},[(o(!0),i(v,null,y(m.value,(e,t)=>(o(),i("div",{key:t,class:"guide-step"},[l("div",ko,[l("div",Ro,[l("img",{src:e.image,alt:e.title,class:"guide-image"},null,8,Co),s[3]||(s[3]=l("div",{class:"image-decoration"},null,-1))])]),l("div",Eo,[l("div",So,[l("h2",Do,u(e.title),1),l("p",{class:"guide-description",innerHTML:e.description},null,8,Po),e.tips?(o(),i("div",Lo,[s[4]||(s[4]=l("div",{class:"tips-icon"},"ðŸ’¡",-1)),l("div",No,u(e.tips),1)])):c("",!0)]),l("div",Oo,[p.value>0?(o(),i("button",{key:0,class:"action-button secondary",onClick:w},u(h(r)("header.previous")),1)):c("",!0),l("button",{class:"action-button skip",onClick:I},u(h(r)("header.skipGuide")),1),l("button",{class:"action-button primary",onClick:b},u(g.value?h(r)("header.startCreating"):h(r)("header.next")),1)])])]))),128))],4)]),l("div",Uo,[l("span",Fo,u(h(r)("header.step"))+" "+u(p.value+1)+" / "+u(m.value.length),1)])])])):c("",!0)}},[["__scopeId","data-v-e98caf3a"]]),zo={class:"toolbar"},Bo={class:"toolbar-left"},Ho={class:"image-info"},Vo=["disabled"],Xo=["disabled"],Go=["src"],Ko={class:"zoom-controls"},Wo=["disabled"],Yo={class:"zoom-level"},$o=["disabled"],qo=.1,Zo={__name:"index",props:{visible:{type:Boolean,default:!1},images:{type:Array,default:()=>[]},initialIndex:{type:Number,default:0}},emits:["close"],setup(e,{emit:h}){const d=e,p=h,m=t(0),g=t(1),v=t(0),y=t({x:0,y:0}),w=t(!1),T=t({x:0,y:0}),_=t(!1),M=t(null),A=t(null),k=t(null),E=n(()=>d.images[m.value]||""),S=n(()=>0===m.value),D=n(()=>m.value===d.images.length-1),P=n(()=>({transform:`scale(${g.value}) rotate(${v.value}deg)`,transition:w.value?"none":"transform 0.3s ease",maxWidth:"none",maxHeight:"none"}));a(()=>d.visible,e=>{e?(m.value=d.initialIndex,L(),document.body.style.overflow="hidden",r(()=>{N()})):document.body.style.overflow=""}),a(m,()=>{L(),_.value=!1});const L=()=>{g.value=1,v.value=0,y.value={x:0,y:0}},N=()=>{k.value&&M.value&&r(()=>{const e=k.value.naturalWidth,t=k.value.naturalHeight,s=M.value.clientWidth,n=M.value.clientHeight,a=e/t,r=s/n;g.value=a>r?s/e*.9:n/t*.9,g.value=Math.min(g.value,1)})},O=()=>{_.value=!0,1===g.value&&N()},U=()=>{},F=()=>{p("close")},j=()=>{S.value||m.value--},z=()=>{D.value||m.value++},B=()=>{v.value=(v.value+90)%360},H=()=>{g.value<5&&(g.value=Math.min(g.value+.2,5))},V=()=>{g.value>qo&&(g.value=Math.max(g.value-.2,qo))},X=()=>{L(),N()},G=e=>{e.preventDefault();const t=e.deltaY>0?-.1:.1,s=Math.min(Math.max(g.value+t,qo),5);if(s!==g.value){const t=A.value.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top,r=s/g.value;y.value.x=n-(n-y.value.x)*r,y.value.y=a-(a-y.value.y)*r,g.value=s}},K=e=>{0===e.button&&(w.value=!0,T.value={x:e.clientX-y.value.x,y:e.clientY-y.value.y})},W=e=>{w.value&&(y.value={x:e.clientX-T.value.x,y:e.clientY-T.value.y})},Y=()=>{w.value=!1},$=t(0),q=t(1),Z=t(0),J=e=>{if(1===e.touches.length)w.value=!0,T.value={x:e.touches[0].clientX-y.value.x,y:e.touches[0].clientY-y.value.y},Z.value=Date.now();else if(2===e.touches.length){w.value=!1;const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY;$.value=Math.sqrt(t*t+s*s),q.value=g.value}},Q=e=>{if(e.preventDefault(),1===e.touches.length&&w.value)y.value={x:e.touches[0].clientX-T.value.x,y:e.touches[0].clientY-T.value.y};else if(2===e.touches.length){const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY,n=Math.sqrt(t*t+s*s);if($.value>0){const t=Math.min(Math.max(q.value*(n/$.value),qo),5);if(t!==g.value){const s=(e.touches[0].clientX+e.touches[1].clientX)/2,n=(e.touches[0].clientY+e.touches[1].clientY)/2,a=A.value.getBoundingClientRect(),r=s-a.left,i=n-a.top,o=t/g.value;y.value.x=r-(r-y.value.x)*o,y.value.y=i-(i-y.value.y)*o,g.value=t}}}},ee=e=>{if(0===e.touches.length){w.value=!1;Date.now()-Z.value<300&&(1===g.value?N():X())}},te=e=>{if(d.visible)switch(e.key){case"Escape":F();break;case"ArrowLeft":j();break;case"ArrowRight":z();break;case"+":case"=":H();break;case"-":case"_":V()}};return s(()=>{document.addEventListener("keydown",te)}),R(()=>{document.removeEventListener("keydown",te),document.body.style.overflow=""}),(t,s)=>(o(),I(C,{name:"fade"},{default:b(()=>[e.visible?(o(),i("div",{key:0,class:"image-preview-modal",onClick:f(F,["self"])},[l("div",zo,[l("div",Bo,[l("div",Ho,u(m.value+1)+" / "+u(e.images.length),1)]),l("div",{class:"toolbar-right"},[l("button",{class:"tool-btn",onClick:B,title:"æ—‹è½¬"},[...s[0]||(s[0]=[l("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z",fill:"currentColor"})],-1)])]),l("button",{class:"tool-btn close-btn",onClick:F,title:"å…³é—­"},[...s[1]||(s[1]=[l("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",fill:"currentColor"})],-1)])])])]),l("div",{class:"preview-container",ref_key:"containerRef",ref:M},[e.images.length>1?(o(),i("button",{key:0,class:"nav-btn prev-btn",onClick:j,disabled:S.value},[...s[2]||(s[2]=[l("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z",fill:"currentColor"})],-1)])],8,Vo)):c("",!0),e.images.length>1?(o(),i("button",{key:1,class:"nav-btn next-btn",onClick:z,disabled:D.value},[...s[3]||(s[3]=[l("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z",fill:"currentColor"})],-1)])],8,Xo)):c("",!0),l("div",{class:"image-wrapper",ref_key:"imageWrapperRef",ref:A,onMousedown:K,onMousemove:W,onMouseup:Y,onMouseleave:Y,onWheel:G,onTouchstart:J,onTouchmove:Q,onTouchend:ee,style:x({cursor:w.value?"grabbing":"grab"})},[l("img",{ref_key:"imageRef",ref:k,src:E.value,style:x(P.value),onLoad:O,onError:U,draggable:"false",alt:"é¢„è§ˆå›¾ç‰‡"},null,44,Go)],36)],512),l("div",Ko,[l("button",{class:"zoom-btn",onClick:V,disabled:g.value<=qo},[...s[4]||(s[4]=[l("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M19 13H5v-2h14v2z",fill:"currentColor"})],-1)])],8,Wo),l("div",Yo,u(Math.round(100*g.value))+"%",1),l("button",{class:"zoom-btn",onClick:H,disabled:g.value>=5},[...s[5]||(s[5]=[l("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",fill:"currentColor"})],-1)])],8,$o),l("button",{class:"zoom-btn",onClick:X},"Reset")])])):c("",!0)]),_:1}))}},Jo=D(Zo,[["__scopeId","data-v-43ada306"]]),Qo={class:"tour-container"},el={class:"tour-card"},tl={class:"icon-wrapper"},sl={class:"star-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},nl={class:"title"},al={class:"description"},rl={class:"feature-list"},il={class:"feature-item"},ol={class:"action-section"},ll={class:"action-text"},cl={class:"action-highlight"},ul=D({__name:"tour1",setup(e){const{t:n}=_(),a=t(!1);return s(()=>{setTimeout(()=>{a.value=!0},100)}),(e,t)=>(o(),i("div",Qo,[l("div",el,[l("div",tl,[(o(),i("svg",sl,[w(h(te))]))]),l("h3",nl,u(e.$t("tour1.title")),1),l("p",al,u(e.$t("tour1.description")),1),l("ul",rl,[l("li",il,[t[0]||(t[0]=l("span",{class:"feature-icon"},"âœ¨",-1)),l("span",null,u(e.$t("tour1.featureText")),1)])]),l("div",ol,[l("p",ll,u(e.$t("tour1.actionText")),1),l("p",cl,u(e.$t("tour1.actionHighlight")),1)])])]))}},[["__scopeId","data-v-03a7748c"]]),hl={class:"tour-container"},dl={class:"tour-card"},pl={class:"title"},ml={class:"description"},fl={class:"ip-types-container"},gl={class:"ip-type-item"},vl={class:"type-info"},yl={class:"type-title"},xl={class:"type-desc"},wl={class:"ip-type-item"},bl={class:"type-info"},Tl={class:"type-title"},_l={class:"type-desc"},Ml={class:"action-section"},Il={class:"action-text"},Al={class:"action-highlight"},kl=D({__name:"tour2",setup(e){const{t:t}=_();return(e,t)=>(o(),i("div",hl,[l("div",dl,[t[2]||(t[2]=l("div",{class:"icon-wrapper"},[l("svg",{class:"star-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),l("h3",pl,u(e.$t("tour2.title")),1),l("p",ml,u(e.$t("tour2.description")),1),l("div",fl,[l("div",gl,[t[0]||(t[0]=l("div",{class:"type-icon character"},[l("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("circle",{cx:"12",cy:"8",r:"4",stroke:"currentColor","stroke-width":"2"}),l("path",{d:"M4 20C4 16 7 14 12 14C17 14 20 16 20 20",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})])],-1)),l("div",vl,[l("h4",yl,u(e.$t("iPandCardLeft.character")),1),l("p",xl,u(e.$t("tour2.characterDesc")),1)])]),l("div",wl,[t[1]||(t[1]=g('<div class="type-icon animal" data-v-b08810de><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-b08810de><path d="M12 2C8 2 6 4 6 7V9H4V11H6V13H4V15H6V17C6 20 8 22 12 22C16 22 18 20 18 17V15H20V13H18V11H20V9H18V7C18 4 16 2 12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-b08810de></path><circle cx="9" cy="9" r="1.5" fill="currentColor" data-v-b08810de></circle><circle cx="15" cy="9" r="1.5" fill="currentColor" data-v-b08810de></circle></svg></div>',1)),l("div",bl,[l("h4",Tl,u(e.$t("iPandCardLeft.animal")),1),l("p",_l,u(e.$t("tour2.animalDesc")),1)])])]),l("div",Ml,[l("p",Il,u(e.$t("tour2.actionText")),1),l("p",Al,u(e.$t("tour2.actionHighlight")),1)])])]))}},[["__scopeId","data-v-b08810de"]]),Rl={class:"tour-container"},Cl={class:"tour-card"},El={class:"title"},Sl={class:"description"},Dl={class:"features-container"},Pl={class:"feature-item"},Ll={class:"feature-content"},Nl={class:"feature-title"},Ol={class:"action-section"},Ul={class:"action-text"},Fl={class:"action-highlight"},jl=D({__name:"tour3",setup(e){const{t:t}=_();return(e,t)=>(o(),i("div",Rl,[l("div",Cl,[t[1]||(t[1]=l("div",{class:"icon-wrapper"},[l("svg",{class:"star-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M11 4H4C2.89543 4 2 4.89543 2 6V18C2 19.1046 2.89543 20 4 20H16C17.1046 20 18 19.1046 18 18V13",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),l("path",{d:"M18 4L22 8M18 4V8M18 4H14M10 14L22 2",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),l("h3",El,u(e.$t("tour3.title")),1),l("p",Sl,u(e.$t("tour3.description")),1),l("div",Dl,[l("div",Pl,[t[0]||(t[0]=l("div",{class:"feature-icon-wrapper"},[l("span",{class:"feature-icon"},"ðŸ‘¤")],-1)),l("div",Ll,[l("h4",Nl,u(e.$t("tour3.feature1")),1)])])]),l("div",Ol,[l("p",Ul,u(e.$t("tour3.actionText")),1),l("p",Fl,u(e.$t("tour3.actionHighlight")),1)])])]))}},[["__scopeId","data-v-e36359fd"]]),zl={class:"tour-container"},Bl={class:"tour-card"},Hl={class:"title"},Vl={class:"description"},Xl={class:"features-container"},Gl={class:"feature-item"},Kl={class:"feature-content"},Wl={class:"feature-title"},Yl={class:"feature-item"},$l={class:"feature-content"},ql={class:"feature-title"},Zl={class:"action-section"},Jl={class:"action-text"},Ql={class:"action-highlight"},ec=D({__name:"tour4",setup(e){const{t:t}=_();return(e,t)=>(o(),i("div",zl,[l("div",Bl,[t[2]||(t[2]=g('<div class="icon-wrapper" data-v-b06925ea><svg class="star-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-b06925ea><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-b06925ea></rect><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" data-v-b06925ea></circle><path d="M21 15L16 10L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-b06925ea></path></svg></div>',1)),l("h3",Hl,u(e.$t("tour4.title")),1),l("p",Vl,u(e.$t("tour4.description")),1),l("div",Xl,[l("div",Gl,[t[0]||(t[0]=l("div",{class:"feature-icon-wrapper"},[l("span",{class:"feature-icon"},"ðŸ“")],-1)),l("div",Kl,[l("h4",Wl,u(e.$t("tour4.feature1")),1)])]),l("div",Yl,[t[1]||(t[1]=l("div",{class:"feature-icon-wrapper"},[l("span",{class:"feature-icon"},"ðŸŽ¨")],-1)),l("div",$l,[l("h4",ql,u(e.$t("tour4.feature3")),1)])])]),l("div",Zl,[l("p",Jl,u(e.$t("tour4.actionText")),1),l("p",Ql,u(e.$t("tour4.actionHighlight")),1)])])]))}},[["__scopeId","data-v-b06925ea"]]),tc={class:"tour-container"},sc={class:"tour-card"},nc={class:"title"},ac={class:"description"},rc={class:"features-container"},ic={class:"feature-item"},oc={class:"feature-content"},lc={class:"feature-title"},cc={class:"feature-item"},uc={class:"feature-content"},hc={class:"feature-title"},dc={class:"action-section"},pc={class:"action-text"},mc={class:"action-highlight"},fc=D({__name:"tour5",setup(e){const{t:t}=_();return(e,t)=>(o(),i("div",tc,[l("div",sc,[t[2]||(t[2]=l("div",{class:"icon-wrapper"},[l("svg",{class:"star-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),l("h3",nc,u(e.$t("tour5.title")),1),l("p",ac,u(e.$t("tour5.description")),1),l("div",rc,[l("div",ic,[t[0]||(t[0]=l("div",{class:"feature-icon-wrapper"},[l("span",{class:"feature-icon"},"âš¡")],-1)),l("div",oc,[l("h4",lc,u(e.$t("tour5.feature1")),1)])]),l("div",cc,[t[1]||(t[1]=l("div",{class:"feature-icon-wrapper"},[l("span",{class:"feature-icon"},"ðŸ”§")],-1)),l("div",uc,[l("h4",hc,u(e.$t("tour5.feature2")),1)])])]),l("div",dc,[l("p",pc,u(e.$t("tour5.actionText")),1),l("p",mc,u(e.$t("tour5.actionHighlight")),1)])])]))}},[["__scopeId","data-v-a0729484"]]),gc={class:"header-wrapper"},vc={class:"sidebar-container"},yc=["onMousedown","onTouchstart","onMouseleave","onMouseenter"],xc={__name:"CreateProject",setup(e){const{locale:r}=_(),u=t(null),d=t(null),p=t({tour1:""}),m=new N,g=new qt,T=k(),M=new $t,A=t(!1),C=t(null),D=t(!1),P=t("https://xiaozhi.me/console/agents"),O=t(!1),U=t(!1),F=t(""),j=t(!1),z=t(!1),B=t([]),H=t(0),V=t(!1),X=t(null),G=t({}),K=t(null),W=t(null),Y=t({}),$=t(0),q=async()=>{const{data:e}=await g.getModelLimits();$.value=e.total_score},Z=async e=>{X.value=e,V.value=!0},J=async()=>{V.value=!1;const e=X.value;X.value=null;try{const t=await m.fetchImage(e),s=document.createElement("a");s.href=t,s.download=`image-${Date.now()}.jpg`,s.click(),URL.revokeObjectURL(t)}catch(t){}},Q=(e,t)=>{m.uploadFile(e).then(e=>{const s=be({diyPromptImg:e,diyPromptText:t,status:"loading",type:"image",addDiyPromptImg:!0});ee.value.push(s)})},ee=t([]),te=t(0),se=e=>1==e&&0!=te.value?te.value:0!=te.value?(te.value++,te.value):(te.value=ee.value.reduce((e,t)=>Math.max(e,t.zIndex||0),0)+1,te.value),re=()=>{T.replace("/creation-workspace")},ie=t(!0),oe=e=>{ie.value=e,ce({isHook:e})},le=t({}),ce=async(e={})=>{try{const t=await M.getCombinedPrompt(W.value,e);le.value=t}catch(t){}};a(()=>[Y.value,ee.value],()=>{let e={...Y.value};e.details.node_card=ee.value,pe(e)},{deep:!0});const ue=e=>{if("string"==typeof e)B.value=[e];else{if(!Array.isArray(e))return;B.value=e}H.value=0,z.value=!0},he=(e,t,s="image")=>{let n=ee.value[e];switch(s){case"image":n.imageUrl=t.imageUrl,n.taskId=t.taskId,n.taskQueue=t.taskQueue;break;case"model":n.modelUrl=t.modelUrl,n.taskId=t.taskId,n.resultTask=t.resultTask}n.status=t.status,q()},de=async e=>{const t=await M.getProject(e);Y.value={...t},M.addProjectDuration(t.duration_seconds),ee.value=[...Y.value.details.node_card].map(e=>({...e,id:e.id||Date.now()+Math.random().toString(36).substr(2,9)})),Y.value.tags=[W.value],pe(Y.value)},pe=async e=>{e.duration_seconds=M.duration_seconds,M.updateProject(K.value,e)},me=e=>{Ae.value||(C.value=e,A.value=!0)},fe=()=>{D.value=!0},ge=()=>{D.value=!1},ve=()=>{O.value=!1;const e=(new Date).toDateString();localStorage.setItem("lastShowGuideModalDate",e)},ye=()=>{O.value=!1;const e=(new Date).toDateString();localStorage.setItem("lastShowGuideModalDate",e)};const xe=new class{constructor(){this.ANIMATION_DURATION=400,this.OFFSET_MARGIN=30,this.SCREEN_PADDING=50}calculateRightSidePosition(e,t){if(!e)return{x:-100,y:-100};const s=this.parseOffset(e.offsetX),n=this.parseOffset(e.offsetY),a=this.parseCardWidth(e.cardWidth),r=s+a+this.OFFSET_MARGIN+this.SCREEN_PADDING,i=window.innerWidth-a-this.SCREEN_PADDING;return{x:(r>i?this.SCREEN_PADDING:r)-90,y:r>i?n+a+this.OFFSET_MARGIN:n}}parseOffset(e){if("number"==typeof e)return e;if("string"==typeof e){const t=parseFloat(e.replace("px",""));return isNaN(t)?0:t}return 0}parseCardWidth(e){if("number"==typeof e)return e;if("string"==typeof e){const t=parseFloat(e.replace("px",""));return isNaN(t)?250:t}return 250}getAnimationConfig(){return{transition:`transform ${this.ANIMATION_DURATION}ms cubic-bezier(0.25, 0.46, 0.45, 0.94)`,willChange:"transform"}}},we=e=>{ee.value.splice(e,1)},be=(e,t=null)=>{const s=Date.now()+Math.random().toString(36).substr(2,9);let n=ee.value.reduce((e,t)=>e.zIndex>t.zIndex?e:t,{});const a=n?xe.calculateRightSidePosition(n,Oe.value):{x:-100,y:-100};return{...e,id:s,offsetX:`${a.x}px`,offsetY:`${a.y}px`,project_id:K.value,zIndex:se()}},Te=e=>{const t=be({cardWidth:"250",type:"model",modelUrl:null,refineModel:!0,refineModelTaskId:e});ee.value.push(t)},_e=async e=>{const{count:t,profile:s,inspirationImage:n,ipType:a,ipTypeImg:r}=e;for(let i=0;i<t;i++){const e=be({imageUrl:null,prompt:s.appearance,inspirationImage:n,ipType:a,ipTypeImg:r,status:"loading",type:"image"});ee.value.push(e),await new Promise(e=>setTimeout(e,200))}},Me=e=>{const t=be({imageUrl:e.imageUrl||"",prompt:e.prompt||"",inspirationImage:e.inspirationImage||"",status:"success",type:"image"});ee.value.push(t)},Ie=e=>{const t=be({imageUrl:e.imageUrl,altText:`ç”Ÿæˆçš„3Dæ¨¡åž‹ - ${e.prompt||"æœªçŸ¥æç¤ºè¯"}`,cardWidth:"250",prompt:e.prompt||"",style:e.style||"",profile:e.profile||"",timestamp:e.timestamp||Date.now(),type:"model",modelUrl:e.modelUrl,taskId:e.taskId,status:e.status});ee.value.push(t)},Ae=t(!1),ke=t(!1),Re=t(!1),Ce=t(null),Ee=t(0),Se=t(0),De=t(0),Pe=t(0),Le=t(0),Ne=t(0),Oe=t(1),Ue=t(new Map),Fe=t(0),je=t(0),ze=t(0),Be=t(1),He=t(0),Ve=t(0),Xe=t(0),Ge=t(0),Ke=t(0),We=t(0),Ye=t(0),$e=t(null),qe=n(()=>({transform:`translate(${Le.value}px, ${Ne.value}px) scale(${Oe.value})`,transformOrigin:"center center",transition:"none"})),Ze=e=>{const t=ee.value[e],s=t.offsetX||"0px",n=t.offsetY||"0px";return!Ue.value.has(e)&&t.zIndex&&Ue.value.set(e,t.zIndex),{transform:`translate(${s}, ${n})`,cursor:Ae.value&&Ce.value===e?"grabbing":"grab",transition:Ae.value&&Ce.value===e?"none":"transform 0.2s ease",zIndex:t.zIndex||"auto"}},Je=t(!1),Qe=t({}),et=t(!1),tt=e=>{const t=ee.value[e];Qe.value=t,Je.value=!0},st=()=>{Je.value=!1,et.value=!0},nt=n(()=>ke.value?"grabbing":"grab"),at=n(()=>window.innerWidth<=768),rt=(e,t)=>{if(e.stopPropagation(),at.value||e.preventDefault(),e.target.closest(".control-button"))return;Ae.value=!0,ke.value=!1,Ce.value=t,ee.value[t].zIndex=se(1);const s=e.touches?e.touches[0].clientX:e.clientX,n=e.touches?e.touches[0].clientY:e.clientY,a=parseFloat(ee.value[t].offsetX)||0,r=parseFloat(ee.value[t].offsetY)||0;Ee.value=s-a*Oe.value,Se.value=n-r*Oe.value,ee.value[t].offsetX=`${a}px`,ee.value[t].offsetY=`${r}px`},it=e=>{if(Ae.value&&null!==Ce.value){at.value||e.preventDefault();const t=e.touches?e.touches[0].clientX:e.clientX,s=e.touches?e.touches[0].clientY:e.clientY,n=performance.now();if(Ye.value>0){const e=n-Ye.value;e>0&&(Xe.value=(t-Ke.value)/e*16.67,Ge.value=(s-We.value)/e*16.67)}Ke.value=t,We.value=s,Ye.value=n;const a=(t-Ee.value)/Oe.value,r=(s-Se.value)/Oe.value;ee.value[Ce.value].offsetX=`${a}px`,ee.value[Ce.value].offsetY=`${r}px`}},ot=()=>{Ae.value&&null!==Ce.value&&lt(),Ae.value=!1,Ce.value=null,Ye.value=0},lt=()=>{if(Math.abs(Xe.value)<.1&&Math.abs(Ge.value)<.1)return Xe.value=0,void(Ge.value=0);const e=Ce.value;if(null===e)return;Xe.value*=.95,Ge.value*=.95;const t=parseFloat(ee.value[e].offsetX)||0,s=parseFloat(ee.value[e].offsetY)||0;ee.value[e].offsetX=`${t+Xe.value/Oe.value}px`,ee.value[e].offsetY=`${s+Ge.value/Oe.value}px`,$e.value=requestAnimationFrame(lt)},ct=e=>{if(!Ae.value&&e.target.closest(".main-content")&&!e.target.closest(".floating-sidebar"))if(e.touches&&2===e.touches.length){at.value||e.preventDefault(),Re.value=!0,ke.value=!1;const t=e.touches[0],s=e.touches[1],n=Math.hypot(s.clientX-t.clientX,s.clientY-t.clientY);Fe.value=n;const a=(t.clientX+s.clientX)/2,r=(t.clientY+s.clientY)/2;je.value=a,ze.value=r,Be.value=Oe.value,He.value=Le.value,Ve.value=Ne.value}else{at.value||e.preventDefault(),ke.value=!0,Re.value=!1;const t=e.touches?e.touches[0].clientX:e.clientX,s=e.touches?e.touches[0].clientY:e.clientY;De.value=t-Le.value,Pe.value=s-Ne.value}},ut=e=>{if(Re.value){if(e.touches&&2===e.touches.length){at.value||e.preventDefault();const t=e.touches[0],s=e.touches[1],n=((e,t)=>Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY))(t,s),a=n/Fe.value,r=Math.min(Math.max(Be.value*a,.1),5);if(r!==Oe.value){const n=(t.clientX+s.clientX)/2,a=(t.clientY+s.clientY)/2,i=e.currentTarget.getBoundingClientRect(),o=n-i.left-600,l=a-i.top-400,c=o-He.value,u=l-Ve.value,h=c*(r/Be.value),d=u*(r/Be.value);Le.value=o-h,Ne.value=l-d,Oe.value=r}}}else if(ke.value){at.value||e.preventDefault();const t=e.touches?e.touches[0].clientX:e.clientX,s=e.touches?e.touches[0].clientY:e.clientY;Le.value=t-De.value,Ne.value=s-Pe.value}else Ae.value&&it(e)},ht=()=>{ke.value=!1,Re.value=!1,Ae.value=!1,Ce.value=null},dt=e=>{if(e.preventDefault(),e.ctrlKey||e.metaKey){const t=e.deltaY>0?.9:1.1,s=Oe.value*t;if(s>=.1&&s<=5){const n=e.currentTarget.getBoundingClientRect(),a=e.clientX-n.left-900,r=e.clientY-n.top-400,i=(a-Le.value)*t,o=(r-Ne.value)*t;Le.value=a-i,Ne.value=r-o,Oe.value=s}}else{const t=.5*e.deltaY,s=.5*e.deltaX;Ne.value+=-t,Le.value+=-s}},pt=e=>{(e.ctrlKey||e.metaKey)&&e.target.closest(".floating-sidebar")&&(at.value||e.preventDefault())},mt=e=>{e.touches&&e.touches.length>1&&e.target.closest(".floating-sidebar")&&(at.value||e.preventDefault())},ft=()=>{const e=S();if(K.value=e.params.id,W.value=e.params.series,"D1"!=W.value&&"E1"!=W.value&&"A1"!=W.value)return W.value="D1",void T.replace(`/project/${K.value}/${W.value}`);"new"!==K.value?(de(K.value),q()):(async()=>{const{id:e}=await M.createProject();await T.replace(`/project/${e}/${W.value}`),K.value=e,de(e)})()};return s(()=>{Xt.pollingEnabled=!0,L.pollingEnabled=!0,ft(),ce(),setTimeout(()=>{window.localStorage.getItem("tourFlag")||(p.value.tour1=u?.value?.RechargeRef,p.value.tour2=d?.value?.ipTypeSectionRef,p.value.tour3=d?.value?.textPromptSectionRef,p.value.tour4=d?.value?.referenceImageSectionRef,p.value.tour5=d?.value?.generateButtonRef,j.value=!0,window.localStorage.setItem("tourFlag","1"))},200);const e=Gt(document,"wheel",pt,{passive:!1}),t=Gt(document,"touchstart",mt,{passive:!1}),s=Gt(document,"touchmove",mt,{passive:!1});G.value={wheel:e,touchstart:t,touchmove:s}}),R(()=>{Xt.pollingEnabled=!1,L.pollingEnabled=!1,clearInterval($t.timer),G.value&&Object.values(G.value).forEach(e=>{"function"==typeof e&&e()})}),(e,t)=>{const s=E("DtCanvasEditor");return o(),i("div",{class:"creative-zone",onContextmenu:t[10]||(t[10]=f(()=>{},["prevent"]))},[l("div",gc,[w(_o,{ref_key:"headerRef",ref:u,onBack:re,total_score:$.value,projectName:Y.value.title,onUpdateProjectInfo:t[0]||(t[0]=e=>Y.value={...Y.value,...e}),onOpenGuideModal:t[1]||(t[1]=e=>O.value=!0)},null,8,["total_score","projectName"])]),l("div",vc,[w(Ys,{locale:h(r),series:W.value,ref_key:"iPandCardLeftRef",ref:d,Info:Y.value.details,onGenerateRequested:_e,onModelGenerated:Ie,onImportCharacter:fe,onHookSelected:oe},null,8,["locale","series","Info"])]),l("main",{class:"main-content scene-container",style:x({cursor:nt.value}),onMousedown:ct,onMousemove:ut,onMouseup:ht,onMouseleave:ht,onTouchstart:ct,onTouchmove:ut,onTouchend:ht,onWheel:dt,onSelectstart:t[2]||(t[2]=f(()=>{},["prevent"]))},[l("div",{class:"scene-content",style:x(qe.value)},[(o(!0),i(v,null,y(ee.value,(e,t)=>(o(),i("div",{key:e.id,class:"draggable-element",style:x(Ze(t)),onMousedown:e=>rt(e,t),onTouchstart:e=>rt(e,t),onMousemove:it,onTouchmove:it,onMouseup:ot,onMouseleave:e=>{},onTouchend:ot,onMouseenter:e=>(e=>{ee.value[e].zIndex=se()})(t)},["image"===e.type&&le.value.animal?(o(),I(dn,{key:0,onDelete:e=>we(t),onDeleteCard:e=>we(t),combinedPromptJson:le.value,series:W.value,onHandlePartialEdit:e=>(e=>{F.value=e,U.value=!0})(e),onCustomizeToHome:e=>tt(t),onPreviewImage:ue,onGenerateSmoothWhiteModel:e=>((e,t)=>{const s=be({imageUrl:t,type:"image",generateSmoothWhiteModelStatus:!0},e);ee.value.push(s)})(t,e),onCreateNewCard:e=>((e,t)=>{const{baseImage:s}=t,n=be({imageUrl:s,style:"realistic",type:"image",inspirationImage:null,module:null,sketch:null,isGenerating:!0,generateFourView:!0},e);ee.value.push(n)})(t,e),onDownloadImage:Z,projectId:K.value,onCreatePromptCard:e=>((e,t)=>{const{img:s,diyPromptText:n,imgyt:a,cardData:r}=t,i=be({diyPromptImg:s,diyPromptText:n,status:"loading",imgyt:a||"",type:"image"},e);ee.value.push(i)})(t,e),onGenerateModelRequested:e=>((e,t)=>{const{imageUrl:s}=t,n=be({imageUrl:s,cardWidth:"250",type:"model",modelUrl:null,generateFourView:t.generateFourView||!1,status:"loading",taskId:"",project_id:K.value},e);ee.value.push(n)})(t,e),onSaveProject:e=>{he(t,e,"image")},onCreateRemainingImageData:Me,cardData:e},null,8,["onDelete","onDeleteCard","combinedPromptJson","series","onHandlePartialEdit","onCustomizeToHome","onGenerateSmoothWhiteModel","onCreateNewCard","projectId","onCreatePromptCard","onGenerateModelRequested","onSaveProject","cardData"])):"model"===e.type?(o(),I(eo,{key:1,cardData:e,clickDisabled:Ae.value,onCustomizeToHome:e=>tt(t),onDelete:e=>we(t),projectId:K.value,onSaveProject:e=>{he(t,e,"model")},onClickModel:me,onRefineModel:Te},null,8,["cardData","clickDisabled","onCustomizeToHome","onDelete","projectId","onSaveProject"])):c("",!0)],44,yc))),128))],4)],36),w(no,{show:A.value,modelData:C.value,onClose:t[3]||(t[3]=e=>(A.value=!1,void(C.value=null)))},null,8,["show","modelData"]),w(io,{show:D.value,url:P.value,onClose:ge},null,8,["show","url"]),w(jo,{show:O.value,onClose:ve,onComplete:ye},null,8,["show"]),w(Jo,{visible:z.value,images:B.value,initialIndex:H.value,onClose:t[4]||(t[4]=e=>z.value=!1)},null,8,["visible","images","initialIndex"]),w(Kt,{show:V.value,onConfirm:J,onCancel:t[5]||(t[5]=e=>V.value=!1)},null,8,["show"]),w(s,{language:h(r),visible:U.value,"onUpdate:visible":t[6]||(t[6]=e=>U.value=e),"image-url":F.value,onAddPromptCard:Q},null,8,["language","visible","image-url"]),w(Wt,{series:W.value,show:Je.value,modelData:Qe.value,onClose:t[7]||(t[7]=e=>Je.value=!1),onAcknowledge:st},null,8,["series","show","modelData"]),et.value?(o(),I(Yt,{key:0,series:W.value,show:et.value,modelData:Qe.value,onClose:t[8]||(t[8]=e=>et.value=!1)},null,8,["series","show","modelData"])):c("",!0),w(h(ae),{modelValue:j.value,"onUpdate:modelValue":t[9]||(t[9]=e=>j.value=e)},{default:b(()=>[w(h(ne),{target:p.value?.tour1},{default:b(()=>[w(ul)]),_:1},8,["target"]),w(h(ne),{placement:"right-end",target:p.value?.tour2},{default:b(()=>[w(kl)]),_:1},8,["target"]),w(h(ne),{placement:"right-end",target:p.value?.tour3},{default:b(()=>[w(jl)]),_:1},8,["target"]),w(h(ne),{placement:"right-end",target:p.value?.tour4,title:"å‚è€ƒå›¾"},{default:b(()=>[w(ec)]),_:1},8,["target"]),w(h(ne),{placement:"right-end",target:p.value?.tour5,title:"åˆ›ä½œæŒ‰é’®"},{default:b(()=>[w(fc)]),_:1},8,["target"])]),_:1},8,["modelValue"])],32)}}},wc=D(xc,[["__scopeId","data-v-848af5a2"]]);export{wc as default};
